(()=>{var t={7644:(t,e,n)=>{const a=n(2127).Router();n(366),n(2470),n(4026);var r=n(3076);const{handleError:s,ErrorHandler:i}=n(8005),{toTimeZone:d,currentTimeInTimeZone:o}=n(8372),{addPaymentMaster:c,getLedgerByCustomers:u,getSaleInvoiceByCustomers:l,getPaymentsByCustomers:_,getPaymentsOverviewByCustomers:m,addPaymentLedgerRecord:p,updatePymtSequenceGenerator:y,getPymtSequenceNo:f,getPaymentsByCenter:g,getSaleInvoiceByCenter:v,getPymtTransactionsByCenter:h,updateCustomerCredit:w,updateCustomerCreditMinus:$,getPymtTransactionByCustomers:b,bankList:T,paymentBankRef:S,lastPaymentRecord:Y,lastVendorPaymentRecord:E,getPaymentsOverviewByCenter:k}=n(5931);function x(t,e,n,a){let s=`INSERT INTO payment_detail(pymt_ref_id, sale_ref_id, applied_amount) VALUES\n\t\t( '${e}', '${n}', '${a}' )`;new Promise((function(i,d){r.query(s,(function(r,s){r?d(r):(p(t,e,a,n,((t,e)=>{t&&t.message})),i(s))}))}))}function A(t,e,n){n.forEach((n=>{let a=`INSERT INTO payment_detail(pymt_ref_id, sale_ref_id, applied_amount) VALUES\n\t\t( '${e}', '${n.id}', '${n.applied_amount}' )`;new Promise((function(s,i){r.query(a,(function(a,r){a?i(a):(p(t,e,n.applied_amount,n.id,((t,e)=>{t&&t.message})),s(r))}))}))}))}a.post("/add-payment-received",(async(t,e)=>{new Date,o("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");const n={...t.body},[a,r,s]=Object.values(t.body);let i=0;for(const t of s){await y(r);let a=await f(n);if(x(n,await c(n,a,t,e),t.sale_ref_id,t.receivedamount),i==s.length-1)return e.status(200).json("success");i++}})),a.get("/get-ledger-customer/:centerid/:customerid",((t,e)=>{u(t.params.centerid,t.params.customerid,((n,a)=>n?s(new i("500",`/get-ledger-customer/:centerid/:customerid ${t.params.centerid} ${t.params.customerid}`,n),e):e.status(200).json(a)))})),a.post("/get-sale-invoice-customer",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.customerid,c=t.body.searchtype,u=t.body.invoiceno;l(n,o,a,r,c,u,((t,n)=>t?s(new i("500","/get-sale-invoice-customer",t),e):e.status(200).json(n)))})),a.post("/get-sale-invoice-center",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.customerid,c=t.body.searchtype,u=t.body.invoiceno;v(n,a,r,o,c,u,((t,n)=>t?s(new i("500","/get-sale-invoice-center",t),e):e.status(200).json(n)))})),a.post("/get-payments-customer",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.customerid,c=t.body.searchtype,u=t.body.invoiceno;_(n,o,a,r,c,u,((t,n)=>t?s(new i("500","/get-payments-customer",t),e):e.status(200).json(n)))})),a.post("/get-payments-overview-customer",(async(t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),s=t.body.customerid,i=t.body.searchtype;const o=await m(n,s,a,r,i,e);return e.status(200).json(o)})),a.get("/get-pymt-transactions-customer/:centerid/:customerid",((t,e)=>{b(t.params.centerid,t.params.customerid,((t,n)=>t?s(new i("500","/get-pymt-transactions-customer/:centerid/:customerid",t),e):e.status(200).json(n)))})),a.post("/get-payments-center",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.customerid,c=t.body.searchtype,u=t.body.invoiceno;g(n,a,r,o,c,u,((t,n)=>t?s(new i("500","/get-payments-center",t),e):e.status(200).json(n)))})),a.post("/get-payments-overview-center",(async(t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),s=t.body.customerid,i=t.body.searchtype,o=await k(n,a,r,s,i,e);return e.status(200).json(o)})),a.get("/get-pymt-transactions-center/:centerid",((t,e)=>{h(t.params.centerid,((t,n)=>t?s(new i("500","/get-pymt-transactions-center/:centerid",t),e):e.status(200).json(n)))})),a.post("/add-bulk-payment-received",(async(t,e)=>{const n={...t.body},[a,r,s,i,d]=Object.values(t.body);let o=0;for(const a of s){await y(r);let u=await f(n);if(A(n,await c(n,u,a,e),i),o==s.length-1)return"YES"===t.body.creditsused&&$(t.body.creditusedamount,n.centerid,n.customer.id,((t,e)=>{t&&t.message})),d<0&&w(d,n.centerid,n.customer.id,((t,e)=>{t&&t.message})),e.status(200).json("success");o++}})),a.get("/banks-list/:centerid",(async(t,e)=>{let n=t.params.centerid,a=await T(n);if("error"===a.status)s(new i("500","/banks-list",a.response),e);else if("success"===a.status)return e.status(200).json({result:a.response})})),a.post("/pymt-bank-ref-exist",(async(t,e)=>{let n=t.body.centerid,a=t.body.bankref,r=t.body.customerid,d=await S(n,a,r,"payment");if("error"===d.status)s(new i("500","/pymt-bank-ref-exist",d.response),e);else if("success"===d.status){let t=await Y(n,r);return e.status(200).json({result:d.response,result1:t.response})}})),a.post("/vendor-pymt-bank-ref-exist",(async(t,e)=>{let n=t.body.centerid,a=t.body.bankref,r=t.body.vendorid,d=await S(n,a,r,"vendorpayment");if("error"===d.status)s(new i("500","/vendor-pymt-bank-ref-exist",d.response),e);else if("success"===d.status){let t=await E(n,r);return e.status(200).json({result:d.response,result1:t.response})}})),t.exports=a},579:(t,e,n)=>{const a=n(2127).Router();var r=n(3076);n(2470);const{handleError:s,ErrorHandler:i}=n(8005),{getCenterDetails:d}=n(9057),{insertUser:o,updateUserStatus:c,insertUserRole:u,getUsers:l,getOutstandingBalance:_,isUserExist:m,insertBank:p,updateCenterBankInfo:y,updateBank:f,updateBankDefaults:g}=(n(4026),n(8673)),{getCustomerDiscount:v,updateCustomerDiscount:h,insertCustomer:w,updateCustomer:$,getCustomerDetails:b,getAllCustomerDefaultDiscounts:T,updateDefaultCustomerDiscount:S,getDiscountsByCustomerByBrand:Y,getDiscountsByCustomer:E,insertDiscountsByBrands:k,updateCustomerShippingAddress:x,insertCustomerShippingAddress:A,getCustomerShippingAddress:q,inactivateCSA:C}=n(8361),{insertProduct:D,updateProduct:N}=n(8461),{insertVendor:I,updateVendor:P}=n(8647),{insertBrand:M,updateBrand:R}=n(3269),{getPermissions:O,checkUsernameExists:H}=n(4698),{isStockIdExist:F,insertToStock:L,insertItemHistoryTable:j}=n(3127);a.get("/view-products-count/:centerid",((t,e)=>{let n=t.params.centerid,a=`select count(*) as count from product p where \n\tp.center_id = '${n}' `;r.query(a,(function(t,a){return t?s(new i("500",`view-products-count/:centerid ${n}`,t),e):e.status(200).json(a)}))})),a.get("/view-product-info/:centerid/:productid",((t,e)=>{let n=t.params.centerid,a=t.params.productid,d=`\n\tselect p.*, b.name as brand_name, b.id as brand_id  \n\tfrom \n\tproduct p,\n\tbrand b \n\twhere\n\tp.brand_id = b.id and\n\tp.id = '${a}' and\n\tp.center_id = '${n}' `;r.query(d,(function(t,r){return t?s(new i("500",`/view-product-info/:centerid/:productid ${n}, ${a}`,t),e):e.status(200).json(r)}))})),a.post("/add-product",(async(t,e,n)=>{let a=t.body;if(1===(await D(a,e)).affectedRows)return e.status(200).json({result:"success"})})),a.post("/update-product",(async(t,e)=>{let n=t.body;"success"===await N(n)&&0===await F({product_id:n.product_id,mrp:n.mrp})&&(await L(n.product_id,n.mrp,"0","0",e),await j(n.center_id,"Product",n.product_id,"0","0","0","0","PRD",`MRP Change - ${n.mrp}`,"0","0","0","0","0",e)),e.status(200).json({result:"success"})})),a.get("/get-vendor-details/:centerid/:vendorid",((t,e)=>{let n=t.params.centerid,a=t.params.vendorid,d=`select v.*, s.code as code,\n\t s.description as state \n\tfrom vendor v, \n\tstate s where \n\ts.id = v.state_id and\n\tv.id = '${a}' and\n\tv.center_id = '${n}' order by v.name`;r.query(d,(function(t,r){return t?s(new i("500",`/get-vendor-details/:centerid/:vendorid ${n} ${a}`,t),e):e.status(200).json(r)}))})),a.get("/get-states",((t,e)=>{r.query("select * from state order by description",(function(t,n){return t?s(new i("500","get-states",t),e):e.status(200).json(n)}))})),a.get("/get-timezones",((t,e)=>{r.query("select * from timezones ",(function(t,n){return t?s(new i("500","get-timezones",t),e):e.status(200).json(n)}))})),a.put("/update-vendor/:id",((t,e)=>{P(t.body,t.params.id,((n,a)=>n?s(new i("500",`/update-vendor/:id ${t.params.id}`,n),e):e.status(200).json({result:"success"})))})),a.put("/update-brand/:id",((t,e)=>{R(t.body,t.params.id,((n,a)=>n?s(new i("500",`/update-brand/:id ${t.params.id}`,n),e):e.status(200).json({result:"success"})))})),a.post("/add-vendor",((t,e,n)=>{let a=t.body;I(a,((t,n)=>{if(!t)return n.insertId,e.status(200).json({result:"success"});t.message}))})),a.post("/add-brand",((t,e,n)=>{let a=t.body;M(a,((t,n)=>{if(!t)return n.insertId,e.status(200).json({result:"success"});t.message}))})),a.get("/get-customer-details/:centerid/:customerid",(async(t,e)=>{let n=await b(t.params.centerid,t.params.customerid);return e.status(200).json(n)})),a.put("/update-customer/:id",((t,e)=>{$(t.body,t.params.id,((n,a)=>n?s(new i("500",`/update-customer/:id ${t.params.id}`,n),e):e.status(200).json({result:"success"})))})),a.post("/add-customer",((t,e)=>{let n=t.body;w(n,((t,n)=>t?s(new i("500","/add-customer",t),e):(JSON.stringify(n),e.status(200).json({result:"success",id:n.id}))))})),a.get("/get-center-details/:centerid",(async(t,e)=>{let n=await d(t.params.centerid);return e.status(200).json(n)})),a.post("/update-center",((t,e)=>{var n=t.body.formArray;const a=n[0],d=n[1],o=n[2],c=a.center_id;let u=`\n\tupdate center set company_id = '${a.company_id}',\n\tname = '${a.name}', address1 = '${a.address1}',address2 = '${a.address2}', address3 = '${a.address3}',\n\tdistrict = '${a.district}', state_id = '${a.state_id}', pin = '${a.pin}',gst = '${d.gst}',\n\tphone = '${d.phone}', mobile = '${d.mobile}',mobile2 = '${d.mobile2}', whatsapp = '${d.whatsapp}',\n\temail = '${o.email}', bankname = '${o.bankname}', accountno = '${o.accountno}', ifsccode = '${o.ifsccode}', branch = '${o.branch}'\n\twhere\n\tid = '${c}'\n\t`;r.query(u,(function(t,n){return t?s(new i("500","update-center",t),e):e.status(200).json({result:"success"})}))})),t.exports=a,a.get("/prod-exists/:pcode/:centerid",((t,e)=>{let n=t.params.pcode,a=t.params.centerid,d=`select * from product p where \n\tp.product_code = '${n}' and center_id = ${a} `;r.query(d,(function(t,a){return t?s(new i("500",`/prod-exists/:pcode ${n}`,t),e):e.status(200).json({result:a})}))})),a.post("/insert-customer-shipping-address",((t,e)=>{let n=t.body;A(n,e,((t,n)=>t?s(new i("500","/insert-customer-shipping-address",t),e):(JSON.stringify(n),e.status(200).json({result:"success"}))))})),a.get("/get-shipping-address/:customerid",((t,e)=>{q(`${t.params.customerid}`,((n,a)=>n?s(new i("500",`/get-shipping-address/:customerid ${t.params.customerid}`,n),e):e.json(a)))})),a.put("/update-customer-shipping-address/:id",((t,e)=>{t.body,x(t.body,t.params.id,((n,a)=>n?s(new i("500",`/update-customer-shipping-address/:id ${t.params.id}`,n),e):e.json(a)))})),a.post("/inactivate-csa",(async(t,e)=>{let n=t.body;return"UPDATED"===await C(n.id)?e.status(200).json({message:"Address Deleted."}):e.status(200).json({message:"Address Deletion Failed."})})),a.get("/customer-discount/:centerid/:customerid",((t,e)=>{v(`${t.params.centerid}`,`${t.params.customerid}`,((n,a)=>n?s(new i("500",`/customer-discount/:centerid/:customerid ${t.params.centerid} ${t.params.customerid}`,n),e):e.json(a)))})),a.get("/all-customer-default-discounts/:centerid/:customerid",((t,e)=>{T(`${t.params.centerid}`,`${t.params.customerid}`,((n,a)=>n?s(new i("500",`/all-customer-default-discounts/:centerid ${t.params.centerid} ${t.params.customerid}`,n),e):e.json(a)))})),a.get("/discounts-customer/:centerid/:customerid",((t,e)=>{E(`${t.params.centerid}`,`${t.params.customerid}`,((n,a)=>n?s(new i("500",`/discounts-customer/:centerid/:customerid ${t.params.centerid} ${t.params.customerid}`,n),e):e.json(a)))})),a.get("/discounts-customer-brands/:centerid/:customerid",((t,e)=>{Y(`${t.params.centerid}`,`${t.params.customerid}`,((n,a)=>n?s(new i("500",`/discounts-customer-brands/:centerid/:customerid ${t.params.centerid} ${t.params.customerid}`,n),e):e.json(a)))})),a.put("/update-default-customer-discount",((t,e)=>{let n=t.body;S(n,((t,n)=>t?s(new i("500","update-default-customer-discount",t),e):e.json(n)))})),a.put("/update-customer-discount",((t,e)=>{let n=t.body;h(n,((t,n)=>t?s(new i("500","/update-customer-discount",t),e):e.json(n)))})),a.post("/add-discounts-brand",((t,e)=>{let n=t.body;k(n,((t,n)=>t?s(new i("500","/add-discounts-brand",t),e):(JSON.stringify(n),e.status(200).json({result:"success"}))))})),a.post("/add-user",(async(t,e,n)=>{let a=t.body;if("DUP_USERNAME"===await m(a))return e.status(200).json({message:"DUP_USERNAME"});{let n=await o(a);if(null!==n||""!==n||void 0!==n)return await u({user_id:n,role_id:t.body.role_id}),e.status(200).json({message:"User Inserted"})}})),a.post("/update-user-status",(async(t,e,n)=>{let a=t.body;return 0!==await c(a)?e.status(200).json({message:"User Status Updated."}):e.status(200).json({message:"User Status Update Failed."})})),a.get("/get-users/:centerid/:status",(async(t,e)=>{let n=await l(t.params.centerid,t.params.status);return e.status(200).json(n)})),a.get("/usename-exists/:phone/:centerid",(async(t,e)=>null!==await H(t.params.phone,t.params.centerid)?e.status(200).json({message:"NEW_USER"}):e.status(200).json({message:"ALREADY_EXIST"}))),a.post("/get-outstanding-balance",(async(t,e)=>{let n=await _(t.body.center_id,t.body.limit);return e.status(200).json(n)})),a.post("/add-bank",(async(t,e,n)=>{let a=t.body;return"success"===await p(a)?t.body.isdefault?"success"===await y(a)?e.status(200).json({message:"success"}):e.status(200).json({message:"Error"}):e.status(200).json({message:"success"}):e.status(200).json({message:"Error"})})),a.post("/update-bank",(async(t,e,n)=>{let a=t.body;return t.body.isdefault&&await g(a.center_id),"success"===await f(a)?t.body.isdefault?"success"===await y(a)?e.status(200).json({message:"success"}):e.status(200).json({message:"Error"}):e.status(200).json({message:"success"}):e.status(200).json({message:"Error"})}))},3220:(t,e,n)=>{const a=n(2127).Router(),r=(n(4026),n(6552));n(1201),n(3076);const{handleError:s,ErrorHandler:i}=n(8005),{getPermissions:d,checkUsernameExists:o,updateCenterForSuperAdmin:c}=n(4698);n(2127),a.post("/super-admin",((t,e)=>{let n=t.body.center_id;return c(n),e.status(200).json({result:"success"})})),a.post("/login",(async(t,e)=>{const[n,a]=Object.values(t.body);console.log("dinesh "+n+"pass"+a);let d=await o(n);return console.log("dinesh "+d),""==d?s(new i("601","User not found",`invalid credentials: ${n} ${a}`),e):null!=d?await r.compare(a,d[0].userpass)?(console.log("object ::: password matched"),e.status(200).json({result:"success",role:d[0].role,userid:d[0].userid,obj:d[0]})):s(new i("600","Invalid Credentials.",`invalid credentials: ${n} ${a}`),e):s(new i("100","Error while authenticating.",`invalid credentials: ${n} ${a}`),e)})),a.get("/fetch-permissions/:centerid/:roleid",(async(t,e)=>{let n=t.params.centerid,a=t.params.roleid,r=await d(n,a);return e.status(200).json(r)})),a.get("/logs",(function(t,e,n){e.sendFile("/usr/local/server/reddotuat/logs/log.log",(function(t){t?n(t):console.log("Sent the logs..")}))})),a.get("/access-logs",(function(t,e,n){e.sendFile("/usr/local/server/reddotuat/logs/access-log.log",(function(t){t?n(t):console.log("Sent the logs..")}))})),t.exports=a},3320:(t,e,n)=>{n(5747);const a=n(3863);n(6779),n(8372),n(4026);const{number2text:r}=n(8372);let s=24,i=571;function d(t,e,n){t.image("upload/"+e.logo_name,24,24,{width:70}).fillColor("darkblue"),t.font("Helvetica").fontSize(10).text(n,400,20,{align:"right"}).font("Helvetica"),t.fillColor("#000000"),t.font("Helvetica-Bold").fontSize(14).text(e.name,10,40,{align:"center",lineGap:2,characterSpacing:1.2}).font("Helvetica").fontSize(9).text(e.tagline,{align:"center",lineGap:1.5,characterSpacing:1}).text(e.address1+","+e.address2+", "+e.district+"-"+e.pin,{align:"center",lineGap:1.5}).text("GSTIN : "+e.gst,{align:"center",lineGap:1.5}).text("Email: "+e.email,{align:"center",lineGap:1.5}).text("Phone : "+e.phone+" & "+e.mobile,410,92),t.image("upload/"+e.side_logo_name,475,62,{width:80}),t.moveDown()}function o(t,e,n,a){_(t,s,i,109),t.fillColor("#000000").fontSize(13).font("Helvetica-Bold").text("To",34,117).font("Helvetica");let r="gstinvoice"===n.sale_type?"GST INVOICE":"STOCK ISSUE";t.fillColor("#000000").fontSize(12).text(r,440,119,{align:"center"}),t.fillColor("#000000"),t.strokeColor("#000000").moveTo(460,136).lineTo(570,136).stroke(),t.fillColor("#000000").fontSize(10).text("BILL No.     : "+n.invoice_no,460,145),t.fillColor("#000000").fontSize(10).text("BILL Date    : "+n.invoice_date,460,160),t.fillColor("#000000").fontSize(10).text("CREDIT NOTE #: "+a,460,175),"Walk In"===e.name?t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(n.retail_customer_name,40,136).font("Helvetica").text(n.retail_customer_address,40,151).text(n.retail_customer_phone,40,171):t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(e.name,40,136).font("Helvetica").text(e.address1,40,151),""!==e.district?t.text(e.address2+", District: "+e.district,40,166):t.text(e.address2,40,166),t.fillColor("#000000").text("State: "+e.description+" Pin: "+e.pin,40,181).font("Helvetica-Bold").text("Phone: "+e.mobile+" GSTIN: "+e.gst,40,196).font("Helvetica").moveDown(),_(t,s,i,210)}function c(t,e,n,a,c,v){let h=216,w=!1;0===e.igst&&0===e.igst||(w=!0),u(t,h,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",24,w,"IGST"),_(t,s,i,h+13),t.strokeColor("#000000").moveTo(54,210).lineWidth(1).lineTo(54,230).stroke(),t.strokeColor("#000000").moveTo(115,210).lineWidth(1).lineTo(115,229),t.strokeColor("#000000").moveTo(241,210).lineWidth(1).lineTo(241,229).stroke(),t.strokeColor("#000000").moveTo(284,210).lineWidth(1).lineTo(284,229).stroke(),t.strokeColor("#000000").moveTo(315,210).lineWidth(1).lineTo(315,229).stroke(),t.strokeColor("#000000").moveTo(346,210).lineWidth(1).lineTo(346,229).stroke(),t.strokeColor("#000000").moveTo(391,210).lineWidth(1).lineTo(391,229).stroke(),t.strokeColor("#000000").moveTo(417,210).lineWidth(1).lineTo(417,229).stroke(),t.strokeColor("#000000").moveTo(463,210).lineWidth(1).lineTo(463,229).stroke(),w?t.strokeColor("#000000").moveTo(515,210).lineWidth(1).lineTo(515,229).stroke():(t.strokeColor("#000000").moveTo(490,210).lineWidth(1).lineTo(490,229).stroke(),t.strokeColor("#000000").moveTo(517,210).lineWidth(1).lineTo(517,229).stroke()),n.forEach((function(n,r){h+=0===r?16:11,u(t,h,r+1,n.description,n.product_code,n.hsncode,n.return_qty,n.unit,n.mrp,n.disc_percent,n.taxable_value,n.sgst,n.cgst,n.total_value,24,w,n.igst),h>520&&(t.fontSize(14),t.text("continue in next page",50,h+50),t.fontSize(8),h=216,t.addPage({margin:24}),d(t,a,c),_(t,s,i,107),o(t,v,e,credit_note_no),u(t,h,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",24,w,"IGST"),_(t,s,i,h+10)),t.strokeColor("#000000").moveTo(54,h-6).lineWidth(1).lineTo(54,540).stroke(),t.strokeColor("#000000").moveTo(115,h-8).lineWidth(1).lineTo(115,540),t.strokeColor("#000000").moveTo(241,h-8).lineWidth(1).lineTo(241,540).stroke(),t.strokeColor("#000000").moveTo(284,h-8).lineWidth(1).lineTo(284,540).stroke(),t.strokeColor("#000000").moveTo(315,h-8).lineWidth(1).lineTo(315,540).stroke(),t.strokeColor("#000000").moveTo(346,h-8).lineWidth(1).lineTo(346,540).stroke(),t.strokeColor("#000000").moveTo(391,h-8).lineWidth(1).lineTo(391,540).stroke(),t.strokeColor("#000000").moveTo(417,h-8).lineWidth(1).lineTo(417,540).stroke(),t.strokeColor("#000000").moveTo(463,h-8).lineWidth(1).lineTo(463,540).stroke(),w?t.strokeColor("#000000").moveTo(515,h-8).lineWidth(1).lineTo(515,540).stroke():(t.strokeColor("#000000").moveTo(490,h-8).lineWidth(1).lineTo(490,540).stroke(),t.strokeColor("#000000").moveTo(517,h-8).lineWidth(1).lineTo(517,540).stroke())})),function(t,e,n,a){let d=m(e,"SGST",0).toFixed(2),o=m(e,"CGST",0).toFixed(2),c=m(e,"IGST",0).toFixed(2),u=m(e,"SGST",5).toFixed(2),v=m(e,"CGST",5).toFixed(2),h=m(e,"IGST",5).toFixed(2),w=m(e,"SGST",12).toFixed(2),$=m(e,"CGST",12).toFixed(2),b=m(e,"IGST",12).toFixed(2),T=m(e,"SGST",18).toFixed(2),S=m(e,"CGST",18).toFixed(2),Y=m(e,"IGST",18).toFixed(2),E=m(e,"SGST",28).toFixed(2),k=m(e,"CGST",28).toFixed(2),x=m(e,"IGST",28).toFixed(2),A=+d/2+ +o/2+ +c,q=+u/2+ +v/2+ +h,C=+w/2+ +$/2+ +b,D=+T/2+ +S/2+ +Y,N=+E/2+ +k/2+ +x,I=p(e,0).toFixed(2),P=p(e,5).toFixed(2),M=p(e,12).toFixed(2),R=p(e,18).toFixed(2),O=p(e,28).toFixed(2),H=y(e,0).toFixed(2),F=y(e,5).toFixed(2),L=y(e,12).toFixed(2),j=y(e,18).toFixed(2),U=y(e,28).toFixed(2),G=f(e,0).toFixed(2),B=f(e,5).toFixed(2),K=f(e,12).toFixed(2),W=f(e,18).toFixed(2),z=f(e,28).toFixed(2),V=+H+ +F+ +L+ +j+ +U,Z=+I+ +P+ +M+ +R+ +O,Q=+G+ +B+ +K+ +W+ +z,J=+d/2+ +u/2+ +w/2+ +T/2+ +E/2,X=+o/2+ +v/2+ +$/2+ +S/2+ +k/2,tt=+c+ +h+ +b+ +Y+ +x,et=+G+ +B+ +K+ +W+ +z,nt=539;_(t,s,i,nt),t.font("Helvetica-Bold"),l(t,549,"CLASS","SUB TOTAL","DISC","AMOUNT","SGST","CGST","GST","TOTAL",n,"IGST"),t.font("Helvetica"),l(t,564,"GST 5%",B,P,F,u,v,q,B,n,h),l(t,579,"GST 12%",K,M,L,w,$,C,K,n,b),l(t,594,"GST 18%",W,R,j,T,S,D,W,n,S),l(t,609,"GST 28%",z,O,U,E,k,N,z,n,k),l(t,624,"GST 0%",G,I,H,d,o,A,G,n,o),_(t,s,i,636),t.font("Helvetica-Bold"),l(t,644,"TOTAL",Q,Z,V,2*J,2*X,J+X+tt,et,n,tt),t.font("Helvetica"),function(t,e,n,a,r,s,i,d,o,c){t.fillColor("#000000"),t.fontSize(9).font("Helvetica-Bold").text("SUB TOTAL",450,e,{width:70,align:"left"}).font("Helvetica").text((+n+ +a).toFixed(2),500,e,{width:70,align:"right"}).text("DISCOUNT",450,564,{width:70,align:"left"}).text((+a).toFixed(2),500,564,{width:70,align:"right"}),d?d&&t.text("IGST",450,579,{width:70,align:"left"}).text((+o).toFixed(2),500,579,{width:70,align:"right"}):t.text("SGST",450,579,{width:70,align:"left"}).text((+r/2).toFixed(2),500,579,{width:70,align:"right"}).text("CGST",450,594,{width:70,align:"left"}).text((+s/2).toFixed(2),500,594,{width:70,align:"right"}),t.text("Misc.",450,609,{width:70,align:"left"}).text((+(+c.transport_charges+ +c.unloading_charges+ +c.misc_charges)).toFixed(2),500,609,{width:70,align:"right"});let u=+(+i+ +c.transport_charges+ +c.unloading_charges+ +c.misc_charges);t.text("ROUNDED OFF",450,624,{width:70,align:"left"}).text((g(u,"rounding")-g(u,"withoutrounding")).toFixed(2),500,624,{width:70,align:"right"}),t.font("Helvetica-Bold"),t.text("TOTAL",450,644,{width:70,align:"left"}).text(g(u,"rounding").toLocaleString("en-IN")+".00",500,644,{width:70,align:"right"}).font("Helvetica")}(t,549,Q,Z,2*J,2*X,et,n,tt,a),_(t,s,i,659),function(t,e,n){t.font("Helvetica-Bold"),t.fontSize(9).text(r(g(e,"rounding")),24,664,{align:"left"}),t.font("Helvetica")}(t,et),_(t,s,i,676)}(t,n,w,e)}function u(t,e,n,a,r,s,i,d,o,c,u,l,_,m,p,y,f){t.fillColor("#000000");t.fontSize(8).text(n,p,e,{width:24,align:"left"}),"PCODE"===r?t.text(r,p+31,e,{width:59,align:"left"}):t.text(r,p+32,e,{width:59,align:"left"}),"PRODUCT NAME"!==a?t.text(a.length>33?a.substr(0,29)+"...":a,p+31+62,e,{width:124,align:"left",ellipsis:!0}):t.text(a,p+31+61,e,{width:124,align:"left"})," HSN "===s?t.text(s,p+31+61+126,e,{width:41,align:"center"}):t.text(s,p+31+61+127,e,{width:41,align:"left"})," QTY "===i?t.text(i,p+31+61+126+43,e,{width:28,align:"right"}):t.text(i,p+31+61+126+43,e,{width:26,align:"right"}),t.text(d,p+31+61+126+43+31,e,{width:29,align:"center"})," MRP "===o?t.text(o,p+31+61+126+43+31+31,e,{width:43,align:"center"}):t.text((+o).toFixed(2),p+31+61+126+43+31+31,e,{width:41,align:"right"}),"DIS%"===c?t.text(c,p+31+61+126+43+31+31+46,e,{width:24,align:"center"}):t.text(c.toFixed(2),p+31+61+126+43+31+31+46,e,{width:22,align:"right"})," AMOUNT "===u?t.text(u,p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}):t.text(u.toFixed(2),p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}),"SGST"!==l||y?y||t.text(l.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:22,align:"right"}):t.text(l,p+31+61+126+43+31+31+46+26+46,e,{width:25,align:"center"}),"CGST"!==_||y?y||t.text(_.toFixed(2),p+31+61+126+43+31+31+46+26+46+27,e,{width:22,align:"right"}):t.text(_,p+31+61+126+43+31+31+46+26+46+27,e,{width:24,align:"right"}),"IGST"===f&&y?t.text(f,p+31+61+126+43+31+31+46+26+46,e,{width:50,align:"center"}):y&&t.text(f.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:30,align:"right"}),"NET AMNT"===m?t.text(m,p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"}):t.text(m.toFixed(2),p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"})}function l(t,e,n,a,r,s,i,d,o,c,u,l){t.fillColor("#000000"),t.fontSize(9).text(n,24,e,{width:40,align:"left"}),"SUB TOTAL"===a?t.text(a,64,e,{width:50,align:"right"}):t.text((+a+ +r).toFixed(2),64,e,{width:50,align:"right"}),"DISC"===r?t.text(r,113,e,{width:49,align:"right"}):t.text((+r).toFixed(2),113,e,{width:49,align:"right"}),"AMOUNT"===s?t.text(s,169,e,{width:49,align:"right"}):t.text((+s).toFixed(2),169,e,{width:49,align:"right"}),u?u&&("IGST"===l?t.text(l,225,e,{width:39,align:"right"}):t.text((+l).toFixed(2),225,e,{width:39,align:"right"}),"GST"===o?t.text(o,281,e,{width:49,align:"right"}):t.text((+o).toFixed(2),281,e,{width:49,align:"right"}),"TOTAL"===c?t.text(c,337,e,{width:49,align:"right"}):t.text((+c).toFixed(2),337,e,{width:49,align:"right"})):("SGST"===i?t.text(i,225,e,{width:49,align:"right"}):t.text((+i/2).toFixed(2),225,e,{width:49,align:"right"}),"CGST"===d?t.text(d,281,e,{width:49,align:"right"}):t.text((+d/2).toFixed(2),281,e,{width:49,align:"right"}),"GST"===o?t.text(o,337,e,{width:49,align:"right"}):t.text((+o).toFixed(2),337,e,{width:49,align:"right"}),"TOTAL"===c?t.text(c,393,e,{width:49,align:"right"}):t.text((+c).toFixed(2),393,e,{width:49,align:"right"}))}function _(t,e,n,a){t.strokeColor("#000000").lineWidth(1).moveTo(e,a).lineTo(n,a).stroke()}function m(t,e,n){return t.filter((t=>"IGST"===e?t.igst===n:"CGST"===e?t.cgst===n/2:"SGST"===e?t.sgst===n/2:void 0)).reduce(((t,e)=>t+e.taxable_value*(n/100)),0)}function p(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.disc_value),0)}function y(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.taxable_value),0)}function f(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.total_value),0)}function g(t,e){return"rounding"===e?Math.round(+t.toFixed(2)):"withoutrounding"===e?+t.toFixed(2):void 0}t.exports={createCreditNote:function(t,e,n,r,s,i,u){let l=r[0],_=n[0],m=t[0],p=e;u.contentType("application/pdf");let y=new a({"page-size":"A4",dpi:400,margin:24,autoFirstPage:!1,layout:"portrait"});y.addPage(),y.font("Helvetica"),d(y,l,"Credit Note"),o(y,_,m,i),c(y,m,p,l,"Credit Note",_),function(t,e){let n=680;t.fontSize(8).text("Terms & Conditions:",24,n).text("Goods once sold will not be taken back or exchanged.",{lineGap:1.8}).text("Bills not paid due date will attract 24% interest.",{lineGap:1.8}).text("All disputes subject to Jurisdication only.",{lineGap:1.8}).text("Prescribed Sales Tax declaration will be given.",{lineGap:1.8}),t.strokeColor("#000000").lineWidth(1).moveTo(24,734).lineTo(280,734).stroke(),t.fontSize(8).text("Certified that the particulars given above are true and correct",24,740,{lineGap:1.8}).text("and the amount indicated represents the price actually charged.",24,750,{lineGap:1.8}),t.fontSize(8).font("Helvetica-Bold").text("OUR BANK        : "+e.bankname,320,n,{lineGap:1.8}).text("A/C NAME          : "+e.accountname,320,690,{lineGap:1.8}).text("A/C NO               : "+e.accountno,320,700,{lineGap:1.8}),t.font("Times-BoldItalic"),t.fontSize(6).text(`Plz pay Cash/Cheque/DD in favour of '${e.accountname}'.`,320,710,{lineGap:1.4}),t.fontSize(7).text("For    "+e.accountname,400,720),t.fontSize(7).text("Authorised signatory",400,755),t.fontSize(8).text("Software By: 97316 16386",250,758)}(y,l),y.end(),y.pipe(u)}}},5425:(t,e,n)=>{n(5747);const a=n(3863);n(6779),n(8372),n(4026);const{number2text:r}=n(8372);let s=24,i=600,d=0,o=0;function c(t,e,n){t.fillColor("#000000"),t.font("Helvetica-Bold").fontSize(14).text("Estimate",10,40,{align:"center",lineGap:2,characterSpacing:1.2}).moveDown()}function u(t,e,n){_(t,s,i,60),t.fillColor("#000000").fontSize(10).text("Number       :    "+n.invoice_no,410,70),t.fillColor("#000000").fontSize(10).text("Date             :    "+n.invoice_date,410,85),"Walk In"===e.name?t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text("NAME:"+n.retail_customer_name,40,70).font("Helvetica").text("PLACE:"+n.retail_customer_address,40,85).text("PHONE:"+n.retail_customer_phone,40,100):(t.fillColor("#000000").fontSize(10).text("NAME:"+e.name,40,70).text("PLACE:"+e.address1,40,85),t.fillColor("#000000").text("Phone: "+e.mobile,40,100).moveDown()),_(t,s,i,115)}function l(t,e,n,a,r,s,i,d,o,c,u,l,_,m,p,y,f){t.fillColor("#000000");t.fontSize(8).text(n,p,e,{width:24,align:"left"}),"PCODE"===r?t.text(r,p+31,e,{width:59,align:"left"}):t.text(r,p+32,e,{width:59,align:"left"}),"PRODUCT NAME"!==a?t.text(a.length>33?a.substr(0,29)+"...":a,p+31+62,e,{width:124,align:"left",ellipsis:!0}):t.text(a,p+31+61,e,{width:124,align:"left"})," HSN "===s?t.text(s,p+31+61+126,e,{width:41,align:"center"}):t.text(s,p+31+61+127,e,{width:41,align:"left"})," QTY "===i?t.text(i,p+31+61+126+43,e,{width:28,align:"right"}):t.text(i,p+31+61+126+43,e,{width:26,align:"right"}),t.text(d,p+31+61+126+43+31,e,{width:29,align:"center"})," MRP "===o?t.text(o,p+31+61+126+43+31+31,e,{width:43,align:"center"}):t.text((+o).toFixed(2),p+31+61+126+43+31+31,e,{width:41,align:"right"}),"DIS%"===c?t.text(c,p+31+61+126+43+31+31+46,e,{width:24,align:"center"}):t.text(c.toFixed(2),p+31+61+126+43+31+31+46,e,{width:22,align:"right"})," AMOUNT "===u?t.text(u,p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}):t.text(u.toFixed(2),p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}),"SGST"!==l||y?y||t.text(l.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:22,align:"right"}):t.text(l,p+31+61+126+43+31+31+46+26+46,e,{width:25,align:"center"}),"CGST"!==_||y?y||t.text(_.toFixed(2),p+31+61+126+43+31+31+46+26+46+27,e,{width:22,align:"right"}):t.text(_,p+31+61+126+43+31+31+46+26+46+27,e,{width:24,align:"right"}),"IGST"===f&&y?t.text(f,p+31+61+126+43+31+31+46+26+46,e,{width:50,align:"center"}):y&&t.text(f.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:30,align:"right"}),"NET AMNT"===m?t.text(m,p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"}):t.text(m.toFixed(2),p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"})}function _(t,e,n,a){t.strokeColor("#000000").lineWidth(1).moveTo(e,a).lineTo(n,a).stroke()}function m(t,e,n){return t.filter((t=>"IGST"===e?t.igst===n:"CGST"===e?t.cgst===n/2:"SGST"===e?t.sgst===n/2:void 0)).reduce(((t,e)=>t+e.taxable_value*(n/100)),0)}function p(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.disc_value),0)}function y(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.taxable_value),0)}function f(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.total_value),0)}t.exports={createEstimate:function(t,e,n,r,g,v,h){r[0];let w=n[0],$=t[0],b=e;v.contentType("application/pdf"),d=b.reduce(((t,e)=>t+e.qty),0),o=b.length;let T=new a({"page-size":"A4",dpi:400,margin:24,autoFirstPage:!1,layout:"portrait"});Array.isArray(h)&&h.forEach((t=>{T.addPage(),T.font("Helvetica"),c(T),u(T,w,$),function(t,e,n,a,r,g){let v=125,h=24,w=!1;0===e.igst&&0===e.igst||(w=!0),l(t,v,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",h,w,"IGST"),_(t,s,i,v+13);t.strokeColor("#000000").moveTo(54,115).lineWidth(1).lineTo(54,136).stroke(),t.strokeColor("#000000").moveTo(115,115).lineWidth(1).lineTo(115,136),t.strokeColor("#000000").moveTo(241,115).lineWidth(1).lineTo(241,136).stroke(),t.strokeColor("#000000").moveTo(284,115).lineWidth(1).lineTo(284,136).stroke(),t.strokeColor("#000000").moveTo(315,115).lineWidth(1).lineTo(315,136).stroke(),t.strokeColor("#000000").moveTo(346,115).lineWidth(1).lineTo(346,136).stroke(),t.strokeColor("#000000").moveTo(391,115).lineWidth(1).lineTo(391,136).stroke(),t.strokeColor("#000000").moveTo(417,115).lineWidth(1).lineTo(417,136).stroke(),t.strokeColor("#000000").moveTo(463,115).lineWidth(1).lineTo(463,136).stroke(),w?t.strokeColor("#000000").moveTo(515,115).lineWidth(1).lineTo(515,136).stroke():(t.strokeColor("#000000").moveTo(490,115).lineWidth(1).lineTo(490,136).stroke(),t.strokeColor("#000000").moveTo(517,115).lineWidth(1).lineTo(517,136).stroke()),n.forEach((function(n,a){v+=0===a?16:11,l(t,v,a+1,n.description,n.product_code,n.hsncode,n.qty,n.unit,n.mrp,n.disc_percent,n.taxable_value,n.sgst,n.cgst,n.total_value,h,w,n.igst),v>520&&(t.fontSize(14),t.text("continue in next page",50,v+50),t.fontSize(8),v=216,t.addPage({margin:24}),c(t),u(t,g,e),l(t,v,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",h,w,"IGST"),_(t,s,i,v+10)),t.strokeColor("#000000").moveTo(54,v-6).lineWidth(1).lineTo(54,540).stroke(),t.strokeColor("#000000").moveTo(115,v-8).lineWidth(1).lineTo(115,540),t.strokeColor("#000000").moveTo(241,v-8).lineWidth(1).lineTo(241,540).stroke(),t.strokeColor("#000000").moveTo(284,v-8).lineWidth(1).lineTo(284,540).stroke(),t.strokeColor("#000000").moveTo(315,v-8).lineWidth(1).lineTo(315,540).stroke(),t.strokeColor("#000000").moveTo(346,v-8).lineWidth(1).lineTo(346,540).stroke(),t.strokeColor("#000000").moveTo(391,v-8).lineWidth(1).lineTo(391,540).stroke(),t.strokeColor("#000000").moveTo(417,v-8).lineWidth(1).lineTo(417,540).stroke(),t.strokeColor("#000000").moveTo(463,v-8).lineWidth(1).lineTo(463,540).stroke(),w?t.strokeColor("#000000").moveTo(515,v-8).lineWidth(1).lineTo(515,540).stroke():(t.strokeColor("#000000").moveTo(490,v-8).lineWidth(1).lineTo(490,540).stroke(),t.strokeColor("#000000").moveTo(517,v-8).lineWidth(1).lineTo(517,540).stroke())})),function(t,e,n,a){m(e,"SGST",0).toFixed(2),m(e,"CGST",0).toFixed(2),m(e,"IGST",0).toFixed(2),m(e,"SGST",5).toFixed(2),m(e,"CGST",5).toFixed(2),m(e,"IGST",5).toFixed(2),m(e,"SGST",12).toFixed(2),m(e,"CGST",12).toFixed(2),m(e,"IGST",12).toFixed(2),m(e,"SGST",18).toFixed(2),m(e,"CGST",18).toFixed(2),m(e,"IGST",18).toFixed(2),m(e,"SGST",28).toFixed(2),m(e,"CGST",28).toFixed(2),m(e,"IGST",28).toFixed(2),p(e,0).toFixed(2),p(e,5).toFixed(2),p(e,12).toFixed(2),p(e,18).toFixed(2),p(e,28).toFixed(2),y(e,0).toFixed(2),y(e,5).toFixed(2),y(e,12).toFixed(2),y(e,18).toFixed(2),y(e,28).toFixed(2);let r=+f(e,0).toFixed(2)+ +f(e,5).toFixed(2)+ +f(e,12).toFixed(2)+ +f(e,18).toFixed(2)+ +f(e,28).toFixed(2);_(t,s,i,539),t.font("Helvetica-Bold"),function(t,e,n,a,r,s,i,c,u,l){t.fillColor("#000000");let _=+(+i+ +l.transport_charges+ +l.unloading_charges+ +l.misc_charges);var m;t.fillColor("#000000").fontSize(10).text("Total Items:"+d,200,e),t.fillColor("#000000").fontSize(10).text("Total Qty:"+o,300,e),t.font("Helvetica-Bold"),t.text("TOTAL",480,e,{width:70,align:"left"}).text((m=_,Math.round(+m.toFixed(2))).toLocaleString("en-IN")+".00",500,e,{width:70,align:"right"}).font("Helvetica")}(t,549,0,0,0,0,r,0,0,a),_(t,s,i,569)}(t,n,0,e)}(T,$,b,0,0,w)})),T.end(),T.pipe(v)}}},1701:(t,e,n)=>{n(5747);const a=n(3863);n(6779),n(8372),n(4026);const{number2text:r}=n(8372);let s=24,i=571;function d(t,e,n){t.image("upload/"+e.logo_name,24,24,{width:70}).fillColor("darkblue"),t.font("Helvetica").fontSize(10).text(n,400,20,{align:"right"}).font("Helvetica"),t.fillColor("#000000"),t.font("Helvetica-Bold").fontSize(14).text(e.name,10,40,{align:"center",lineGap:2,characterSpacing:1.2}).font("Helvetica").fontSize(9).text(e.tagline,{align:"center",lineGap:1.5,characterSpacing:1}).text(e.address1+","+e.address2+", "+e.district+"-"+e.pin,{align:"center",lineGap:1.5}).text("GSTIN : "+e.gst,{align:"center",lineGap:1.5}).text("Email: "+e.email,{align:"center",lineGap:1.5}).text("Phone : "+e.phone+" & "+e.mobile,410,92),t.image("upload/"+e.side_logo_name,475,62,{width:80}),t.moveDown()}function o(t,e,n,a){_(t,s,i,109),a?t.fillColor("#000000").fontSize(13).text("Registered Office",260,117):t.fillColor("#000000").fontSize(13).font("Helvetica-Bold").text("To",34,117).font("Helvetica");let r="gstinvoice"===n.sale_type?"GST INVOICE":"STOCK ISSUE";t.fillColor("#000000").fontSize(12).text(r,440,119,{align:"center"}),t.fillColor("#000000"),t.strokeColor("#000000").moveTo(460,136).lineTo(570,136).stroke(),t.fillColor("#000000").fontSize(10).text("BILL No.     : "+n.invoice_no,460,145),t.fillColor("#000000").fontSize(10).text("BILL Date    : "+n.invoice_date,460,160),"Walk In"===e.name?t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(n.retail_customer_name,40,136).font("Helvetica").text(n.retail_customer_address,40,151).text(n.retail_customer_phone,40,171):a?t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(e.name,270,136).font("Helvetica").text(e.address1,270,151):t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(e.name,40,136).font("Helvetica").text(e.address1,40,151),""!==e.district?a?t.text(e.address2+", District: "+e.district,270,166):t.text(e.address2+", District: "+e.district,40,166):a?t.text(e.address2,270,166):t.text(e.address2,40,166),a?t.fillColor("#000000").text("State: "+e.description+" Pin: "+e.pin,270,181).font("Helvetica-Bold").text("Phone: "+e.mobile+" GSTIN: "+e.gst,270,196).font("Helvetica").moveDown():t.fillColor("#000000").text("State: "+e.description+" Pin: "+e.pin,40,181).font("Helvetica-Bold").text("Phone: "+e.mobile+" GSTIN: "+e.gst,40,196).font("Helvetica").moveDown(),_(t,s,i,210)}function c(t,e,n){_(t,s,i,109),t.fillColor("#000000").fontSize(12).text("Ship To",24,117),"Walk In"===e.name?t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(n.retail_customer_name,40,136).font("Helvetica").text(n.retail_customer_address,40,151).text(n.retail_customer_phone,40,171):t.fillColor("#000000").fontSize(10).font("Helvetica-Bold").text(e.name,40,136).font("Helvetica").text(e.csa_address1,40,151),""!==e.csa_district?t.text(e.csa_address2+", District: "+e.csa_district,40,166):t.text(e.csa_address2,40,166),t.fillColor("#000000").text("State: "+e.csa_description+" Pin: "+e.pin,40,181).font("Helvetica-Bold").text("Phone: "+e.mobile+" GSTIN: "+e.gst,40,196).font("Helvetica").moveDown(),_(t,s,i,210)}function u(t,e,n,a,r,s,i,d,o,c,u,l,_,m,p,y,f){t.fillColor("#000000");t.fontSize(8).text(n,p,e,{width:24,align:"left"}),"PCODE"===r?t.text(r,p+31,e,{width:59,align:"left"}):t.text(r,p+32,e,{width:59,align:"left"}),"PRODUCT NAME"!==a?t.text(a.length>33?a.substr(0,29)+"...":a,p+31+62,e,{width:124,align:"left",ellipsis:!0}):t.text(a,p+31+61,e,{width:124,align:"left"})," HSN "===s?t.text(s,p+31+61+126,e,{width:41,align:"center"}):t.text(s,p+31+61+127,e,{width:41,align:"left"})," QTY "===i?t.text(i,p+31+61+126+43,e,{width:28,align:"right"}):t.text(i,p+31+61+126+43,e,{width:26,align:"right"}),t.text(d,p+31+61+126+43+31,e,{width:29,align:"center"})," MRP "===o?t.text(o,p+31+61+126+43+31+31,e,{width:43,align:"center"}):t.text((+o).toFixed(2),p+31+61+126+43+31+31,e,{width:41,align:"right"}),"DIS%"===c?t.text(c,p+31+61+126+43+31+31+46,e,{width:24,align:"center"}):t.text(c.toFixed(2),p+31+61+126+43+31+31+46,e,{width:22,align:"right"})," AMOUNT "===u?t.text(u,p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}):t.text(u.toFixed(2),p+31+61+126+43+31+31+46+26,e,{width:41,align:"right"}),"SGST"!==l||y?y||t.text(l.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:22,align:"right"}):t.text(l,p+31+61+126+43+31+31+46+26+46,e,{width:25,align:"center"}),"CGST"!==_||y?y||t.text(_.toFixed(2),p+31+61+126+43+31+31+46+26+46+27,e,{width:22,align:"right"}):t.text(_,p+31+61+126+43+31+31+46+26+46+27,e,{width:24,align:"right"}),"IGST"===f&&y?t.text(f,p+31+61+126+43+31+31+46+26+46,e,{width:50,align:"center"}):y&&t.text(f.toFixed(2),p+31+61+126+43+31+31+46+26+46,e,{width:30,align:"right"}),"NET AMNT"===m?t.text(m,p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"}):t.text(m.toFixed(2),p+31+61+126+43+31+31+46+26+46+52,e,{width:47,align:"right"})}function l(t,e,n,a,r,s,i,d,o,c,u,l){t.fillColor("#000000"),t.fontSize(9).text(n,24,e,{width:40,align:"left"}),"SUB TOTAL"===a?t.text(a,64,e,{width:50,align:"right"}):t.text((+a+ +r).toFixed(2),64,e,{width:50,align:"right"}),"DISC"===r?t.text(r,113,e,{width:49,align:"right"}):t.text((+r).toFixed(2),113,e,{width:49,align:"right"}),"AMOUNT"===s?t.text(s,169,e,{width:49,align:"right"}):t.text((+s).toFixed(2),169,e,{width:49,align:"right"}),u?u&&("IGST"===l?t.text(l,225,e,{width:39,align:"right"}):t.text((+l).toFixed(2),225,e,{width:39,align:"right"}),"GST"===o?t.text(o,281,e,{width:49,align:"right"}):t.text((+o).toFixed(2),281,e,{width:49,align:"right"}),"TOTAL"===c?t.text(c,337,e,{width:49,align:"right"}):t.text((+c).toFixed(2),337,e,{width:49,align:"right"})):("SGST"===i?t.text(i,225,e,{width:49,align:"right"}):t.text((+i/2).toFixed(2),225,e,{width:49,align:"right"}),"CGST"===d?t.text(d,281,e,{width:49,align:"right"}):t.text((+d/2).toFixed(2),281,e,{width:49,align:"right"}),"GST"===o?t.text(o,337,e,{width:49,align:"right"}):t.text((+o).toFixed(2),337,e,{width:49,align:"right"}),"TOTAL"===c?t.text(c,393,e,{width:49,align:"right"}):t.text((+c).toFixed(2),393,e,{width:49,align:"right"}))}function _(t,e,n,a){t.strokeColor("#000000").lineWidth(1).moveTo(e,a).lineTo(n,a).stroke()}function m(t,e,n){return t.filter((t=>"IGST"===e?t.igst===n:"CGST"===e?t.cgst===n/2:"SGST"===e?t.sgst===n/2:void 0)).reduce(((t,e)=>t+e.taxable_value*(n/100)),0)}function p(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.disc_value),0)}function y(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.taxable_value),0)}function f(t,e){return t.filter((t=>t.tax===e)).reduce(((t,e)=>t+e.total_value),0)}function g(t,e){return"rounding"===e?Math.round(+t.toFixed(2)):"withoutrounding"===e?+t.toFixed(2):void 0}t.exports={createInvoice:function(t,e,n,v,h,w,$,b){let T=v[0],S=n[0],Y=t[0],E=e;w.contentType("application/pdf");let k=new a({"page-size":"A4",dpi:400,margin:24,autoFirstPage:!1,layout:"portrait"});Array.isArray($)&&$.forEach((t=>{k.addPage(),k.font("Helvetica"),d(k,T,t),o(k,S,Y,b),b&&c(k,S,Y),function(t,e,n,a,v,h,w){let $=216,b=24,T=!1;0===e.igst&&0===e.igst||(T=!0),u(t,$,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",b,T,"IGST"),_(t,s,i,$+13);t.strokeColor("#000000").moveTo(54,210).lineWidth(1).lineTo(54,230).stroke(),t.strokeColor("#000000").moveTo(115,210).lineWidth(1).lineTo(115,229),t.strokeColor("#000000").moveTo(241,210).lineWidth(1).lineTo(241,229).stroke(),t.strokeColor("#000000").moveTo(284,210).lineWidth(1).lineTo(284,229).stroke(),t.strokeColor("#000000").moveTo(315,210).lineWidth(1).lineTo(315,229).stroke(),t.strokeColor("#000000").moveTo(346,210).lineWidth(1).lineTo(346,229).stroke(),t.strokeColor("#000000").moveTo(391,210).lineWidth(1).lineTo(391,229).stroke(),t.strokeColor("#000000").moveTo(417,210).lineWidth(1).lineTo(417,229).stroke(),t.strokeColor("#000000").moveTo(463,210).lineWidth(1).lineTo(463,229).stroke(),T?t.strokeColor("#000000").moveTo(515,210).lineWidth(1).lineTo(515,229).stroke():(t.strokeColor("#000000").moveTo(490,210).lineWidth(1).lineTo(490,229).stroke(),t.strokeColor("#000000").moveTo(517,210).lineWidth(1).lineTo(517,229).stroke()),n.forEach((function(n,r){$+=0===r?16:11,u(t,$,r+1,n.description,n.product_code,n.hsncode,n.qty,n.unit,n.mrp,n.disc_percent,n.taxable_value,n.sgst,n.cgst,n.total_value,b,T,n.igst),$>520&&(t.fontSize(14),t.text("continue in next page",50,$+50),t.fontSize(8),$=216,t.addPage({margin:24}),d(t,a,v),_(t,s,i,107),o(t,h,e,w),w&&c(t,h,e),u(t,$,"SNo","PRODUCT NAME","PCODE"," HSN "," QTY "," UOM "," MRP ","DIS%"," AMOUNT ","SGST","CGST","NET AMNT",b,T,"IGST"),_(t,s,i,$+10)),t.strokeColor("#000000").moveTo(54,$-6).lineWidth(1).lineTo(54,540).stroke(),t.strokeColor("#000000").moveTo(115,$-8).lineWidth(1).lineTo(115,540),t.strokeColor("#000000").moveTo(241,$-8).lineWidth(1).lineTo(241,540).stroke(),t.strokeColor("#000000").moveTo(284,$-8).lineWidth(1).lineTo(284,540).stroke(),t.strokeColor("#000000").moveTo(315,$-8).lineWidth(1).lineTo(315,540).stroke(),t.strokeColor("#000000").moveTo(346,$-8).lineWidth(1).lineTo(346,540).stroke(),t.strokeColor("#000000").moveTo(391,$-8).lineWidth(1).lineTo(391,540).stroke(),t.strokeColor("#000000").moveTo(417,$-8).lineWidth(1).lineTo(417,540).stroke(),t.strokeColor("#000000").moveTo(463,$-8).lineWidth(1).lineTo(463,540).stroke(),T?t.strokeColor("#000000").moveTo(515,$-8).lineWidth(1).lineTo(515,540).stroke():(t.strokeColor("#000000").moveTo(490,$-8).lineWidth(1).lineTo(490,540).stroke(),t.strokeColor("#000000").moveTo(517,$-8).lineWidth(1).lineTo(517,540).stroke())})),function(t,e,n,a){let d=m(e,"SGST",0).toFixed(2),o=m(e,"CGST",0).toFixed(2),c=m(e,"IGST",0).toFixed(2),u=m(e,"SGST",5).toFixed(2),v=m(e,"CGST",5).toFixed(2),h=m(e,"IGST",5).toFixed(2),w=m(e,"SGST",12).toFixed(2),$=m(e,"CGST",12).toFixed(2),b=m(e,"IGST",12).toFixed(2),T=m(e,"SGST",18).toFixed(2),S=m(e,"CGST",18).toFixed(2),Y=m(e,"IGST",18).toFixed(2),E=m(e,"SGST",28).toFixed(2),k=m(e,"CGST",28).toFixed(2),x=m(e,"IGST",28).toFixed(2),A=+d/2+ +o/2+ +c,q=+u/2+ +v/2+ +h,C=+w/2+ +$/2+ +b,D=+T/2+ +S/2+ +Y,N=+E/2+ +k/2+ +x,I=p(e,0).toFixed(2),P=p(e,5).toFixed(2),M=p(e,12).toFixed(2),R=p(e,18).toFixed(2),O=p(e,28).toFixed(2),H=y(e,0).toFixed(2),F=y(e,5).toFixed(2),L=y(e,12).toFixed(2),j=y(e,18).toFixed(2),U=y(e,28).toFixed(2),G=f(e,0).toFixed(2),B=f(e,5).toFixed(2),K=f(e,12).toFixed(2),W=f(e,18).toFixed(2),z=f(e,28).toFixed(2),V=+H+ +F+ +L+ +j+ +U,Z=+I+ +P+ +M+ +R+ +O,Q=+G+ +B+ +K+ +W+ +z,J=+d/2+ +u/2+ +w/2+ +T/2+ +E/2,X=+o/2+ +v/2+ +$/2+ +S/2+ +k/2,tt=+c+ +h+ +b+ +Y+ +x,et=+G+ +B+ +K+ +W+ +z,nt=539;_(t,s,i,nt),t.font("Helvetica-Bold"),l(t,549,"CLASS","SUB TOTAL","DISC","AMOUNT","SGST","CGST","GST","TOTAL",n,"IGST"),t.font("Helvetica"),l(t,564,"GST 5%",B,P,F,u,v,q,B,n,h),l(t,579,"GST 12%",K,M,L,w,$,C,K,n,b),l(t,594,"GST 18%",W,R,j,T,S,D,W,n,S),l(t,609,"GST 28%",z,O,U,E,k,N,z,n,k),l(t,624,"GST 0%",G,I,H,d,o,A,G,n,o),_(t,s,i,636),t.font("Helvetica-Bold"),l(t,644,"TOTAL",Q,Z,V,2*J,2*X,J+X+tt,et,n,tt),t.font("Helvetica"),function(t,e,n,a,r,s,i,d,o,c){t.fillColor("#000000"),t.fontSize(9).font("Helvetica-Bold").text("SUB TOTAL",450,e,{width:70,align:"left"}).font("Helvetica").text((+n+ +a).toFixed(2),500,e,{width:70,align:"right"}).text("DISCOUNT",450,564,{width:70,align:"left"}).text((+a).toFixed(2),500,564,{width:70,align:"right"}),d?d&&t.text("IGST",450,579,{width:70,align:"left"}).text((+o).toFixed(2),500,579,{width:70,align:"right"}):t.text("SGST",450,579,{width:70,align:"left"}).text((+r/2).toFixed(2),500,579,{width:70,align:"right"}).text("CGST",450,594,{width:70,align:"left"}).text((+s/2).toFixed(2),500,594,{width:70,align:"right"}),t.text("Misc.",450,609,{width:70,align:"left"}).text((+(+c.transport_charges+ +c.unloading_charges+ +c.misc_charges)).toFixed(2),500,609,{width:70,align:"right"});let u=+(+i+ +c.transport_charges+ +c.unloading_charges+ +c.misc_charges);t.text("ROUNDED OFF",450,624,{width:70,align:"left"}).text((g(u,"rounding")-g(u,"withoutrounding")).toFixed(2),500,624,{width:70,align:"right"}),t.font("Helvetica-Bold"),t.text("TOTAL",450,644,{width:70,align:"left"}).text(g(u,"rounding").toLocaleString("en-IN")+".00",500,644,{width:70,align:"right"}).font("Helvetica")}(t,549,Q,Z,2*J,2*X,et,n,tt,a),_(t,s,i,659),function(t,e,n){t.font("Helvetica-Bold"),t.fontSize(9).text(r(g(e,"rounding")),24,664,{align:"left"}),t.font("Helvetica")}(t,et),_(t,s,i,676)}(t,n,T,e)}(k,Y,E,T,t,S,b),function(t,e){let n=680;t.fontSize(8).text("Terms & Conditions:",24,n).text("Goods once sold will not be taken back or exchanged.",{lineGap:1.8}).text("Bills not paid due date will attract 24% interest.",{lineGap:1.8}).text("All disputes subject to Jurisdication only.",{lineGap:1.8}).text("Prescribed Sales Tax declaration will be given.",{lineGap:1.8}),t.strokeColor("#000000").lineWidth(1).moveTo(24,734).lineTo(280,734).stroke(),t.fontSize(8).text("Certified that the particulars given above are true and correct",24,740,{lineGap:1.8}).text("and the amount indicated represents the price actually charged.",24,750,{lineGap:1.8}),t.fontSize(8).font("Helvetica-Bold").text("OUR BANK        : "+e.bankname,320,n,{lineGap:1.8}).text("A/C NAME          : "+e.accountname,320,690,{lineGap:1.8}).text("A/C NO               : "+e.accountno,320,700,{lineGap:1.8}),t.font("Times-BoldItalic"),t.fontSize(6).text(`Plz pay Cash/Cheque/DD in favour of '${e.accountname}'.`,320,710,{lineGap:1.4}),t.fontSize(7).text("For    "+e.accountname,400,720),t.fontSize(7).text("Authorised signatory",400,755),t.fontSize(8).text("Software By: 97316 16386",250,758)}(k,T)})),k.end(),k.pipe(w)}}},9322:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(366),n(2470),n(4026),n(8005)),{getInquirySummary:i,getSalesSummary:d,getPurchaseSummary:o,getSaleTotal:c,getCenterSummary:u,getReceivablesOutstanding:l,getPaymentsByCustomers:_,topClients:m}=n(4808);n(3076),a.post("/inquiry-summary",((t,e)=>{const[n,a,d]=Object.values(t.body);i(n,a,d,((t,n)=>t?r(new s("500","/inquiry-summary",t),e):e.status(200).json(n)))})),a.post("/sales-summary",((t,e)=>{const[n,a,i]=Object.values(t.body);d(n,a,i,((t,n)=>t?r(new s("500","/sales-summary",t),e):e.status(200).json(n)))})),a.post("/purchase-summary",((t,e)=>{const[n,a,i]=Object.values(t.body);o(n,a,i,((t,n)=>t?r(new s("500","/purchase-summary",t),e):e.status(200).json(n)))})),a.post("/sales-total",((t,e)=>{const[n,a,i]=Object.values(t.body);c(n,a,i,((t,n)=>t?r(new s("500","/sales-total",t),e):e.status(200).json(n)))})),a.post("/center-summary",((t,e)=>{const[n,a,i]=Object.values(t.body);u(n,a,i,((t,n)=>t?r(new s("500","/center-summary",t),e):e.status(200).json(n)))})),a.post("/center-receivables-summary",((t,e)=>{const[n,a,i]=Object.values(t.body);l(n,a,i,((t,n)=>t?r(new s("500","/center-receivables-summary",t),e):e.status(200).json(n)))})),a.post("/payments-customers",((t,e)=>{const[n,a,i]=Object.values(t.body);_(n,a,i,((t,n)=>t?r(new s("500","/payments-customers",t),e):e.status(200).json(n)))})),a.post("/get-top-clients",(async(t,e)=>{let n=await m(t.body.center_id,t.body.limit);return e.status(200).json(n)})),t.exports=a},8944:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=n(8005),{toTimeZone:i,currentTimeInTimeZone:d}=n(8372);var o=n(3076);n(2470),n(4026);const{insertEnquiryDetail:c,fetchEnquiryDetailByEnqId:u,fetchCustomerDetailsByEnqId:l,updateEnquiryDetail:_,insertBackOrder:m,updateEnquiry:p,getSuccessfullyProcessedItems:y}=n(7558);a.post("/draft-enquiry",((t,e)=>{let n=t.body;Object.keys(n).forEach((function(t){var a=n[t];let i=`update enquiry set estatus = 'D' where id = '${a.enquiry_id}' `;o.query(i,(function(t,n){if(t)return r(new s("500","/draft-enquiry update enquiry",t),e)}));let d=`update enquiry_detail\n\t\tset\n\t\tproduct_id = '${a.product_id}',\n\t\tstock_id = ${a.stockid},\n\t\tgiveqty = '${a.giveqty}',\n\t\tprocessed = '${a.processed}',\n\t\tstatus = 'D'\n\t\twhere id = '${a.id}' `,c=`update enquiry_detail\n\t\t\tset\n\t\t\tproduct_id = null,\n\t\t\tstock_id = null,\n\t\t\tgiveqty = '${a.giveqty}',\n\t\t\tprocessed = '${a.processed}',\n\t\t\tstatus = 'D'\n\t\t\twhere id = '${a.id}' `,u=null===a.product_id?c:d;o.query(u,(function(t,n){if(t)return r(new s("500","/draft-enquiry update enquiry_detail",t),e)}))})),e.json({result:"success"})})),a.post("/move-to-sale",(async(t,e)=>{let n=t.body.enquries,a=t.body.userid,r=new Date,s=new Date;r=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),s=d("Asia/Kolkata","DD-MM-YYYY");var i=Object.keys(n);let o=1;i.forEach((async(t,r)=>{var s=n[t];if(""===s.product_id||null===s.product_id)await _("","","0","","B",s.id,a,e),await m(s.center_id,s.customer_id,s.id,s.askqty,"Product Code Not found","O",a,e);else if(s.askqty>s.giveqty&&0===s.giveqty){const t=s.askqty-s.giveqty;await _(s.product_id,s.stockid,"0",s.processed,"B",s.id,a,e),await m(s.center_id,s.customer_id,s.id,t,"Zero Quantity Alloted","O",a,e)}else if(s.askqty>s.giveqty&&0!==s.giveqty){const t=s.askqty-s.giveqty;await _(s.product_id,s.stockid,s.giveqty,s.processed,"P",s.id,a,e),await m(s.center_id,s.customer_id,s.id,t,"Partial fullfillmeent","O",a,e)}else s.giveqty>=s.askqty&&""!==s.product_id&&null!==s.product_id&&await _(s.product_id,s.stockid,s.giveqty,s.processed,"F",s.id,a,e);i.length===o&&f(n,a,e),o+=1}))}));const f=async(t,e,n)=>{let a="";a=0===await y(t[0].enquiry_id)?await p("E",t[0].enquiry_id,e,n):await p("P",t[0].enquiry_id,e,n),"success"===a?n.json({result:"success"}):n.json({result:"failure"})};a.post("/update-giveqty-enquiry-details",((t,e)=>{let n=`update enquiry_detail\n\tset\n\tgiveqty = '${t.body.giveqty}'\n\twhere id = '${t.body.enqdetailid}' `;o.query(n,(function(t,n){if(t)return r(new s("500","Error Updating enquiry details move to sale.",t),e)}))})),a.get("/update-customer/:id/:enqid",((t,e)=>{let n=t.params.id,a=t.params.enqid,i=`update enquiry\n\tset\n\tcustomer_id = '${n}'\n\twhere id = '${a}' `;o.query(i,(function(t,i){if(t)return r(new s("500",`/update-customer/:id/:enqid ${n} ${a}`,t),e);e.json({result:"success"})}))})),a.post("/update-status-enquiry-details",((t,e)=>{let n=t.body.status,a=t.body.enqdetailid;if("B"===n){let t=`update enquiry_detail\n\t\tset\n\t\tproduct_id = null,\n\t\tstatus = '${n}'\n\t\twhere id = '${a}' `;o.query(t,(function(t,i){if(t)return r(new s("500",`/update-status-enquiry-details ${n} ${a}`,t),e)}))}})),a.post("/update-enquiry-details",((t,e)=>{let n=t.body;Object.keys(n).forEach((function(t){n[t]}))})),a.post("/insert-enquiry-details",((t,e)=>{let n=t.body;var a=new Date;let i=0;a=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let u=`INSERT INTO enquiry ( center_id, customer_id, enquiry_date, estatus, remarks) \n\t\t\t\t\t\t\tvalues ( '${n.center_id}', '${n.customerctrl.id}', '${a}', 'O','${n.remarks}')`;o.query(u,(async function(t,a){if(t)return r(new s("500","error /insert-enquiry-details insert enquiry..step1..",t),e);{let t=a.insertId;const d=n.productarr;for(const a of d)await c(a,n,t,((t,n)=>{if(t)return t.message,r(new s("500","/insert-enquiry-details",t),e);n.insertId})),i++,i===d.length&&e.json({result:"success"})}}))})),a.post("/add-more-enquiry-details",((t,e)=>{let n=t.body;new Date,d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let a=`INSERT INTO enquiry_detail ( enquiry_id, product_id, askqty, product_code, notes, status)\n\t\t\t\t\t\t\tvalues ( '${n.enquiry_id}', \n\t\t\t\t\t\t\t(select id from product where product_code='${n.product_code}' \n\t\t\t\t\t\t\tand center_id = '${n.center_id}'), \n\t\t\t\t\t\t\t'${n.askqty}', '${n.product_code}', '${n.notes}', 'O')`;o.query(a,(function(t,n){if(t)return r(new s("500","/add-more-enquiry-details",t),e);e.json({result:n.insertId})}))})),a.get("/open-enquiries/:centerid/:status",((t,e)=>{let n=t.params.centerid,a=t.params.status,i=`select e.id, e.enquiry_date, e.estatus, c.name as custname,\n  \n\t(select count(*) from enquiry_detail where enquiry_id = e.id)\n\tas noofitems\n\tfrom enquiry e, customer c\n\twhere \n\t\te.customer_id = c.id and\n\testatus = '${a}' and e.center_id = '${n}'\n\torder by \n\tenquiry_date desc`;o.query(i,(function(t,i){return t?r(new s("500",`/open-enquiries/:centerid/:status ${n} ${a}`,t),e):e.json(i)}))})),a.get("/get-enquiry-details/:enqid",(async(t,e)=>{let n,a,i=t.params.enqid;return await u(i,((t,a)=>{if(t)return t.message,r(new s("500",`/get-enquiry-details/:enqid ${i}`,t),e);n=a})),await l(i,((t,n)=>{if(t)return t.message,r(new s("500",`/get-enquiry-details/:enqid ${i} fetchCustomerDetailsByEnqId .`,t),e);a=n})),e.json({enquiryDetails:n,customerDetails:a})})),a.get("/get-enquiry-master/:enqid",((t,e)=>{let n=t.params.enqid,a=`\n\tselect \n\te.id as enqid,\n\te.enquiry_date as enquiry_date,\n\te.estatus as estatus,\n\te.sale_id as sale_id,\n\te.processed_date as processed_date,\n\tc.id as customer_id,\n\t c.name as customer_name,\n\t c.address1 as address1,\n\t c.address2 as address2,\n\t c.address3 as address3,\n\t c.gst as gst,\n\t c.mobile as mobile,\n\t c.credit_amt,\n\t csa.address1 as csa_address1,\n\t csa.address2 as csa_address2\n\tfrom enquiry e,\n\tcustomer c,\n\tcustomer_shipping_address csa\n\twhere \n\tc.id = e.customer_id and\n\tcsa.customer_id = c.id and\n\te.id = ${n}\t\n\n\t`;o.query(a,(function(t,a){return t?r(new s("500",`/get-enquiry-master/:enqid ${n}`,t),e):e.json(a)}))})),a.get("/get-customer-data/:enqid",((t,e)=>{let n=t.params.enqid,a=`select c.*, s.code \n\tfrom\n\tcustomer c,\n\tenquiry e,\n\tstate s\n\twhere\n\te.customer_id = c.id and\n\ts.id = c.state_id and\n\te.id = ${n}\n\t`;o.query(a,(function(t,a){return t?r(new s("500",`/get-customer-data/:enqid ${n}`,t),e):e.json(a)}))})),a.get("/get-enquired-product-data/:centerid/:customerid/:enqid/:invdt",((t,e)=>{let n=t.params.centerid,a=t.params.customerid,i=t.params.enqid,d=t.params.invdt,c=`select a.product_code as product_code, a.description, a.mrp, a.taxrate, b.available_stock,\n\ted.giveqty as qty, a.unit_price, a.id as product_id, b.id as stock_pk, e.enquiry_date,\n\tIFNULL(\n\t(\n\tselect concat(value,'~',type)\n\tfrom discount\n\twhere str_to_date('${d}','%d-%m-%Y')  \n\tbetween str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') and\n  customer_id = '${a}' and\n\tgst_slab = a.taxrate and\n\ta.brand_id = discount.brand_id and\n  discount.brand_id = a.brand_id\n\t), \n\t\n\t(  select concat(value,'~',type) \nfrom discount \nwhere str_to_date('${d}','%d-%m-%Y')  \nbetween str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') and\ncustomer_id = '${a}' and\ngst_slab = a.taxrate and\ndiscount.brand_id = 0 )\n\t\n\t) as disc_info\n\t\n\t\n\tfrom \n\tenquiry e,\n\tenquiry_detail ed,\n\tproduct a, \n\tstock b\n\twhere\n\te.id = ed.enquiry_id and\n\ted.product_id = a.id and\n\ta.id = b.product_id and\n\tb.id = ed.stock_id and\n\ted.status in ('P', 'F')  and\n\ted.giveqty != 0 and\n\te.id = ${i}\n\t`;o.query(c,(function(t,d){return t?r(new s("500",`/get-enquired-product-data/:centerid/:customerid/:enqid/:invdt ${n} ${a} ${i} ${invdt}`,t),e):e.json(d)}))})),a.get("/back-order/:centerid",((t,e)=>{let n=t.params.centerid,a=`SELECT c.name as customer_name, p.product_code as product_code, p.id as product_id,\n\tp.description as description, ed.notes, ed.askqty, ed.giveqty, b.reason, b.order_date, s.available_stock\n\tFROM \n\tbackorder b, \n\tenquiry_detail ed,\n\tproduct p,\n\tstock s, customer c\n\tWHERE \n\ts.product_id = p.id and c.id = b.customer_id and\n\tb.enquiry_detail_id = ed.id and\n\tp.id = ed.product_id and\n\tb.center_id = '${n}' and\n\tstr_to_date(order_date, '%d-%m-%YYYY') BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()\n\tunion all\n\tSELECT c.name as customer_name, "N/A" as product_code, "N/A" as product_id, "N/A" as description, ed.notes, ed.askqty, ed.giveqty, b.reason, \n\tb.order_date, "N/A" as available_stock FROM \n\tbackorder b, customer c,\n\tenquiry_detail ed\n\tWHERE \n\tb.enquiry_detail_id = ed.id and\n\tc.id = b.customer_id and\n\ted.product_id is null and\n\tb.center_id = '${n}' and\n\tstr_to_date(order_date, '%d-%m-%YYYY') BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW();\n\t`;o.query(a,(function(t,a){return t?r(new s("500",`/back-order/:centerid ${n}`,t),e):e.json(a)}))})),a.post("/search-enquiries",((t,e)=>{let n=t.body.centerid,a=t.body.status,d=t.body.customerid,c=t.body.fromdate,u=t.body.todate,l=t.body.order;""!==c&&(c=i(t.body.fromdate,"Asia/Kolkata")),""!==u&&(u=i(t.body.todate,"Asia/Kolkata"));let _=`select\n\te.id as id,\n\te.center_id as center_id,\n\te.customer_id as customer_id,\n\tCAST(e.enquiry_date AS CHAR) as enquiry_date,\n\te.estatus as estatus,\n\te.remarks as remarks,\n\te.sale_id as sale_id,\n\te.processed_date as processed_date,\n\tc.id as customer_id, c.name as customer_name,\n    \tcase e.estatus\n\t\t\t\twhen 'O' then 'New'\n\t\t\t\twhen 'D' then 'Draft'\n\t\t\t\twhen 'E' then 'Executed'\n\t\t\t\twhen 'P' then 'Invoice Ready'\n\t\t\t\twhen 'C' then 'Completed'\n\t\t\t\twhen 'X' then 'Cancelled'\n    end as status_txt,\n\t(select count(*) from enquiry_detail where enquiry_id = e.id)\n\tas noofitems\n\tfrom\n\tenquiry e,\n\tcustomer c\n\twhere\n\tc.id = e.customer_id and\n\n\te.center_id =  '${n}' and\n\tstr_to_date(DATE_FORMAT(enquiry_date,'%d-%m-%YYYY') , '%d-%m-%YYYY') between\n\tstr_to_date('${c}', '%d-%m-%YYYY') and\n\tstr_to_date('${u}', '%d-%m-%YYYY')  `;"all"!==d&&(_+=`and e.customer_id = '${d}' `),"all"!==a&&(_+=` and e.estatus =  '${a}' `),_+=`order by enquiry_date ${l} `,o.query(_,(function(t,n){return t?r(new s("500","/search-enquiries",t),e):e.json(n)}))})),a.post("/delete-enquiry-details",(async(t,e)=>{let n=t.body.id,a=t.body.enquiry_id,i=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),c=`\n\tINSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn, old_value, new_value, audit_date, center_id)\n\tVALUES\n\t\t('Enquiry', '${a}', '${n}', 'delete', \n\t\t(SELECT CONCAT('[{', result, '}]') as final\n\t\tFROM (\n\t\t\tSELECT GROUP_CONCAT(CONCAT_WS(',', CONCAT('"saleId": ', enquiry_id), CONCAT('"productId": "', product_id, '"'), CONCAT('"askqty": "', askqty, '"')) SEPARATOR '},{') as result\n\t\t\tFROM (\n\t\t\t\tSELECT enquiry_id, product_id, askqty, notes\n\t\t\t\tFROM enquiry_detail where id = '${n}'\n\t\t\t) t1\n\t\t) t2)\n\t\t, '', '${i}', (select center_id from enquiry where id = '${a}')\n\t\t) `;return await new Promise((function(t,n){o.query(c,(function(a,i){if(a)return n(r(new s("500","/delete-enquiry-details",a),e));t(i)}))})),await new Promise((function(t,a){let i=`\n\t\t\tdelete from enquiry_detail where id = '${n}' `;o.query(i,(function(n,i){if(n)return a(r(new s("500","/delete-enquiry-details",n),e));t(i)}))})),e.json({result:"success"})})),t.exports=a},578:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(2376),n(366),n(2470),n(4026),n(8005));n(3076);const i=n(6356);n(5747),a.get("/sample-xls",((t,e)=>{console.log("insdie sample xls");const n=i.readFile("./upload/Data.xlsx").Sheets.products,a=i.utils.sheet_to_json(n);console.log(a)})),t.exports=a},2154:(t,e,n)=>{const a=n(2127).Router(),r=n(2376),{handleError:s,ErrorHandler:i}=(n(366),n(2470),n(4026),n(8005)),{getSearchCustomers:d}=n(8361),{getSearchVendors:o}=n(8647),{createInvoice:c}=n(1701);var u=n(3076);const{getAllBrands:l,getBrandsMissingDiscountsByCustomer:_,getSearchBrands:m}=n(3269),p={shipping:{name:"John Doe",address:"1234 Main Street",city:"San Francisco",state:"CA",country:"US",postal_code:94111},items:[{item:"TC 100",description:"Toner Cartridge",quantity:2,amount:6e3},{item:"USB_EXT",description:"USB Cable Extender",quantity:1,amount:2e3}],subtotal:8e3,paid:0,invoice_nr:1234};a.get("/sample-pdf",((t,e)=>{c(p,"invoice.pdf",e)})),a.post("/search-product-information",((t,e)=>{const[n,a,r,d]=Object.values(t.body);let o=` select a.product_code as product_code, a.description, b.mrp, a.taxrate, b.available_stock,\n\ta.packetsize as qty, a.unit_price, a.id as product_id, b.id as stock_pk, a.rackno,\nIFNULL(\n(\nselect concat(value,'~',type) \nfrom discount \nwhere str_to_date('${r}','%d-%m-%Y')  \nbetween str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') and\ncustomer_id = '${a}' and\ngst_slab = a.taxrate and\na.brand_id = discount.brand_id and\ndiscount.brand_id = a.brand_id\n), \n(  select concat(value,'~',type) \nfrom discount \nwhere str_to_date('${r}','%d-%m-%Y')  \nbetween str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') and\ncustomer_id = '${a}' and\ngst_slab = a.taxrate and\ndiscount.brand_id = 0 )\n\t\n\t) as disc_info,\n\tbrand.name as name\nfrom \nproduct a, \nstock b,\nbrand\nwhere \nbrand.id = a.brand_id and \na.id = b.product_id and\na.center_id = '${n}' and\n( a.product_code like '%${d}%' or\na.description like '%${d}%' ) limit 50 \n`;u.query(o,(function(t,n){return t?s(new i("500","/search-product-information",t),e):e.json(n)}))})),a.post("/search-product",((t,e)=>{const[n,a,r]=Object.values(t.body);let d="";d=`\n\tselect a.product_code as product_code, \n  \t\ta.description, \n  \t\ta.mrp, \n  \t\ta.taxrate, \n  \t\t(select sum(s2.available_stock) from stock s2 where s2.product_id = a.id ) as available_stock, \n\t\t\tIFNULL((\t\tselect stock_level from item_history ih \n\t\t\t\twhere ih.product_ref_id = a.id order by ih.id desc limit 1), 0) as true_stock,\n  \t\ta.packetsize, a.unit_price, a.purchase_price as purchase_price, a.id as product_id, \n\t\t\n\t\ta.packetsize as qty, \n\t\ta.rackno, \n\t\tbd.name,\n\t\tbd.id as brand_id, \n\t\ta.unit as uom, \n\t\ta.hsncode as hsncode, \n\t\ta.minqty as minqty, \n\t\ta.avgpurprice as avgpurprice,\n\t\ta.unit_price as unit_price, \n\t\ta.salesprice as salesprice,  \n\t\ta.maxdiscount as maxdiscount, \n\t\ta.currentstock as currentstock\n\t\tfrom \n\t\tbrand bd,\n\t\tproduct a\n\n\t\twhere \n\t\ta.center_id = '${n}' and\n\t\ta.brand_id = bd.id and\n\t\t( a.product_code like '%${a}%' or\n\t\ta.description like '%${a}%' ) limit 50\n\t`,u.query(d,(function(t,n){return t?s(new i("500","/search-product",t),e):e.status(200).json(n)}))})),a.post("/search-customer",((t,e)=>{const[n,a]=Object.values(t.body);d(n,a,((t,n)=>t?s(new i("500","/search-customer",t),e):e.status(200).json(n)))})),a.post("/search-vendor",((t,e)=>{const[n,a]=Object.values(t.body);o(n,a,((t,n)=>t?s(new i("500","/search-vendor",t),e):e.status(200).json(n)))})),a.post("/search-brand",(async(t,e)=>{const[n,a]=Object.values(t.body);let r=await m(n,a);return e.status(200).json(r)})),a.get("/inventory/all",((t,e)=>{u.query("select p.product_code, p.description, p.mrp, s.available_stock\n  from product p, \n       stock s \n  where p.product_code= s.product_code",(function(t,n){return t?s(new i("500","/inventory/all",t),e):e.json(n)}))})),a.get("/all-clients",((t,e)=>{u.query("select * from customer where isactive = 'A'",(function(t,n){return t?s(new i("500","/all-clients",t),e):e.json(n)}))})),a.get("/all-active-vendors/:centerid",((t,e)=>{let n=t.params.centerid,a=`select v.id, v.center_id, v.name, v.address1, v.address2, v.address3, v.district, s.id as state_id, s.code, s.description as state,\n\tv.pin, v.gst, v.phone, v.mobile, v.mobile2, v.whatsapp, v.email, v.isactive, v.credit_amt,\n\tv.balance_amt, \n\tDATE_FORMAT(v.last_paid_date, '%d-%b-%Y') as last_paid_date\n\tfrom \n\tvendor v,\n\tstate s\n\twhere \n\tv.state_id = s.id and isactive = 'A' and center_id = ${n} order by v.name`;u.query(a,(function(t,a){if(t)return s(new i("500",`/all-active-vendors/:centerid ${n}`,t),e);e.json(a)}))})),a.get("/all-active-brands/:centerid/:status",((t,e)=>{l(t.params.centerid,t.params.status,((n,a)=>n?s(new i("500",`/all-active-brands/:centerid/:status ${t.params.centerid} ${t.params.status}`,n),e):e.json(a)))})),a.get("/vendor-exists/:name/:center_id",((t,e)=>{let n=t.params.name,a=t.params.center_id,r=`select * from vendor v where \n\tv.name = '${n}' and center_id = '${a}' `;u.query(r,(function(t,r){return t?s(new i("500",`/vendor-exists/:name/:center_id ${n} ${a}`,t),e):e.status(200).json({result:r})}))})),a.get("/brand-exists/:name/:center_id",((t,e)=>{let n=t.params.name,a=t.params.center_id,r=`select * from brand b where \n\tb.name = '${n}' and b.center_id = '${a}' `;u.query(r,(function(t,r){return t?s(new i("500",`/brand-exists/:name/:center_id ${n} ${a}`,t),e):e.status(200).json({result:r})}))})),a.get("/customer-exists/:name/:centerid",((t,e)=>{let n=t.params.name,a=t.params.centerid,r=`select * from customer c where \n\tc.name = '${n}' and center_id = ${a} `;u.query(r,(function(t,r){return t?s(new i("500",`/customer-exists/:name ${n} ${a}`,t),e):e.status(200).json({result:r})}))})),a.get("/brand-delete/:id",((t,e)=>{let n=t.params.id,a=`update brand set isactive = 'D' where id = '${n}' `;u.query(a,(function(t,a){return t?s(new i("500",`/brand-delete/:id ${n}`,t),e):e.status(200).json({result:a})}))})),a.get("/enquiry-delete/:id",((t,e)=>{let n=t.params.id,a=`update enquiry set estatus = 'X' where id = '${n}' `;u.query(a,(function(t,a){return t?s(new i("500",`/enquiry-delete/:id ${n}`,t),e):e.status(200).json({result:a})}))})),a.get("/vendor-delete/:id",((t,e)=>{let n=t.params.id,a=`update vendor set isactive = 'D' where id = '${n}' `;u.query(a,(function(t,a){return t?s(new i("500",`/vendor-delete/:id ${n}`,t),e):e.status(200).json({result:a})}))})),a.get("/brands-missing-discounts/:centerid/:status/:customerid",((t,e)=>{_(t.params.centerid,t.params.status,t.params.customerid,((n,a)=>n?s(new i("500",`/brands-missing-discounts/:centerid/:status/:customerid ${t.params.centerid} ${t.params.status} ${t.params.customerid}`,n),e):e.json(a)))})),a.get("/all-active-customers/:centerid",((t,e)=>{let n=t.params.centerid,a=`select c.id, c.center_id, c.name, c.address1, c.address2, c.district, s.id as state_id, s.code, s.description,\n\tc.pin, c.gst, c.phone, c.mobile, c.mobile2, c.whatsapp, c.email, \n\tc.isactive, c.credit_amt as credit_amt, c.balance_amt as balance_amt, \n\tDATE_FORMAT(c.last_paid_date, '%d-%b-%Y') as last_paid_date\n\tfrom \n\tcustomer c,\n\tstate s\n\twhere \n\tc.state_id = s.id and isactive = 'A' and center_id = ${n} \torder by name `;u.query(a,(function(t,a){return t?s(new i("500",`/all-active-customers/:centerid ${n}`,t),e):e.json(a)}))})),a.post("/add-parts-details-enquiry",((t,e)=>{let n=t.body;Object.keys(n).forEach((function(t){var a=n[t];let r=`INSERT INTO enquiry_detail ( enquiry_id, item_code, qty) values ( '${a.enquiryid}','${a.partno}','${a.quantity}')`;u.query(r,(function(t,n){if(t)return s(new i("500","/add-parts-details-enquiry",t),e)}))}))})),t.exports=a,a.get("/get-enquiry/:enquiryid",((t,e)=>{let n=t.params.enquiryid,a=`select * \n  from \n  enquiry_detail ed,\n  enquiry em, \n  parts p\n  where\n  ed.partno = p.partno and\n  em.id = ed.enquiry_id and\n  ed.enquiry_id = ${n}\n  `;u.query(a,(function(t,a){return t?s(new i("500",`/get-enquiry/:enquiryid ${n}`,t),e):e.json(a)}))})),a.get("/get-customer-details/:enquiryid",((t,e)=>{let n=t.params.enquiryid,a=`     select c.*\n  from \n  enquiry em, \ncustomer c\nwhere\nem.customer_id = c.id and\nem.id = ${n}`;u.query(a,(function(t,a){return t?s(new i("404",`/get-customer-details/:enquiryid ${n}`,t),e):e.json(a)}))})),a.post("/update-taxrate",((t,e)=>{let n=`update product \n\tset \n\ttaxrate = '${t.body.taxrate}' \n\twhere id = '${t.body.productid}' `;u.query(n,(function(t,n){if(t)return s(new i("500","/update-taxrate",t),e)}))})),a.get("/purchase/:purchaseid/:status",((t,e)=>{try{let n=t.params.centerid,a=`select c.id, c.center_id, c.name, c.address1, c.address2, c.district, s.code, s.description,\n\tc.pin, c.gst, c.phone, c.mobile, c.mobile2, c.whatsapp, c.email, c.isactive  from \n\tcustomer c,\n\tstate s\n\twhere \n\tc.state_id = s.id and isactive = 'A' and center_id = ${n}`;u.query(a,(function(t,a){if(t)return s(new i("500",`/purchase/:purchaseid/:status ${n}`,t),e);e.json(a)}))}catch(t){return s(new i("500","Error processing request",err),e)}})),a.get("/all-pymt-modes/:center_id/:status",((t,e)=>{let n=`select * from payment_mode where center_id = '${t.params.center_id}' and is_active = '${t.params.status}'`;u.query(n,(function(n,a){return n?s(new i("500",`/all-pymt-modes/:center_id/:status ${t.params.center_id} ${t.params.status}`,n),e):e.json(a)}))})),a.get("/all-meetings",((t,e)=>{r.get("https://api.zoom.us/v2/users/sivadinesh@squapl.com/meetings",{headers:{Authorization:"Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOm51bGwsImlzcyI6ImtFTFlKRWRkUmlPMV93bDc2czFEbkEiLCJleHAiOjE2MjEwNjA4OTIsImlhdCI6MTYyMDQ1NjA5M30.KIcNG45pta74WMsdjchQrrmW1Akb-AGT06-HUvrSQx8"}}).then((t=>{console.log(t.data)})).catch((t=>{console.error(t)}))})),a.post("/create-meeting",((t,e)=>{r.post("https://api.zoom.us/v2/users/sivadinesh@squapl.com/meetings",{topic:"TestMeeting",start_time:"2021-06-05T18:00:00Z",type:3,duration:20,timezone:"Asia/Calcutta",agenda:"TestingtheUrl"},{headers:{Authorization:"Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOm51bGwsImlzcyI6ImtFTFlKRWRkUmlPMV93bDc2czFEbkEiLCJleHAiOjE2MjEwNjA4OTIsImlhdCI6MTYyMDQ1NjA5M30.KIcNG45pta74WMsdjchQrrmW1Akb-AGT06-HUvrSQx8"}}).then((t=>{console.log(t.data)})).catch((t=>{console.error(t)}))}))},9303:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(366),n(2470),n(4026),n(8005)),{getSalesMaster:i,getSalesMaster1:d,getSalesDetails:o}=n(5241),{getCenterDetails:c}=n(9057),{getCustomerDetails:u}=n(8361),{createInvoice:l}=n(1701),{createEstimate:_}=n(5425),{createCreditNote:m}=n(3320),{printSaleInvoice:p}=n(7590),{getSaleReturnDetails:y}=n(5705);a.post("/invoice-pdf",(async(t,e)=>{let n=t.body.sale_id,a=t.body.print_type,r=t.body.print_ship_to,s=await i(n),d=await o(n),_=await u(s[0].center_id,s[0].customer_id),m=await c(s[0].center_id);l(s,d,_,m,"invoice.pdf",e,a,r)})),a.post("/estimate-pdf",(async(t,e)=>{let n=t.body.sale_id,a=t.body.print_type,r=await i(n),s=await o(n),d=await u(r[0].center_id,r[0].customer_id),l=await c(r[0].center_id);_(r,s,d,l,"estimate.pdf",e,a)})),a.post("/credit-note-pdf",(async(t,e)=>{let n=t.body.center_id,a=t.body.sale_return_id,r=t.body.sale_id,s=t.body.credit_note_no,d=await i(r),o=await y(n,a,e),l=await u(d[0].center_id,d[0].customer_id),_=await c(d[0].center_id);m(d,o,l,_,"saleReturnInvoice.pdf",s,e)})),t.exports=a},5568:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(4026),n(366),n(8005));var i=n(3076);const{toTimeZone:d,currentTimeInTimeZone:o}=n(8372),{insertItemHistoryTable:c,updateStock:u,isStockIdExist:l}=n(3127),{addPurchaseLedgerRecord:_,addReversePurchaseLedgerRecord:m,addPurchaseLedgerAfterReversalRecord:p,getPurchaseInvoiceByCenter:y}=n(1502);function f(t){let e=0;"C"===t.status&&0===t.revision?e=1:"C"===t.status&&0!==t.revision&&(e=t.revision+1);let n=o("Asia/Kolkata","DD-MM-YYYY HH:mm:ss"),a=""!==t.orderdate?d(t.orderdate,"Asia/Kolkata"):"",r=""!==t.lrdate?d(t.lrdate,"Asia/Kolkata"):"",c=""!==t.orderrcvddt?d(t.orderrcvddt,"Asia/Kolkata"):"",u=`\n\t\t\tINSERT INTO purchase ( center_id, vendor_id, invoice_no, invoice_date, lr_no, lr_date, received_date, \n\t\t\tpurchase_type, order_no, order_date, total_qty, no_of_items, taxable_value, cgst, sgst, igst, \n\t\t\ttotal_value, transport_charges, unloading_charges, misc_charges, net_total, no_of_boxes, status, stock_inwards_datetime, roundoff, revision)\n\t\t\tVALUES\n\t\t\t( '${t.centerid}', '${t.vendorctrl.id}', '${t.invoiceno}', \n\t\t\t\n\t\t\t'${d(t.invoicedate,"Asia/Kolkata")}', \n\t\t\t'${t.lrno}', '${r}', \n\t\t\t'${c}', 'GST Inovoice', '${t.orderno}', '${a}', \n\t\t\t'${t.totalqty}', '${t.noofitems}', '${t.taxable_value}', '${t.cgst}', \n\t\t\t'${t.sgst}', '${t.igst}', '${t.totalvalue}', '${t.transport_charges}', \n\t\t\t'${t.unloading_charges}', '${t.misc_charges}', '${t.net_total}', \n\t\t\t'${t.noofboxes}', '${t.status}' , \n\t\t\t'${o("Asia/Kolkata","DD-MM-YYYY HH:mm:ss")}',\n\t\t\t'${t.roundoff}', '${e}' )`,l=` update purchase set center_id = '${t.centerid}', vendor_id = '${t.vendorctrl.id}',\n\t\t\tinvoice_no = '${t.invoiceno}', \n\t\t\tinvoice_date = '${d(t.invoicedate,"Asia/Kolkata")}', \n\t\t\tlr_no = '${t.lrno}',\n\t\t\tlr_date = '${r}', received_date = '${c}', purchase_type = 'GST Inovoice',\n\t\t\torder_no = '${t.orderno}', order_date = '${a}', total_qty = '${t.totalqty}', \n\t\t\tno_of_items = '${t.noofitems}', taxable_value = '${t.taxable_value}', cgst = '${t.cgst}', \n\t\t\tsgst = '${t.sgst}', igst = '${t.igst}', total_value = '${t.totalvalue}', \n\t\t\ttransport_charges = '${t.transport_charges}', unloading_charges = '${t.unloading_charges}', \n\t\t\tmisc_charges = '${t.misc_charges}', net_total = '${t.net_total}', no_of_boxes = '${t.noofboxes}',\n\t\t\tstatus =  '${t.status}', stock_inwards_datetime =  '${n}', roundoff = '${t.roundoff}',\n\t\t\trevision = '${e}'\n\t\t\twhere id = '${t.purchaseid}' `;return new Promise((function(e,n){i.query(""===t.purchaseid?u:l,(function(a,r){return a?""===t.purchaseid?n(new s("500",`Error Purchase master entry INSERT QRY. ${u}`,a),res):n(new s("500",`Error Purchase master entry UPDATE QRY. ${l}`,a),res):(""===t.purchaseid?newPK=r.insertId:""!=t.purchaseid&&(newPK=t.purchaseid),e(newPK))}))}))}function g(t){todayYYMMDD=o("Asia/Kolkata","YYYY-MM-DD");let e=`\n\tinsert into stock (product_id, mrp, available_stock, open_stock, updateddate)\n\tvalues ('${t.product_id}', '${t.mrp}', '${t.qty}', 0, '${todayYYMMDD}')`;return new Promise((function(t,n){i.query(e,(function(a,r){if(a)return n(new s("500",`Error insertStock in Purchasejs. ${e}`,a),res);t(r.insertId)}))}))}function v(t,e){todayYYMMDD=o("Asia/Kolkata","YYYY-MM-DD");let n=`\n\n\t\t\tupdate purchase_detail set stock_id =  '${e}'\n\t\t\twhere id  = '${t}' `;return new Promise((function(t,e){i.query(n,(function(n,a){if(n)return e(new s("500","Error updatePurchaseDetail in Purchasejs.",n),res);t("purchase_detail_updated")}))}))}a.post("/insert-purchase-details",(async(t,e)=>{const n={...t.body};let a=await f(n);try{!async function(t,e,n){for(const a of t.productarr){let r=` INSERT INTO purchase_detail(purchase_id, product_id, qty, purchase_price, mrp, batchdate, tax,\n\t\t\tigst, cgst, sgst, taxable_value, total_value, stock_id) VALUES\n\t\t\t( '${e}', '${a.product_id}', '${a.qty}', '${a.purchase_price}', '${a.mrp}', \n\t\t\t'${o("Asia/Kolkata","DD-MM-YYYY")}',\n\t\t\t'${a.taxrate}', '${a.igst}', \n\t\t\t'${a.cgst}', '${a.sgst}', '${a.taxable_value}', '${a.total_value}', \n\t\t\t\n\t\t\t(select id from stock where product_id = '${a.product_id}' and mrp = '${a.mrp}' order by id desc limit 1\t)\n\t\t\t)`,d=` update purchase_detail set purchase_id = '${a.purchase_id}', product_id = '${a.product_id}', \n\t\t\tqty = '${a.qty}', purchase_price = '${a.purchase_price}', mrp = '${a.mrp}', \n\t\t\tbatchdate = '${o("Asia/Kolkata","DD-MM-YYYY")}', \n\t\t\ttax = '${a.taxrate}', igst = '${a.igst}', cgst = '${a.cgst}', sgst = '${a.sgst}', \n\t\t\ttaxable_value =  '${a.taxable_value}', total_value = '${a.total_value}', stock_id = '${a.stock_pk}' where\n\t\t\tid = '${a.pur_det_id}' `;await new Promise((function(o,c){i.query(""===a.pur_det_id?r:d,(async function(i,_){if(i)return""===a.pur_det_id?c(new s("500",`Error Purchase process items (update purchase_detail) INSERT QRY. ${r}`,i),n):c(new s("500",`Error Purchase process items (update purchase_detail) UPDATE QRY. ${d}`,i),n);{h(a);let r=""===a.pur_det_id?_.insertId:a.pur_det_id,s=await l(a,n);if("Y"==`${a.mrp_change_flag}`&&0===s){let n=await g(a);await v(r,n),w(a,e,_.insertId,t)}else{let r=a.qty-a.old_val;await u(r,a.product_id,a.mrp,"add",n),w(a,e,_.insertId,t)}o(!0)}}))}))}}(n,a,e),"C"===n.status&&""===n.purchaseid?await _(n,a):"C"===n.status&&""!==n.purchaseid&&(await m(n,a),await p(n,a)),e.json({result:"success",id:a})}catch(t){return r(new s("500","Error purchaseMasterEntry > /insert-purchase-details",t),e)}}));const h=t=>{let e=`\n\nupdate product set purchase_price = '${t.purchase_price}', unit_price = '${t.purchase_price}', mrp = '${t.mrp}'\nwhere id = '${t.product_id}'  `;i.query(e,(function(t,e){t&&console.log("error while inserting updateLatestPurchasePrice "+JSON.stringify(t))}))},w=async(t,e,n,a,r)=>{o("Asia/Kolkata","DD-MM-YYYY HH:mm:ss");let s="Purchase",i=""===t.pur_det_id?n:t.pur_det_id,d=""===t.pur_det_id?t.qty:t.qty-t.old_val,u=""===e?t.purchase_id:e;0===a.revision&&0===d&&(d=t.qty);let l="Purchased";d<0?(l=`Edited: ${t.old_val} To: ${t.qty}`,d=t.old_val-t.qty):d>0&&a.revision>0&&(l=`Edited: ${t.old_val} To: ${t.qty}`,d=t.qty-t.old_val),"Y"===t.mrp_change_flag&&(s=s+" MRP Change - "+t.mrp),0!==d&&await c(a.centerid,s,t.product_id,u,i,"0","0","PUR",l,d,"0","0","0","0",r)};t.exports=a},4074:(t,e,n)=>{const a=n(2127).Router();n(366),n(2470),n(4026);var r=n(3076);const{handleError:s,ErrorHandler:i}=n(8005),{toTimeZone:d,currentTimeInTimeZone:o}=n(8372),{getPurchaseInvoiceByCenter:c,getVendorPymtSequenceNo:u,updateVendorPymtSequenceGenerator:l,getPurchaseInvoiceByVendors:_,addVendorPaymentLedgerRecord:m,addVendorPaymentMaster:p,updateVendorCredit:y,updateVendorCreditMinus:f,updateVendorBalanceAmount:g,updateVendorLastPaidDate:v,getVendorPaymentsByCenter:h,getLedgerByVendors:w,getPaymentsByVendors:$}=n(1502);function b(t,e,n,a){let s=`INSERT INTO vendor_payment_detail(vend_pymt_ref_id, purchase_ref_id, applied_amount) VALUES\n\t\t( '${e}', '${n}', '${a}' )`;new Promise((function(i,d){r.query(s,(function(r,s){r?d(r):(m(t,e,a,n,((t,e)=>{t&&t.message})),i(s))}))}))}function T(t,e,n){n.forEach((n=>{let a=`INSERT INTO vendor_payment_detail(vend_pymt_ref_id, purchase_ref_id, applied_amount) VALUES\n\t\t( '${e}', '${n.id}', '${n.applied_amount}' )`;new Promise((function(s,i){r.query(a,(function(a,r){a?i(a):(m(t,e,n.applied_amount,n.id,((t,e)=>{t&&t.message})),s(r))}))}))}))}a.post("/get-purchase-invoice-center",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.vendorid,u=t.body.searchtype,l=t.body.invoiceno;c(n,a,r,o,u,l,((t,n)=>t?s(new i("500","/get-purchase-invoice-center",t),e):e.status(200).json(n)))})),a.post("/add-vendor-payment-received",(async(t,e)=>{new Date,o("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");const n={...t.body},[a,r,s]=Object.values(t.body);let i=0;for(const t of s){await l(r);let a=await u(n);if(b(n,await p(n,a,t,e),t.purchase_ref_id,t.receivedamount),i==s.length-1)return e.status(200).json("success");i++}})),a.post("/add-bulk-vendor-payment-received",(async(t,e)=>{const n={...t.body},[a,r,s,i,d]=Object.values(t.body);let o=0;for(const a of s){await l(r);let c=await u(n);if(T(n,await p(n,c,a,e),i),o==s.length-1)return"YES"===t.body.creditsused&&f(t.body.creditusedamount,n.centerid,n.vendor.id,((t,e)=>{t&&t.message})),d<0&&y(d,n.centerid,n.vendor.id,((t,e)=>{t&&t.message})),e.status(200).json("success");o++}})),a.post("/get-vendor-payments-center",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.vendorid,c=t.body.searchtype,u=t.body.invoiceno;h(n,a,r,o,c,u,((t,n)=>t?s(new i("500","/get-vendor-payments-center.",t),e):e.status(200).json(n)))})),a.post("/get-purchase-invoice-vendor",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.vendorid,c=t.body.searchtype,u=t.body.invoiceno;_(n,o,a,r,c,u,((t,n)=>t?s(new i("500","Error get-purchase-invoice-vendor getPurchaseInvoiceByVendors",t),e):e.status(200).json(n)))})),a.post("/get-payments-vendor",((t,e)=>{let n=t.body.centerid,a=d(t.body.fromdate,"Asia/Kolkata"),r=d(t.body.todate,"Asia/Kolkata"),o=t.body.vendorid,c=t.body.searchtype,u=t.body.invoiceno;$(n,o,a,r,c,u,((t,n)=>t?s(new i("500","Error /get-payments-vendor getPaymentsByVendors.",t),e):e.status(200).json(n)))})),a.get("/get-pymt-transactions-vendor/:centerid/:vendorid",((t,e)=>{getPymtTransactionByVendors(t.params.centerid,t.params.vendorid,((n,a)=>n?s(new i("500",`/get-pymt-transactions-vendor/:centerid/:vendorid ${t.params.centerid} ${t.params.vendorid}`,n),e):e.status(200).json(a)))})),a.get("/get-ledger-vendor/:centerid/:vendorid",((t,e)=>{w(t.params.centerid,t.params.vendorid,((n,a)=>n?s(new i("500",`/get-ledger-vendor/:centerid/:vendorid ${t.params.centerid} ${t.params.vendorid}`,n),e):e.status(200).json(a)))})),t.exports=a},7808:(t,e,n)=>{const a=n(2127).Router(),{toTimeZone:r,toTimeZoneFrmt:s}=(n(366),n(2470),n(4026),n(8372)),{getProductInventoryReport:i,fullStockReport:d}=n(7393),{getProductSummaryReport:o}=n(8913),{getStatement:c,getVendorStatement:u,getItemWiseSale:l,getReceivablesClosingBalance:_,getReceivablesOpeningBalance:m}=n(428);n(3076),a.post("/full-inventory-report",(async(t,e)=>{const[n,a]=Object.values(t.body);let r=await d(n,a,e);return e.status(200).json(r)})),a.post("/inventory-report",((t,e)=>{const[n,a,r]=Object.values(t.body);i(n,a,r,((t,n)=>t?handleError(new ErrorHandler("500","inventory-report",t),e):e.status(200).json(n)))})),a.post("/product-summary-report",((t,e)=>{const[n,a,r]=Object.values(t.body);o(n,a,r,((t,n)=>t?handleError(new ErrorHandler("500","/product-summary-report",t),e):e.status(200).json(n)))})),a.post("/customer-statement",(async(t,e)=>{const[n,a,r,i,d]=Object.values(t.body);let o=s(r,"Asia/Kolkata","DD-MM-YYYY")+" 00:00:00",u=s(i,"Asia/Kolkata","DD-MM-YYYY")+" 23:59:59",l=await c(n,a,o,u,d);return e.status(200).json(l)})),a.post("/vendor-statement",(async(t,e)=>{const[n,a,r,i]=Object.values(t.body);let d=s(r,"Asia/Kolkata","YYYY-MM-DD")+" 00:00:00",o=s(i,"Asia/Kolkata","YYYY-MM-DD")+" 23:59:59",c=await u(n,a,d,o);return e.status(200).json(c)})),a.post("/customer-closing-balance-statement",(async(t,e)=>{const[n,a,r,i,d]=Object.values(t.body);let o=s(r,"Asia/Kolkata","DD-MM-YYYY")+" 00:00:00",c=s(i,"Asia/Kolkata","DD-MM-YYYY")+" 23:59:59",u=await _(n,a,o,c,d);return e.status(200).json(u)})),a.post("/customer-opening-balance-statement",(async(t,e)=>{const[n,a,r,i,d]=Object.values(t.body);let o=s(r,"Asia/Kolkata","DD-MM-YYYY")+" 00:00:00",c=s(i,"Asia/Kolkata","DD-MM-YYYY")+" 23:59:59",u=await m(n,a,o,c,d);return e.status(200).json(u)})),a.post("/item-wise-sale",(async(t,e)=>{let n=r(t.body.startdate,"Asia/Kolkata")+" 00:00:00",a=r(t.body.enddate,"Asia/Kolkata")+" 23:59:59",s=await l(t.body.center_id,t.body.brandid,n,a,t.body.saletype,t.body.start,t.body.end);return e.status(200).json(s)})),t.exports=a},2882:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(4026),n(8005)),{getReturns:i,saleReturnPaymentMaster:d}=n(7071),{toTimeZone:o,currentTimeInTimeZone:c}=n(8372),{updatePymtSequenceGenerator:u,getPymtSequenceNo:l}=n(5931),{insertSaleReturns:_,insertSaleReturnDetail:m,createCreditNote:p,updateCRAmntToCustomer:y,updateCRSequenceGenerator:f,getSequenceCrNote:g,updateCrNoteIdInSaleReturnTable:v,getSaleReturnDetails:h}=n(5705);n(2470);var w=n(3076);a.get("/get-sale-returns/:center_id",(async(t,e)=>{let n=t.params.center_id,a=await i(n);return e.json(a)})),a.post("/search-sale-return",((t,e)=>{let n=t.body.centerid,a=t.body.customerid,i=t.body.fromdate,d=t.body.todate,c=t.body.searchtype,u=t.body.searchby,l="",_="";if("all"===c){""!==i&&(i=o(t.body.fromdate,"Asia/Kolkata")+" 00:00:00"),""!==d&&(d=o(t.body.todate,"Asia/Kolkata")+" 23:59:00");let e=`and s.customer_id = '${a}' `;l=`select c.name, sr.id as sale_return_id, sr.sale_id as sale_id,  s.invoice_no as invoice_no, s.invoice_date as invoice_date,\n\t\tsr.return_date as return_date,\n\t\tsr.cr_note_id as cr_note_id, cn.credit_note_no, sr.center_id as center_id, sr.to_return_amount as to_return_amount, sr.amount_returned as amount_returned, \n\t\tsr.refund_status as refund_status, \n\t\t(CASE\n\t\t\tWHEN sr.refund_status = 'P' THEN 'Pending'\n\t\t\tWHEN sr.refund_status = 'PR' THEN 'Partially Refunded'\n\t\t\tWHEN sr.refund_status = 'R' THEN 'Refunded'\n\t\t\tEND\n\t\t\t) AS refund_status_x,\n\t\tsr.to_receive_items as to_receive_items, sr.received_items as received_items, \n\t\tsr.receive_status as receive_status, \n\t\t(CASE\n\t\t\tWHEN sr.receive_status = 'R' THEN 'Received'\n\t\t\tWHEN sr.receive_status = 'PR' THEN 'Partially Received'\n\t\t\tWHEN sr.receive_status = 'NR' THEN 'Not Received'\n\t\t\tEND\n\t\t\t) AS receive_status_x,\n\t\tsr.return_status as return_status,\n\t\t(CASE\n\t\t\tWHEN sr.return_status = 'C' THEN 'Close'\n\t\t\tWHEN sr.return_status = 'A' THEN 'Approved'\n\t\t\tEND\n\t\t\t) AS return_status_x\n\t\t\n\t\tfrom \n\t\tsale_return sr\n\t\tLEFT outer JOIN credit_note cn\n\t\t\t\t\tON cn.id = sr.cr_note_id, \n\t\tsale s,\n\t\tcustomer c\n\t\twhere\n\t\tc.id = s.customer_id and\n\t\tsr.sale_id = s.id and\n\t\tsr.center_id = '${n}' and\n\t\t\n\t\t\n\t\t\t\tstr_to_date(sr.return_date,  '%d-%m-%Y %T') between\n\t\t\t\t\t\tstr_to_date('${i}',  '%d-%m-%Y %T') and\n\t\t\t\t\t\tstr_to_date('${d}',  '%d-%m-%Y %T') \n\t\t\t\t\t\t\n\t\t\t\t\t\t `,"all"!==a&&(l+=e),l+=" order by sr.return_date desc "}else"all"!==c&&(_=` \n\t\tselect c.name, sr.id as sale_return_id, sr.sale_id as sale_id, s.invoice_no as invoice_no, s.invoice_date as invoice_date,\n\t\tsr.return_date as return_date,\n\t\tsr.cr_note_id as cr_note_id, cn.credit_note_no, sr.center_id as center_id, sr.to_return_amount as to_return_amount, sr.amount_returned as amount_returned, \n\t\tsr.refund_status as refund_status, \n\t\t(CASE\n\t\t\tWHEN sr.refund_status = 'P' THEN 'Pending'\n\t\t\tWHEN sr.refund_status = 'PR' THEN 'Partially Refunded'\n\t\t\tWHEN sr.refund_status = 'R' THEN 'Refunded'\n\t\t\tEND\n\t\t\t) AS refund_status_x,\n\t\tsr.to_receive_items as to_receive_items, sr.received_items as received_items, \n\t\tsr.receive_status as receive_status, \n\t\t(CASE\n\t\t\tWHEN sr.receive_status = 'R' THEN 'Received'\n\t\t\tWHEN sr.receive_status = 'PR' THEN 'Partially Received'\n\t\t\tEND\n\t\t\t) AS receive_status_x,\n\t\tsr.return_status as return_status,\n\t\t(CASE\n\t\t\tWHEN sr.return_status = 'C' THEN 'Close'\n\t\t\tWHEN sr.return_status = 'A' THEN 'Approved'\n\t\t\tEND\n\t\t\t) AS return_status_x\n\t\t\n\t\tfrom \n\t\tsale_return sr\n\t\tLEFT outer JOIN credit_note cn\n\t\t\t\t\tON cn.id = sr.cr_note_id, \n\t\tsale s,\n\t\tcustomer c\n\t\twhere\n\t\tc.id = s.customer_id and\n\t\tsr.sale_id = s.id and\n\t\tsr.center_id = '${n}' and `,"byinvoice"===c?_+=` s.invoice_no = '${u.trim()}' order by sr.return_date desc `:"bycreditnote"===c&&(_+=` cn.credit_note_no = '${u.trim()}' order by sr.return_date desc `));w.query("all"===c?l:_,(function(t,n){return t?r(new s("500","Error fetching search-sale-return",t),e):e.json(n)}))})),a.get("/get-sale-return-details/:center_id/:salre_return_id",((t,e)=>{let n=t.params.center_id,a=t.params.salre_return_id,r=h(n,a);return e.json(r)})),a.post("/update-sale-returns-received",((t,e)=>{let n=t.body,a=0;for(const t of n){let i=`\t\t\t\n\t\t\t\t\tupdate sale_return_detail T1, sale_return T2\n\t\t\t\t\tset \n\t\t\t\t\tT1.received_qty = T1.received_qty + ${t.received_now},\n\t\t\t\t\tT2.received_items = T2.received_items + ${t.received_now},\n\t\t\t\t\tT2.receive_status = IF(T2.to_receive_items = (T2.received_items + ${t.received_now}), 'R', T2.receive_status),\n\t\t\t\t\tT2.return_status = IF(T2.to_receive_items = (T2.received_items + ${t.received_now}), 'C', T2.return_status)\n\t\t\t\t\twhere \n\t\t\t\t\tT1.sale_return_id = T2.id and\n\t\t\t\t\tT1.id = '${t.id}'\t\t\t\t\n\t\t\t\t\t`;w.query(i,(function(t,n){if(t)return r(new s("500","Error updating update-sale-returns-received",t),e)})),a++,a===n.length&&e.json({result:"success"})}})),a.get("/show-receive-button/:center_id/:sale_return_id",(async(t,e)=>{let n=t.params.center_id,a=t.params.sale_return_id,i=`\n\t\t\tselect count(*) as cnt from sale_return_detail \n\t\t\twhere \n\t\t\treturn_qty > received_qty and  \n\t\t\tsale_return_id = ${a} `;w.query(i,(function(t,i){return t?r(new s("500",`Error /show-receive-button/:center_id/:sale_return_id ${n} ${a} `,t),e):e.json(i)}))})),a.post("/add-sale-return",(async(t,e)=>{var n=new Date;n=c("Asia/Kolkata","DD-MM-YYYY");let a=t.body,r=a[1],s=a[0];const i=await _(r),o=await m(s,i,r,e);f(r.center_id);let y=await g(r.center_id),h=await p(y,r.to_return_amount,"R");v(h,i),await u(r.center_id);let $={centerid:r.center_id,bank_id:0,accountarr:[{receivedamount:r.to_return_amount,receiveddate:n}]},b=await l($),T=await d(r.center_id,r.customer_id,b,r.to_return_amount,"0",n,e),S=await function(t,e,n,a){let r=`INSERT INTO payment_detail(pymt_ref_id, sale_ref_id, sale_return_ref_id, applied_amount) VALUES\n\t\t( '${t}', '${e}', '${n}', '${a}'  )`;return new Promise((function(t,e){w.query(r,(function(n,a){n?e(n):t(a)}))}))}(T.insertId,r.sale_id,i,r.to_return_amount);Promise.all([i,o,y,h,S]).then((t=>e.json("success")))})),t.exports=a},4190:(t,e,n)=>{const a=n(2127).Router(),{handleError:r,ErrorHandler:s}=(n(4026),n(366),n(8005)),{getSalesMaster:i,getSalesDetails:d,IUSaleDetailsAsync:o,insertItemHistoryAsync:c,getNextSaleInvoiceNoAsync:u,insertAuditTblforDeleteSaleDetailsRecAsync:l,deleteSaleDetailsRecAsync:_,updateLegerCustomerChange:m,deleteSaleDetail:p,updatePrintCounter:y,getPrintCounter:f,duplicateInvoiceNoCheck:g}=n(5241),{insertItemHistoryTable:v,updateStockViaId:h}=n(3127),{addSaleLedgerRecord:w,addReverseSaleLedgerRecord:$,addSaleLedgerAfterReversalRecord:b}=n(5931);var T=n(3076);const{toTimeZone:S,currentTimeInTimeZone:Y,toTimeZoneFrmt:E}=n(8372);function k(t){let e="";return"gstinvoice"===t.invoicetype?e=`\n\t\tupdate financialyear set invseq = invseq + 1 where \n\t\tcenter_id = '${t.center_id}' and  \n\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `:"stockissue"===t.invoicetype&&(e=`\t\t\n\tupdate financialyear set \n\tstock_issue_seq = @stock_issue_seq:= stock_issue_seq + 1 where \n center_id = '${t.center_id}' and  \n CURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') LIMIT 1  `),new Promise((function(t,n){T.query(e,(function(e,a){e&&n(e),t(a)}))}))}function x(t){let e="";return"gstinvoice"===t.invoicetype&&"D"!==t.status?e=` select \n\t\tconcat('${Y("Asia/Kolkata","YY")}', "/", \n\t\t'${Y("Asia/Kolkata","MM")}', "/", lpad(invseq, 5, "0")) as invNo from financialyear \n\t\t\t\twhere \n\t\t\t\tcenter_id = '${t.center_id}' and  \n\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `:"gstinvoice"===t.invoicetype&&"D"===t.status?e=` select concat("D/", \n\t\t'${Y("Asia/Kolkata","YY")}', "/", \n\t\t'${Y("Asia/Kolkata","MM")}', "/", lpad(draft_inv_seq, 5, "0")) as invNo from financialyear \n\t\t\t\t\t\t\twhere \n\t\t\t\t\t\t\tcenter_id = '${t.center_id}' and  \n\t\t\t\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `:"stockissue"===t.invoicetype&&(e=` select concat('SI',"-",'${Y("Asia/Kolkata","YY")}', "/", \n\t\t'${Y("Asia/Kolkata","MM")}', "/", lpad(stock_issue_seq, 5, "0")) as invNo from financialyear \n\t\t\t\twhere \n\t\t\t\tcenter_id = '${t.center_id}' and  \n\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `),new Promise((function(t,n){T.query(e,(function(e,a){e&&n(e),t(a[0].invNo)}))}))}a.get("/get-next-sale-invoice-no/:centerid/:invoicetype",((t,e)=>{let n=t.params.centerid,a=t.params.invoicetype;u(n,a).then((t=>e.json(t)))})),a.post("/delete-sales-details",(async(t,e)=>{let n=t.body.center_id,a=t.body.id,i=t.body.salesid,d=t.body.qty,o=t.body.product_id,c=t.body.stock_id,u=t.body.mrp;if(t.body.autidneeded){let t=`\n\t\tINSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn, old_value, new_value, audit_date, center_id)\n\t\tVALUES\n\t\t\t('Sales', '${i}', '${a}', 'delete', \n\t\t\t(SELECT CONCAT('[{', result, '}]') as final\n\t\t\tFROM (\n\t\t\t\tSELECT GROUP_CONCAT(CONCAT_WS(',', CONCAT('"saleId": ', sale_id), CONCAT('"productId": "', product_id, '"'), CONCAT('"qty": "', qty, '"')) SEPARATOR '},{') as result\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT sale_id, product_id, qty\n\t\t\t\t\tFROM sale_detail where id = '${a}'\n\t\t\t\t) t1\n\t\t\t) t2)\n\t\t\t, '', '${Y("Asia/Kolkata","YYYY-MM-DD HH:mm:ss")}', '${n}'\n\t\t\t) `;await new Promise((function(n,a){T.query(t,(function(t,i){if(t)return a(r(new s("500","Error adding sale audit.",t),e));n(i)}))}))}return p(a,e),1===(await h(d,o,c,"add",e)).affectedRows?(await v(n,"Sale",o,"0","0",i,a,"SAL",`Deleted MRP - ${u}`,d,"0","0","0","0",e),e.json({result:"success"})):e.json({result:"failed"})})),a.post("/insert-sale-details",(async(t,e)=>{const n={...t.body};"C"===n.status&&0===n.revision&&"A"===n.inv_gen_mode?await k(n):"D"===n.status&&"A"===n.inv_gen_mode&&void 0!==n.invoiceno&&null!==n.invoiceno&&(n.invoiceno.startsWith("D")||n.invoiceno.startsWith("SI")||await function(t){let e="";return"gstinvoice"===t.invoicetype?e=`\n\t\tupdate financialyear set draft_inv_seq = draft_inv_seq + 1 where \n\t\tcenter_id = '${t.center_id}' and  \n\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `:"stockissue"===t.invoicetype&&(e=`\n\tupdate financialyear set stock_issue_seq = stock_issue_seq + 1 where \n\tcenter_id = '${t.center_id}' and  \n\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `),new Promise((function(t,n){T.query(e,(function(e,a){e&&n(e),t(a)}))}))}(n));let a="";"C"===n.status&&0===n.revision&&"A"===n.inv_gen_mode?a=await x(n):"D"===n.status&&"A"===n.inv_gen_mode?void 0!==n.invoiceno&&null!==n.invoiceno&&(a=n.invoiceno.startsWith("D")||n.invoiceno.startsWith("SI")?n.invoiceno:await x(n)):("C"===n.status&&0!==n.revision||"M"===n.inv_gen_mode)&&(a=n.invoiceno),function(t,e,n){let a=0,i=t.print_count,d=S(t.invoicedate,"Asia/Kolkata");t.invoiceno.startsWith("D")&&"C"===t.status&&0===t.revision&&(d=Y("Asia/Kolkata","DD-MM-YYYY")),"C"===t.status&&0===t.revision?a=1:"C"===t.status&&0!==t.revision&&(a=t.revision+1,i="-1");let o=""!==t.orderdate&&null!==t.orderdate?S(t.orderdate,"Asia/Kolkata"):"",c=(""!==t.lrdate&&null!==t.lrdate&&S(t.lrdate,"Asia/Kolkata"),`\n\t\t\tINSERT INTO sale (center_id, customer_id, invoice_no, invoice_date, order_no, order_date, \n\t\t\tlr_no, lr_date, sale_type,  total_qty, no_of_items, taxable_value, cgst, sgst, igst, \n\t\t\ttotal_value, net_total, transport_charges, unloading_charges, misc_charges, status, \n\t\t\tsale_datetime, roundoff, revision, retail_customer_name, retail_customer_address,retail_customer_phone, inv_gen_mode )\n\t\t\tVALUES\n\t\t\t('${t.center_id}', '${t.customerctrl.id}', \n\t\t\t'${e}',\n\t\t\t'${d}', '${t.orderno}', '${o}', '${t.lrno}', '${t.lrdate}',\n\t '${t.invoicetype}','${t.totalqty}', \n\t\t\t'${t.noofitems}', '${t.taxable_value}', '${t.cgst}', '${t.sgst}', '${t.igst}', '${t.totalvalue}', \n\t\t\t'${t.net_total}', '${t.transport_charges}', '${t.unloading_charges}', '${t.misc_charges}', '${t.status}',\n\t\t\t'${Y("Asia/Kolkata","DD-MM-YYYY HH:mm:ss")}', '${t.roundoff}', '${a}', '${t.retail_customer_name}', '${t.retail_customer_address}', '${t.retail_customer_phone}', '${t.inv_gen_mode}'\n\t\t\t)`),u=`\n\t\t\tUPDATE sale set center_id = '${t.center_id}', customer_id = '${t.customerctrl.id}', \n\t\t\tinvoice_no = '${e}',\n\t\t\tinvoice_date = \t'${d}', \n\t\t\torder_date = '${o}', lr_no = '${t.lrno}', sale_type = '${t.invoicetype}',\n\t\t\tlr_date = '${t.lrdate}', total_qty = '${t.totalqty}', no_of_items = '${t.noofitems}',\n\t\t\ttaxable_value = '${t.taxable_value}', cgst = '${t.cgst}', sgst = '${t.sgst}', igst = '${t.igst}',\n\t\t\ttotal_value = '${t.totalvalue}', net_total = '${t.net_total}', transport_charges = '${t.transport_charges}', \n\t\t\tunloading_charges = '${t.unloading_charges}', misc_charges = '${t.misc_charges}', status = '${t.status}',\n\t\t\tsale_datetime = \t'${Y("Asia/Kolkata","DD-MM-YYYY HH:mm:ss")}', revision = '${a}', roundoff = '${t.roundoff}', \n\t\t\tretail_customer_name = '${t.retail_customer_name}',\n\t\t\tretail_customer_address = '${t.retail_customer_address}',\n\t\t\tretail_customer_phone = '${t.retail_customer_phone}',\n\t\t\tinv_gen_mode = '${t.inv_gen_mode}',\n\t\t\tprint_count= '${i}'\n\t\t\twhere id= '${t.salesid}' `;return new Promise((function(e,a){T.query(""===t.salesid?c:u,(function(a,i){if(a)return r(new s("500",`Error saleMasterEntry Query ${""===t.salesid?c:u} and ERROR: ${a}> `,a),n);e(i)}))}))}(n,a,e).then((async t=>{Date.now(),newPK=""===n.salesid?t.insertId:n.salesid,0!==n.enqref&&null!==n.enqref&&await function(t,e){let n=`update enquiry set \n\testatus = 'E',\n\tsale_id = '${t}'\n\twhere \n\tid =  '${e}' `;return new Promise((function(t,e){T.query(n,(function(n,a){n&&e(n),t(a)}))}))}(newPK,n.enqref),async function(t,e,n){for(const a of t.productarr){let r,s=await o(a),i=a.qty-a.old_val,d=await h(i,a.product_id,a.stock_pk,"minus",n);null==s&&null==s||("C"===t.status||"D"===t.status&&"stockissue"===t.invoicetype)&&(r=await c(a,e,s.insertId,t,n)),Promise.all([s,d,r])}}(n,newPK,e),"C"===n.status&&""===n.salesid?(await w(n,newPK),e.json({result:"success",id:newPK,invoiceno:a})):"C"===n.status&&""!==n.salesid?(await $(n,newPK),await b(n,newPK),n.hasCustomerChange&&m(n.center_id,n.salesid,n.customerctrl.id,n.old_customer_id),e.json({result:"success",id:newPK,invoiceno:a})):e.json({result:"success",id:newPK,invoiceno:a})})).catch((t=>r(new s("500","Error saleMasterEntry > ",t),e)))})),a.post("/convert-sale",(async(t,e)=>{let n=t.body.center_id,a=t.body.sales_id,i=t.body.old_invoice_no,d=t.body.old_stock_issued_date,o=t.body.customer_id,c=t.body.net_total,u=Y("Asia/Kolkata","DD-MM-YYYY");await k({invoicetype:"gstinvoice",center_id:n,invoicedate:u});let l=await x({invoicetype:"gstinvoice",center_id:n,invoicedate:u}),_=` update sale set invoice_no = '${l}', sale_type = "gstinvoice", status = "C", stock_issue_ref = '${i}', revision = '1',\n\tinvoice_date = '${u}', \n\tstock_issue_date_ref =\n\t'${S(d,"Asia/Kolkata")}'\n\t\n\twhere id = ${a} `;T.query(_,(async function(t,i){return t?r(new s("500","Error update sale coverting to sale invoice.",t),e):(await w({center_id:n,customerctrl:{id:o},net_total:c},a),e.status(200).json({result:"success",invoiceNo:l}))}))})),a.get("/delete-sale/:id",(async(t,e)=>{let n=t.params.id,a=await d(n);if("done"===await function(t,e,n){let a=1;if(t.forEach((async(t,r)=>{a=r+1,await l(t,e),await _(t),await h(t.qty,t.product_id,t.stock_id,"add",n)})),t.length===a)return new Promise((function(t,e){t("done")})).catch((()=>{}))}(a,n,e))return e.json({result:"success"})})),a.get("/delete-sale-master/:id",(async(t,e)=>{let n=t.params.id,a=`\n\t\tdelete from sale where \n\tid = '${n}' `;T.query(a,(function(t,a){return t?r(new s("500",`/delete-sale-master/:id ${n}`,t),e):e.json({result:"success"})}))})),a.get("/get-sale-master/:sale_id",(async(t,e)=>{let n=t.params.sale_id,a=await i(n);return e.json(a)})),a.get("/get-sale-details/:sale_id",(async(t,e)=>{let n=t.params.sale_id,a=await d(n);return e.json(a)})),a.get("/update-get-print-counter/:sale_id",(async(t,e)=>{let n=t.params.sale_id,a=(await y(n),await f(n));return e.json(a)})),a.get("/get-print-counter/:sale_id",(async(t,e)=>{let n=t.params.sale_id,a=await f(n);return e.json(a)})),a.post("/duplicate-invoiceno-check",(async(t,e)=>{let n=t.body.invoice_no,a=t.body.center_id,r=await g(n,a);return e.json(r[0].count)})),t.exports=a},9792:(t,e,n)=>{const a=n(2127).Router(),{toTimeZone:r,currentTimeInTimeZone:s}=(n(4026),n(8372)),{handleError:i,ErrorHandler:d}=n(8005);n(366),n(2470);var o=n(3076);const{getSalesMaster:c,getSalesDetails:u}=n(5241),{insertItemHistoryTable:l,updateStockViaId:_,correctStock:m,getProductWithAllMRP:p,deleteProductFromStock:y,updateLatestProductMRP:f}=n(3127);function g(t,e){let n=0;if(t.forEach((async(t,a)=>{n=a+1;let r=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),c=`\n\t\tINSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn, old_value, new_value, audit_date, center_id)\n\t\tVALUES\n\t\t\t('Purchase', '${e}', '${t.id}', 'delete', \n\t\t\t(SELECT CONCAT('[{', result, '}]') as final\n\t\t\tFROM (\n\t\t\t\tSELECT GROUP_CONCAT(CONCAT_WS(',', CONCAT('"purchaseId": ', purchase_id), CONCAT('"productId": "', product_id, '"'), CONCAT('"qty": "', qty, '"')) SEPARATOR '},{') as result\n\t\t\t\tFROM (\n\t\t\t\t\tSELECT purchase_id, product_id, qty\n\t\t\t\t\tFROM purchase_detail where id = '${t.id}'\n\t\t\t\t) t1\n\t\t\t) t2)\n\t\t\t, '', '${r}', (select center_id from sale where id = '${sale_id}')\n\t\t\t) `;await new Promise((function(t,e){o.query(c,(function(n,a){if(n)return e(i(new d("500","Error adding sale audit. deletePurchaseDetailsRecs",n),res));t(a)}))})),await new Promise((function(e,n){let a=`\n\t\t\t\tdelete from purchase_detail where id = '${t.id}' `;o.query(a,(function(t,a){if(t)return n(i(new d("500","Error deleting purchase_detail ",t),res));e(a)}))})),await _(t.qty,t.product_id,t.stock_id,"minus",res)})),t.length===n)return new Promise((function(t,e){t("done")})).catch((()=>{}))}a.get("/search-all-draft-purchase/:centerid",((t,e)=>{let n=t.params.centerid,a=`select p.*, v.id as vendor_id, v.name as vendor_name,\n\tcase p.status\n        when 'D' then 'Draft'\n        when 'C' then 'Completed'\n    end as pstatus\n\tfrom\n\tpurchase p,\n\tvendor v\n\twhere\n\tv.id = p.vendor_id and\n\tp.status = 'D' and \n\tp.center_id = '${n}' `;o.query(a,(function(t,a){return t?i(new d("500",`/search-all-draft-purchase/:centerid ${n}`,t),e):e.json(a)}))})),a.post("/search-purchase",((t,e)=>{let n=t.body.centerid,a=t.body.status,s=t.body.vendorid,c=t.body.fromdate,u=t.body.todate,l=t.body.order;""!==c&&(c=r(t.body.fromdate,"Asia/Kolkata")+" 00:00:00"),""!==u&&(u=r(t.body.todate,"Asia/Kolkata")+" 23:59:00");let _=`select p.*, v.id as vendor_id, v.name as vendor_name\n\tfrom\n\tpurchase p,\n\tvendor v\n\twhere\n\tv.id = p.vendor_id and\n\t\n\tp.center_id = '${n}' and\n\tstr_to_date(received_date,  '%d-%m-%Y %T') between\n\tstr_to_date('${c}',  '%d-%m-%Y %T') and\n\tstr_to_date('${u}',  '%d-%m-%Y %T') `;"all"!==s&&(_+=`and p.vendor_id = '${s}' `),"all"!==a&&(_+=`and p.status = '${a}' `),_+=`order by str_to_date(received_date,  '%d-%m-%Y %T') ${l}`,o.query(_,(function(t,n){return t?i(new d("500","/search-purchase",t),e):e.json(n)}))})),a.post("/search-sales",((t,e)=>{let n=t.body.centerid,a=t.body.status,s=t.body.customerid,c=t.body.fromdate,u=t.body.todate,l=t.body.saletype,_=t.body.searchtype,m=t.body.invoiceno,p=t.body.order,y="",f="";if("all"===_){""!==c&&(c=r(t.body.fromdate,"Asia/Kolkata")+" 00:00:00"),""!==u&&(u=r(t.body.todate,"Asia/Kolkata")+" 23:59:00");let e=`and s.customer_id = '${s}' `,i=`and s.status = '${a}' `;y=`select s.*, c.id as customer_id, c.name as customer_name\n        from\n        sale s,\n        customer c\n        where\n        c.id = s.customer_id and\n        \n\t\t\t\ts.center_id = '${n}' and\n\t\t\t\t\n\t\t\t\tstr_to_date(invoice_date,  '%d-%m-%Y %T') between\n\t\t\t\tstr_to_date('${c}',  '%d-%m-%Y %T') and\n\t\t\t\tstr_to_date('${u}',  '%d-%m-%Y %T') `,"all"!==s&&(y+=e),"all"!==a&&(y+=i),"all"!==l&&("GI"===l?y+=" and s.sale_type = 'gstinvoice' ":"SI"===l&&(y+=" and s.sale_type = 'stockissue' ")),m.trim().length>0&&(y+=`and invoice_no = '${m.trim()}' `),y=y+" order by invoice_no "+p}else"all"!==_&&(f=` \n\t\tselect s.*, c.id as customer_id, c.name as customer_name\n\t\t\t\t\tfrom\n\t\t\t\t\tsale s,\n\t\t\t\t\tcustomer c\n\t\t\t\t\twhere\n\t\t\t\t\tc.id = s.customer_id and\n\t\t\t\t\t\n\t\t\t\t\ts.center_id = '${n}' and\n\t\t\t\t\tinvoice_no = '${m.trim()}'\n\t\t\t\t\t\n\t\t`);o.query("all"===_?y:f,(function(t,n){return t?i(new d("500","Error fetching search sales",t),e):e.json(n)}))})),a.get("/purchase-master/:id",((t,e)=>{let n=t.params.id,a=`\n\tselect p.*\nfrom \npurchase p\nwhere\np.id = '${n}' `;o.query(a,(function(t,a){return t?i(new d("500",`/purchase-master/:id ${n}`,t),e):e.json(a)}))})),a.get("/sales-master/:id",(async(t,e)=>{let n=await c(`${t.params.id}`);return e.json(n)})),a.get("/sale-details/:id",(async(t,e)=>{let n=await u(`${t.params.id}`);return e.json(n)})),a.post("/delete-sale-details",((t,e)=>{let n=`\n\tdelete from sale_detail where id = '${t.body.id}' `;o.query(n,(function(t,n){return t?i(new d("500","/delete-sale-details",t),e):e.json({result:"success"})}))})),a.get("/delete-item-history/:saleid",((t,e)=>{let n=`\n\tdelete from item_history where sale_id = '${t.params.saleid}' `;o.query(n,(function(t,n){return t?i(new d("500","/delete-item-history",t),e):e.json({result:"success"})}))})),a.get("/purchase-details/:id",((t,e)=>{let n=t.params.id,a=`\n\tselect pd.*, \npd.id as id, \npd.purchase_id as purchase_id,\npd.product_id as product_id,\npd.qty as qty,\npd.purchase_price as purchase_price,\npd.mrp as mrp,\npd.batchdate as batchdate,\npd.tax as tax,\npd.igst as igst,\npd.cgst as cgst,\npd.sgst as sgst,\npd.taxable_value as tax_value,\npd.total_value as total_value,\nps.revision as revision,\np.product_code, p.description, p.packetsize, p.taxrate,\ns.id as stock_pk, p.hsncode as hsncode from\npurchase_detail pd,\nproduct p,\nstock s,\npurchase ps\nwhere\nps.id = pd.purchase_id and\ns.product_id = p.id and\np.id = pd.product_id and\ns.id = pd.stock_id and\npd.purchase_id = '${n}' \n\t `;o.query(a,(function(t,a){return t?i(new d("500",`/purchase-details/:id ${n}`,t),e):e.json(a)}))})),a.post("/delete-purchase-details",(async(t,e)=>{let n=t.body.center_id,a=t.body.id,r=t.body.purchaseid,c=t.body.qty,u=t.body.product_id,m=t.body.stock_id,p=t.body.mrp,y=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),f=`\n\tINSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn, old_value, new_value, audit_date, center_id)\n\tVALUES\n\t\t('Purchase', '${r}', '${a}', 'delete', \n\t\t(SELECT CONCAT('[{', result, '}]') as final\n\t\tFROM (\n\t\t\tSELECT GROUP_CONCAT(CONCAT_WS(',', CONCAT('"purchaseId": ', purchase_id), CONCAT('"productId": "', product_id, '"'), CONCAT('"qty": "', qty, '"')) SEPARATOR '},{') as result\n\t\t\tFROM (\n\t\t\t\tSELECT purchase_id, product_id, qty\n\t\t\t\tFROM purchase_detail where id = '${a}'\n\t\t\t) t1\n\t\t) t2)\n\t\t, '', '${y}', '${n}'\n\t\t) `;return await new Promise((function(t,n){o.query(f,(function(a,r){if(a)return n(i(new d("500","/delete-purchase-details",a),e));t(r)}))})),await new Promise((function(t,n){let r=`\n\t\t\tdelete from purchase_detail where id = '${a}' `;o.query(r,(function(a,r){if(a)return n(i(new d("500","Error deleting purchase_detail ",a),e));t(r)}))})),await _(c,u,m,"minus",e),await l(n,"Purchase",u,r,a,"0","0","PUR",`Deleted MRP - ${p}`,c,"0","0","0","0",e),e.json({result:"success"})})),t.exports=a,a.delete("/delete-purchase/:id",(async(t,e)=>{let n=t.params.id,a=await function(t){let e=`\n\tselect pd.*, \npd.id as id, \npd.purchase_id as purchase_id,\npd.product_id as product_id,\npd.qty as qty,\npd.purchase_price as purchase_price,\npd.mrp as mrp,\npd.batchdate as batchdate,\npd.tax as tax,\npd.igst as igst,\npd.cgst as cgst,\npd.sgst as sgst,\npd.taxable_value as tax_value,\npd.total_value as total_value,\np.product_code, p.description, p.packetsize, p.taxrate from \npurchase_detail pd,\nproduct p\nwhere\np.id = pd.product_id and\npd.purchase_id = '${t}' \n\t `;return new Promise((function(t,n){o.query(e,(function(e,a){e&&n(e),t(a)}))}))}(n);if("done"===await g(a,n))return e.json({result:"success"})})),a.get("/delete-purchase-master/:id",(async(t,e)=>{let n=t.params.id,a=`\n\t\tdelete from purchase where \n\tid = '${n}' `;o.query(a,(function(t,a){return t?i(new d("500",`/delete-purchase-master/:id ${n}`,t),e):e.json({result:"success"})}))})),a.get("/all-products-with-mrp/:productid",(async(t,e)=>{let n=t.params.productid,a=await p(n);e.status(200).json({result:a})})),a.delete("/delete-product-from-stock/:productid/:mrp/:centerid",(async(t,e)=>{let n=t.params.productid,a=t.params.mrp,r=t.params.centerid,s=await y(n,a);await l(r,"Product",n,"0","0","0","0","PRD",`Deleted MRP - ${a}`,"0","0","0","0","0",e),await f(n,r),e.status(200).json({result:s})})),a.post("/stock-correction",(async(t,e)=>{let n=t.body.product_id,a=t.body.mrp,r=t.body.corrected_stock,s=t.body.center_id,i=await m(n,a,r);await l(s,"Product",n,"0","0","0","0","PRD",`Stock Correction: MRP - ${a} : Qty - ${r}`,"0","0","0","0","0",e),e.status(200).json({result:i})}))},1324:(t,e,n)=>{const a=n(2127).Router(),r=n(8928).IncomingForm,{handleError:s,ErrorHandler:i}=(n(2470),n(8005)),{updateLogo:d}=n(8673);function o(t){return t.split(".").pop()}a.post("/add/:centerid/:position",((t,e)=>{let n=t.params.centerid,a=t.params.position,s="",i="";var c=new r,u=[];c.uploadDir="./upload",c.keepExtensions=!0,c.maxFieldsSize=10485760,c.multiples=!0,c.on("error",(function(t){e.json({result:"fail",data:{},message:`Cannot Upload images. Error is : ${t}`})})).on("field",(function(t,e){})).on("fileBegin",(function(t,e){"side"===a?(s=n+"-side-logo."+o(e.name),i=c.uploadDir+"/"+n+"-side-logo."+o(e.name),e.path=c.uploadDir+"/"+n+"-side-logo."+o(e.name)):"main"===a&&(s=n+"-logo."+o(e.name),i=c.uploadDir+"/"+n+"-logo."+o(e.name),e.path=c.uploadDir+"/"+n+"-logo."+o(e.name))})).on("file",(function(t,e){"side"===a?u.push(n+"-side-logo."+o(e.name)):"main"===a&&u.push(n+"-logo."+o(e.name))})).on("progress",(function(t,e){var n=t/e*100|0;process.stdout.write("Uploading: %"+n+"\r")})).on("end",(async function(){"success"===await d(n,s,i,a)?e.json({result:"ok",data:u,numberOfImages:u.length,message:"Upload images successfully"}):e.json({result:"fail"})})),c.parse(t)})),t.exports=a},3076:(t,e,n)=>{var a=n(366).createPool({connectionLimit:100,host:"127.0.0.1",user:"root",password:"tesla",database:"reddotdb",debug:!1});t.exports=a},8005:(t,e,n)=>{const{logger:a}=n(4026);class r extends Error{constructor(t,e,n){super(),this.statusCode=t,this.message=e,a.error("ERRORS: status code: "+t+" << DETAILS >>"+e+" << ERRSTRING >>"+n)}}t.exports={ErrorHandler:r,handleError:(t,e)=>{const{statusCode:n,message:a}=t;e.json({result:"error",statusCode:n,message:a})}}},4026:(t,e,n)=>{const a=n(6455);a.configure({appenders:{access:{type:"dateFile",filename:"./logs/access.log",pattern:"-yyyy-MM-dd",backups:3},debug:{type:"dateFile",filename:"./logs/log.log",pattern:"-yyyy-MM-dd",backups:3}},categories:{default:{appenders:["access"],level:"ALL"},access:{appenders:["access"],level:"DEBUG"},app_log:{appenders:["debug"],level:"DEBUG"}}}),t.exports={logger:a.getLogger("app_log"),express:a.connectLogger(a.getLogger("access"),{level:a.levels.DEBUG})}},3599:(t,e,n)=>{"use strict";const a=n(3863);t.exports=class extends a{constructor(t){super(t)}table(t,e,n,a){let r=this.page.margins.left,s=this.y,i={};"number"==typeof e&&"number"==typeof n?(r=e,s=n,"object"==typeof a&&(i=a)):"object"==typeof e&&(i=e);const d=t.headers.length,o=i.columnSpacing||15,c=i.rowSpacing||5,u=i.width||this.page.width-this.page.margins.left-this.page.margins.right,l=i.prepareHeader||(()=>{}),_=i.prepareRow||(()=>{}),m=t=>{let e=0;return t.forEach((t=>{const n=this.heightOfString(t,{width:y,align:"left"});e=Math.max(e,n)})),e+c},p=u/d,y=p-o,f=this.page.height-this.page.margins.bottom;let g=0;return this.on("pageAdded",(()=>{s=this.page.margins.top,g=0})),l(),s+3*m(t.headers)>f&&this.addPage(),t.headers.forEach(((t,e)=>{this.text(t,r+e*p,s,{width:y,align:"left"})})),g=Math.max(s+m(t.headers),g),this.moveTo(r,g-.5*c).lineTo(r+u,g-.5*c).lineWidth(2).stroke(),t.rows.forEach(((t,e)=>{const n=m(t);s+3*n<f?s=g+c:this.addPage(),_(t,e),t.forEach(((t,e)=>{this.text(t,r+e*p,s,{width:y,align:"left"})})),g=Math.max(s+n,g),this.moveTo(r,g-.5*c).lineTo(r+u,g-.5*c).lineWidth(1).opacity(.7).stroke().opacity(1)})),this.x=r,this.moveDown(),this}}},8372:(t,e,n)=>{const a=n(1289),r=n(6552);function s(t){if(t<0||t>999999999)return"Number out of range!";var e=Math.floor(t/1e7);t-=1e7*e;var n=Math.floor(t/1e5);t-=1e5*n;var a=Math.floor(t/1e3);t-=1e3*a;var r=Math.floor(t/100);t%=100;var i=Math.floor(t/10),d=Math.floor(t%10),o="";e>0&&(o+=s(e)+" crore"),n>0&&(o+=(""==o?"":" ")+s(n)+" lakh"),a>0&&(o+=(""==o?"":" ")+s(a)+" thousand"),r&&(o+=(""==o?"":" ")+s(r)+" hundred");var c=Array("","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"),u=Array("","","Twenty","Thirty","Fourty","Fifty","Sixty","Seventy","Eighty","Ninety");return(i>0||d>0)&&(""!=o&&(o+=" and "),i<2?o+=c[10*i+d]:(o+=u[i],d>0&&(o+="-"+c[d]))),""==o&&(o="Zero"),o}t.exports={number2text:t=>{var e=Math.round(t%1*100),n="";return e>0&&(n="and "+s(e)+" paise"),s(t)+" Rupees "+n+" only"},toTimeZone:function(t,e){return a(t,"YYYY-MM-DDTHH:mm:ssZ").tz(e).format("DD-MM-YYYY")},currentTimeInTimeZone:function(t,e){return a(a(),e).tz(t).format(e)},toTimeZoneFrmt:function(t,e,n){return a(t,"YYYY-MM-DDTHH:mm:ssZ").tz(e).format(n)},encryptPassword:async t=>{try{return await r.hash(t,10)}catch(t){console.log("log errors "+t)}},escapeText:t=>{let e=t.replaceAll(/`/g,"\\`");return e=e.replaceAll(/'/g,"\\'"),e}}},5931:(t,e,n)=>{var a=n(3076);n(4026);const{toTimeZone:r,currentTimeInTimeZone:s,toTimeZoneFrmt:i}=n(8372),{handleError:d,ErrorHandler:o}=(n(2470),n(8005)),c=t=>{let e="";return e=`\n\tupdate customer c set c.balance_amt = (\n\t\tselect balance_amt from ledger l where l.customer_id = '${t}' \n\t\torder by id desc\n\t\tlimit 1)\n\t\twhere \n\t\tc.id = '${t}'  \n\t\t `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},u=(t,e)=>{let n=`\n\tupdate customer c set c.last_paid_date = '${i(e,"Asia/Kolkata","YYYY-MM-DD")}' \n\t\twhere c.id = '${t}' \n\t\t `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))};t.exports={addSaleLedgerRecord:(t,e,n)=>{let r=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),i=`\nINSERT INTO ledger ( center_id, customer_id, invoice_ref_id, ledger_detail, credit_amt, balance_amt, ledger_date)\nVALUES\n  ( ? , ?, ?, 'invoice', ?, IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n    FROM ledger\n    where center_id = '${t.center_id}'  and customer_id = '${t.customerctrl.id}'\n    ORDER BY  id DESC\n    LIMIT 1) a), 0) + '${t.net_total}', '${r}'\n  ) `,d=[t.center_id,t.customerctrl.id,e,t.net_total];return new Promise((function(e,n){a.query(i,d,(async function(a,r){a&&n(a),await c(t.customerctrl.id),e(r)}))}))},addPaymentMaster:(t,e,n,i)=>{let c=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");0!==t.bank_id&&""!==t.bank_id||(t.bank_id=null),0!==t.bank_name&&""!==t.bank_name||(t.bank_name=null);let l=[t.centerid,t.customer.id,e,n.receivedamount,t.customer.credit_amt,r(n.receiveddate,"Asia/Kolkata"),n.pymtmode,n.bankref,n.pymtref,t.bank_id,t.bank_name,t.createdby],_=`\n\t\tinsert into payment ( center_id, customer_id, payment_no, payment_now_amt, advance_amt_used, pymt_date, pymt_mode_ref_id, bank_ref, pymt_ref, last_updated,\n\t\t\tbank_id, bank_name, createdby)\n\t\tVALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, '${c}', ?, ?, ? ) `;return new Promise((function(e,r){a.query(_,l,(async function(a,r){return a?d(new o("500","/addPaymentMaster in accounts.js",a),i):(await u(t.customer.id,n.receiveddate),e(r.insertId))}))}))},getLedgerByCustomers:(t,e,n)=>{let r=` select l.center_id, l.customer_id, l.ledger_detail, l.credit_amt, l.debit_amt, l.balance_amt, l.ledger_date,\n\t(select s.invoice_no from sale s where s.id = l.invoice_ref_id) as invoice_ref_id,\n\t(select p.payment_no from payment p where p.id = l.payment_ref_id) as payment_ref_id\n\t from ledger l\n\t where \n\t l.center_id =  '${t}' and l.customer_id = '${e}' \t and ledger_detail != 'Invoice Reversal' order by l.id desc  `;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},getSaleInvoiceByCustomers:(t,e,n,r,s,i,d)=>{let o=`\tselect s.id as sale_id, s.center_id as center_id, s.customer_id as customer_id, s.invoice_no as invoice_no, \n\ts.invoice_date as invoice_date, \n\tabs(datediff(STR_TO_DATE(s.invoice_date,'%d-%m-%Y'), CURDATE())) as aging_days,\n\ts.net_total as invoice_amt, s.sale_type as sale_type, c.name as customer_name, c.address1 as customer_address1,\n\tc.address2 as customer_address2,\n\t(select\n\t(\n\t\t\t CASE\n\t\t\t\t\tWHEN  sum(pd.applied_amount) = s.net_total THEN 'PAID'\n\t\t\t\t\tWHEN  (sum(pd.applied_amount) <= s.net_total &&  sum(pd.applied_amount) > 0 )THEN 'PARTIALLY PAID'\n\t\n\t\t\t\t\tELSE 'NOT PAID'\n\t\t\tEND)  as payment_status\n\t\n\tfrom payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO') as payment_status,\n\tIFNULL((select sum(pd.applied_amount) from payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0) as paid_amount,\n\t(s.net_total - IFNULL((select sum(pd.applied_amount) from payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0)) as \n\tbal_amount\n\tfrom sale s, customer c\n\twhere\n\tc.id = '${e}' and\n\ts.center_id = '${t}' and\n\ts.customer_id = c.id and s.status = 'C'\n\tand\n\ts.sale_type= 'gstinvoice' \n\t`;void 0!==e&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${n}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${r}', '%d-%m-%YYYY')`),void 0!==e&&"all"!==e&&"all"===s&&(o+=` and\ts.customer_id = '${e}' `),"invonly"===s&&(o+=` and s.invoice_no = '${i}' `),o+=" order by str_to_date(s.invoice_date, '%d-%m-%YYYY') desc  ",a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getPaymentsByCustomers:(t,e,n,r,s,i,d)=>{let o=` select p.*, pd.applied_amount as applied_amount, s.invoice_no as invoice_no, \n\ts.invoice_date as invoice_date, s.net_total as invoice_amount,  pm.pymt_mode_name as pymt_mode from \n        payment p,\n        payment_detail pd,\n\t\t\t\tsale s,\n\t\t\t\tpayment_mode pm\n\t\t\t\twhere \n\t\t\t\tpm.id = p.pymt_mode_ref_id and\n        p.id = pd.pymt_ref_id and\n        pd.sale_ref_id = s.id and\n        p.center_id =   '${t}' `;void 0!==e&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\t\t\t\tstr_to_date('${n}', '%d-%m-%YYYY') and\n\t\t\t\t\tstr_to_date('${r}', '%d-%m-%YYYY')`),void 0!==e&&"all"!==e&&"all"===s&&(o+=` and\tp.customer_id = '${e}' `),"invonly"===s&&(o+=` and s.invoice_no like '%${i}%' `),o+=" order by id desc  ",a.query(o,(function(t,e){return t?d(t):d(null,e)}))},addPaymentLedgerRecord:(t,e,n,r,i)=>{let d=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),o=`\n\tINSERT INTO ledger ( center_id, customer_id, invoice_ref_id, payment_ref_id, ledger_detail, debit_amt, balance_amt, ledger_date)\n\tVALUES\n\t\t( ? , ?, '${r}', ?, 'Payment', ?, IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n\t\t\tFROM ledger\n\t\t\twhere center_id = '${t.customer.center_id}'  and customer_id = '${t.customer.id}'\n\t\t\tORDER BY  id DESC\n\t\t\tLIMIT 1) a), 0) - '${n}', '${d}'\n\t\t) `,u=[t.customer.center_id,t.customer.id,e,n];a.query(o,u,(async function(e,n){return e?i(e):(await c(t.customer.id),i(null,n))}))},updatePymtSequenceGenerator:t=>{let e="";return e=`\n\t\tupdate financialyear set pymt_seq = pymt_seq + 1 where \n\t\tcenter_id = '${t}' and  \n\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},getPymtSequenceNo:t=>{let e="";return e=` select \n\tconcat("RP-",'${i(t.accountarr[0].receiveddate,"Asia/Kolkata","YY")}', "/", \n\t'${i(t.accountarr[0].receiveddate,"Asia/Kolkata","MM")}', "/", lpad(pymt_seq, 5, "0")) as pymtNo from financialyear \n\t\t\t\twhere \n\t\t\t\tcenter_id = '${t.centerid}' and  \n\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a[0].pymtNo)}))}))},getPaymentsByCenter:(t,e,n,r,s,i,d)=>{let o=`\n\tselect \n\tc.name as customer_name,\n\tc.id as customer_id,\n\tpymt_mode_name as pymt_mode_name,\n\tp.bank_ref as bank_ref,\n\tp.pymt_ref as pymt_ref,\n\tp.payment_no as payment_no,\n DATE_FORMAT(STR_TO_DATE(p.pymt_date,'%d-%m-%Y'), '%d-%b-%Y') as pymt_date,\n\tp.advance_amt_used as advance_amt_used,\n\tpymt_mode_ref_id as pymt_mode_ref_id,\n\tpymt_ref as pymt_ref,\n\tlast_updated as last_updated,\n\ts.invoice_no as invoice_no,\n\ts.net_total as invoice_amount,\n\tDATE_FORMAT(STR_TO_DATE(s.invoice_date,'%d-%m-%Y'), '%d-%b-%Y') as invoice_date,\n\tpd.applied_amount as applied_amount,\n\tp.bank_name\n\tfrom \n\t\t\t\t payment p,\n\t\t\t\t payment_detail pd,\n\t\t\t\t sale s,\n\t\t\t\t customer c,\n\t\t\t\t payment_mode pm\n\t\t\t\t where \n\t\t\t\t pm.id = p.pymt_mode_ref_id and\n\t\t\t\t c.id = p.customer_id and\n\t\t\t\t p.id = pd.pymt_ref_id and\n\t\t\t\t pd.sale_ref_id = s.id and\n\t\t\t\t p.center_id = '${t}' `;void 0!==r&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${e}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${n}', '%d-%m-%YYYY')`),void 0!==r&&"all"!==r&&"all"===s&&(o+=` and\tp.customer_id = '${r}' `),"invonly"===s&&(o+=` and s.invoice_no like '%${i}%' `),o+=" order by str_to_date(pymt_date, '%d-%m-%YYYY') desc  ",a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getPymtTransactionsByCenter:(t,e)=>{let n=`\n\tselect \n\tc.name as customer_name,\n\tc.id as customer_id,\n\tpymt_mode_name as pymt_mode_name,\n\tp.payment_no as payment_no,\n\t DATE_FORMAT(STR_TO_DATE(p.pymt_date,'%d-%m-%Y'), '%d-%b-%Y') as pymt_date,\n\t p.payment_now_amt as paid_amount,\n\tp.advance_amt_used as advance_amt_used,\n\tpymt_mode_ref_id as pymt_mode_ref_id,\n\tpymt_ref as pymt_ref,\n\tbank_ref as bank_ref,\n\tlast_updated as last_updated\nfrom \n\tpayment p,\n\tcustomer c,\n\tpayment_mode pm\nwhere \n\tpm.id = p.pymt_mode_ref_id and\n\tc.id = p.customer_id and\n\tp.center_id = '${t}' order by pymt_date desc \n\t\n\t`;a.query(n,(function(t,n){return t?e(t):e(null,n)}))},getSaleInvoiceByCenter:(t,e,n,r,s,i,d)=>{let o=`\tselect s.id as sale_id, s.center_id as center_id, s.customer_id as customer_id, \n\ts.invoice_no as invoice_no, s.invoice_date as invoice_date, \n\tabs(datediff(STR_TO_DATE(s.invoice_date,'%d-%m-%Y'), CURDATE())) as aging_days,\n\ts.net_total as invoice_amt, \n\ts.sale_type as sale_type, c.name as customer_name, c.address1 as customer_address1,\n\tc.address2 as customer_address2,\n\t(select\n\t(\n\t\t\t CASE\n\t\t\t\t\tWHEN  sum(pd.applied_amount) = s.net_total THEN 'PAID'\n\t\t\t\t\tWHEN  (sum(pd.applied_amount) <= s.net_total &&  sum(pd.applied_amount) > 0 )THEN 'PARTIALLY PAID'\n\t\n\t\t\t\t\tELSE 'NOT PAID'\n\t\t\tEND)  as payment_status\n\t \n\tfrom payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO') as payment_status,\n\tIFNULL((select sum(pd.applied_amount) from payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0) as paid_amount,\n\t(s.net_total - IFNULL((select sum(pd.applied_amount) from payment_detail pd, payment p2\n\twhere pd.sale_ref_id = s.id and pd.pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0)) as \n\tbal_amount\n\tfrom sale s, customer c\n\twhere\n\t\n\ts.center_id = '${t}' and\n\ts.customer_id = c.id and\n\ts.sale_type= 'gstinvoice'\n\t`;void 0!==r&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${e}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${n}', '%d-%m-%YYYY')`),void 0!==r&&"all"!==r&&"all"===s&&(o+=` and\ts.customer_id = '${r}' `),"invonly"===s&&(o+=` and s.invoice_no like '%${i}%' `),a.query(o,(function(t,e){return t?d(t):d(null,e)}))},updateCustomerCredit:(t,e,n)=>{let r="";return r=`\n\t\tupdate customer set credit_amt = credit_amt + ${t=1+~t} where \n\t\tcenter_id = '${e}' and  \n\t\tid = '${n}'\n\t\t `,new Promise((function(t,e){a.query(r,(function(n,a){n&&e(n),t(a)}))}))},updateCustomerCreditMinus:(t,e,n)=>{let r="";return r=`\n\t\tupdate customer set credit_amt = credit_amt - ${t} where \n\t\tcenter_id = '${e}' and  \n\t\tid = '${n}'\n\t\t `,new Promise((function(t,e){a.query(r,(function(n,a){n&&e(n),t(a)}))}))},addReverseSaleLedgerRecord:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=`\nINSERT INTO ledger ( center_id, customer_id, invoice_ref_id, ledger_detail, debit_amt, balance_amt, ledger_date)\nVALUES\n\t( ? , ?, ?, 'Invoice Reversal', \n\t\n\tIFNULL((select credit_amt from (select (credit_amt) as credit_amt\n    FROM ledger\n\t\twhere center_id = '${t.center_id}'  and customer_id = '${t.customerctrl.id}'\n\t\tand ledger_detail = 'Invoice' and invoice_ref_id = '${e}'\n    ORDER BY  id DESC\n\t\tLIMIT 1) a), 0),\n\t\t\n\t\t(\n\t\t\t\n\t\n\t IFNULL((select balance_amt from (select (balance_amt ) as balance_amt\n    FROM ledger\n\t\twhere center_id = '${t.center_id}'  and customer_id = '${t.customerctrl.id}'\n\t\t\n    ORDER BY  id DESC\n\t\tLIMIT 1) a), 0)\n\t\t-\n\t\tIFNULL((select credit_amt from (select (credit_amt) as credit_amt\n\t\t\tFROM ledger\n\t\t\twhere center_id = '${t.center_id}'  and customer_id = '${t.customerctrl.id}'\n\t\t\tand ledger_detail = 'Invoice' and invoice_ref_id = '${e}'\n\t\t\tORDER BY  id DESC\n\t\t\tLIMIT 1) a), 0)\n\t\t\n\t\t), '${n}'\n  ) `,i=[t.center_id,t.customerctrl.id,e];return new Promise((function(e,n){a.query(r,i,(async function(a,r){return a?n(a):(await c(t.customerctrl.id),e(r))}))}))},addSaleLedgerAfterReversalRecord:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=`\nINSERT INTO ledger ( center_id, customer_id, invoice_ref_id, ledger_detail, credit_amt, balance_amt, ledger_date)\nVALUES\n  ( ? , ?, ?, 'Invoice', ?, (credit_amt + IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n    FROM ledger\n    where center_id = '${t.center_id}'  and customer_id = '${t.customerctrl.id}'\n    ORDER BY  id DESC\n    LIMIT 1) a), 0)), '${n}'\n  ) `,i=[t.center_id,t.customerctrl.id,e,t.net_total];return new Promise((function(e,n){a.query(r,i,(async function(a,r){return a?n(a):(await c(t.customerctrl.id),e(r))}))}))},getPymtTransactionByCustomers:(t,e,n)=>{let r=` \n\tselect \n\tp.id as id, p.center_id as center_id, p.customer_id as customer_id,\n\tp.payment_no as payment_no,\n\t\tp.payment_now_amt as payment_now_amt,\n\t\tp.advance_amt_used as advance_amt_used,\n\t\tstr_to_date(p.pymt_date, '%d-%m-%YYYY') as pymt_date,\n\t\tp.pymt_mode_ref_id as pymt_mode_ref_id,\n\t\tp.bank_ref as bank_ref,\n\t\tp.pymt_ref as pymt_ref,\n\t\tp.is_cancelled as is_cancelled,\n\t\tp.cancelled_date as cancelled_date,\n\t\tp.createdby as createdby,\n\t\tp.last_updated as last_updated,\n\t\n\tpm.pymt_mode_name as pymt_mode\n \tfrom\n  \tpayment p,\n\t\tpayment_mode pm\n\twhere \n\t\tpm.id = p.pymt_mode_ref_id and\n\t\tp.center_id = '${t}' and p.customer_id = '${e}'\n\torder by last_updated desc `;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},updateCustomerLastPaidDate:u,bankList:t=>{let e=`select * from center_banks where center_id = ${t} order by bankname `;return new Promise(((t,n)=>{a.query(e,(function(e,a){e&&n({status:"error",response:e}),t({status:"success",response:a})}))}))},paymentBankRef:(t,e,n,r)=>{let s="";return"payment"===r?s=`select count(*) as count from payment where center_id = '${t}' and bank_ref = '${e}' and customer_id = '${n}' `:"vendorpayment"===r&&(s=`select count(*) as count from vendor_payment where center_id = '${t}' and bank_ref = '${e}' and vendor_id = '${n}' `),new Promise(((t,e)=>{a.query(s,(function(n,a){n&&e({status:"error",response:n}),t({status:"success",response:a})}))}))},lastPaymentRecord:(t,e)=>{let n=`select payment_no, payment_now_amt, pymt_date, bank_ref,\n\tpymt_ref\n\tfrom \n\tpayment p,\n\tpayment_mode pm\n\twhere \n\tpm.id = p.pymt_mode_ref_id\n\tand p.center_id = '${t}'\n\tand p.customer_id = '${e}'\n\torder by p.id desc limit 1 `;return new Promise(((t,e)=>{a.query(n,(function(n,a){n&&e({status:"error",response:n}),t({status:"success",response:a})}))}))},lastVendorPaymentRecord:(t,e)=>{let n=`select vendor_payment_no as payment_no, payment_now_amt, pymt_date, bank_ref,\n\tpymt_ref\n\tfrom \n\tvendor_payment p,\n\tpayment_mode pm\n\twhere \n\tpm.id = p.pymt_mode_ref_id\n\tand p.center_id = '${t}'\n\tand p.vendor_id = '${e}'\n\torder by p.id desc limit 1 `;return new Promise(((t,e)=>{a.query(n,(function(n,a){n&&e({status:"error",response:n}),t({status:"success",response:a})}))}))},getPaymentsOverviewByCustomers:(t,e,n,r,s,i,c)=>{let u=` select p.*, \n\tpm.pymt_mode_name as pymt_mode \n from \n\tpayment p,\n\tpayment_mode pm\n where \n\tpm.id = p.pymt_mode_ref_id and\n\tp.center_id = '${t}' `;return void 0!==e&&"all"===s&&(u+=` and STR_TO_DATE(p.pymt_date,'%d-%m-%Y') between\n\t\t\t\t\tstr_to_date('${n}', '%d-%m-%YYYY') and\n\t\t\t\t\tstr_to_date('${r}', '%d-%m-%YYYY')`),void 0!==e&&"all"!==e&&"all"===s&&(u+=` and\tp.customer_id = '${e}' `),u+=" order by id desc  ",new Promise((function(t,e){a.query(u,(function(e,n){if(e)return d(new o("500",`getPaymentsOverviewByCustomers in accounts.js QUERY ${u}`,e),c);t(n)}))}))},getPaymentsOverviewByCenter:(t,e,n,r,s,i,c)=>{let u=`\n\tselect \n\tc.name as customer_name,\n\tc.id as customer_id,\n\tpymt_mode_name as pymt_mode_name,\n\tp.bank_ref as bank_ref,\n\tp.pymt_ref as pymt_ref,\n\tp.payment_no as payment_no,\n DATE_FORMAT(STR_TO_DATE(p.pymt_date,'%d-%m-%Y'), '%d-%b-%Y') as pymt_date,\n p.payment_now_amt,\n\tp.advance_amt_used as advance_amt_used,\n\tpymt_mode_ref_id as pymt_mode_ref_id,\n\tpymt_ref as pymt_ref,\n\tlast_updated as last_updated,\n\tp.bank_name\n\n\tfrom \n\t\t\t\t payment p,\n\n\n\t\t\t\t customer c,\n\t\t\t\t payment_mode pm\n\t\t\t\t where \n\t\t\t\t pm.id = p.pymt_mode_ref_id and\n\t\t\t\t c.id = p.customer_id and\n\t\t\t\t p.center_id = '${t}' `;return void 0!==r&&"all"===s&&(u+=` and STR_TO_DATE(p.pymt_date,'%d-%m-%Y') between\n\t\tstr_to_date('${e}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${n}', '%d-%m-%YYYY')`),void 0!==r&&"all"!==r&&"all"===s&&(u+=` and\tp.customer_id = '${r}' `),u+=" order by str_to_date(pymt_date, '%d-%m-%YYYY') desc  ",new Promise((function(t,e){a.query(u,(function(e,n){if(e)return d(new o("500",`getPaymentsOverviewByCenter in accounts.js QUERY ${u}`,e),c);t(n)}))}))}}},1502:(t,e,n)=>{var a=n(3076);n(4026);const{toTimeZone:r,currentTimeInTimeZone:s,toTimeZoneFrmt:i}=n(8372),{handleError:d,ErrorHandler:o}=n(8005),c=(n(2470),t=>{let e="";return e=`\n\tupdate vendor v set v.balance_amt = (\n\t\tselect balance_amt from purchase_ledger l where l.vendor_id = '${t}' \n\t\torder by id desc\n\t\tlimit 1)\n\t\twhere \n\t\tv.id = '${t}'  \n\t\t `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))}),u=(t,e)=>{let n=`\n\tupdate vendor c set c.last_paid_date = '${i(e,"Asia/Kolkata","YYYY-MM-DD")}' \n\t\twhere c.id = '${t}' \n\t\t `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))};t.exports={addPurchaseLedgerRecord:(t,e,n)=>{let r=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),i=`\nINSERT INTO purchase_ledger ( center_id, vendor_id, purchase_ref_id, ledger_detail, credit_amt, balance_amt, ledger_date)\nVALUES\n  ( ? , ?, ?, 'purchase', ?, IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n    FROM purchase_ledger\n    where center_id = '${t.centerid}'  and vendor_id = '${t.vendorctrl.id}'\n    ORDER BY  id DESC\n    LIMIT 1) a), 0) + '${t.net_total}', '${r}'\n  ) `,d=[t.centerid,t.vendorctrl.id,e,t.net_total];return new Promise((function(e,n){a.query(i,d,(async function(a,r){a&&n(a),await c(t.vendorctrl.id),e(r)}))}))},addReversePurchaseLedgerRecord:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=`\nINSERT INTO purchase_ledger ( center_id, vendor_id, purchase_ref_id, ledger_detail, debit_amt, balance_amt, ledger_date)\nVALUES\n\t( ? , ?, ?, 'Purchase Reversal', \n\t\n\tIFNULL((select credit_amt from (select (credit_amt) as credit_amt\n    FROM purchase_ledger\n\t\twhere center_id = '${t.centerid}'  and vendor_id = '${t.vendorctrl.id}'\n\t\tand ledger_detail = 'Invoice' and purchase_ref_id = '${e}'\n    ORDER BY  id DESC\n\t\tLIMIT 1) a), 0),\n\t\t\n\t\t(\n\t\t\t\n\t\n\t IFNULL((select balance_amt from (select (balance_amt ) as balance_amt\n    FROM purchase_ledger\n\t\twhere center_id = '${t.centerid}'  and vendor_id = '${t.vendorctrl.id}'\n\t\t\n    ORDER BY  id DESC\n\t\tLIMIT 1) a), 0)\n\t\t-\n\t\tIFNULL((select credit_amt from (select (credit_amt) as credit_amt\n\t\t\tFROM purchase_ledger\n\t\t\twhere center_id = '${t.centerid}'  and vendor_id = '${t.vendorctrl.id}'\n\t\t\tand ledger_detail = 'purchase' and purchase_ref_id = '${e}'\n\t\t\tORDER BY  id DESC\n\t\t\tLIMIT 1) a), 0)\n\t\t\n\t\t), '${n}'\n  ) `,i=[t.centerid,t.vendorctrl.id,e];return new Promise((function(e,n){a.query(r,i,(async function(a,r){return a?n(a):(await c(t.vendorctrl.id),e(r))}))}))},addPurchaseLedgerAfterReversalRecord:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=`\nINSERT INTO purchase_ledger ( center_id, vendor_id, purchase_ref_id, ledger_detail, credit_amt, balance_amt, ledger_date)\nVALUES\n  ( ? , ?, ?, 'purchase', ?, (credit_amt + IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n    FROM purchase_ledger\n    where center_id = '${t.centerid}'  and vendor_id = '${t.vendorctrl.id}'\n    ORDER BY  id DESC\n    LIMIT 1) a), 0)), '${n}'\n  ) `,i=[t.centerid,t.vendorctrl.id,e,t.net_total];return new Promise((function(e,n){a.query(r,i,(async function(a,r){return a?n(a):(await c(t.vendorctrl.id),e(r))}))}))},getPurchaseInvoiceByCenter:(t,e,n,r,s,i,d)=>{let o=`\tselect p.id as purchase_id, \n\tp.center_id as center_id, \n\tp.vendor_id as vendor_id, \n\tp.invoice_no as invoice_no, \n\tp.invoice_date as invoice_date, \n\tabs(datediff(STR_TO_DATE(p.invoice_date,'%d-%m-%Y'), CURDATE())) as aging_days,\n\tp.net_total as invoice_amt, \n\tv.name as vendor_name, v.address1 as vendor_address1,\n\tv.address2 as vendor_address2,\n\t(select\n\t\t(\n\t\t\t\t CASE\n\t\t\t\t\t\tWHEN  sum(pd.applied_amount) = p.net_total THEN 'PAID'\n\t\t\t\t\t\tWHEN  (sum(pd.applied_amount) <= p.net_total &&  sum(pd.applied_amount) > 0 )THEN 'PARTIALLY PAID'\n\t\t\n\t\t\t\t\t\tELSE 'NOT PAID'\n\t\t\t\tEND)  as payment_status\n\t\t \n\t\tfrom \n\t\t\tvendor_payment_detail pd, \n\t\t\tvendor_payment p2\n\t\twhere \n\t\t\tpd.purchase_ref_id = p.id and \n\t\t\tpd.vend_pymt_ref_id = p2.id and \n\t\t\tp2.is_cancelled = 'NO') as payment_status,\n\tIFNULL((select sum(pd.applied_amount) from vendor_payment_detail pd, vendor_payment p2\n\t\twhere pd.purchase_ref_id = p.id and pd.vend_pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0) as paid_amount,\n\t(p.net_total - IFNULL((select sum(pd.applied_amount) from vendor_payment_detail pd, vendor_payment p2\n\t\twhere pd.purchase_ref_id = p.id and pd.vend_pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0)) as \n\t\tbal_amount\n\tfrom purchase p, vendor v\n\twhere\n\t\tp.center_id = '${t}' and p.status = 'C' and\n\t\tp.vendor_id = v.id \n\t\n\t`;void 0!==r&&"all"===s&&(o+=` and STR_TO_DATE(p.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${e}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${n}', '%d-%m-%YYYY')`),void 0!==r&&"all"!==r&&"all"===s&&(o+=` and\tp.vendor_id = '${r}' `),"invonly"===s&&(o+=` and p.invoice_no like '%${i}%' `),a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getVendorPymtSequenceNo:t=>{let e="";return e=` select concat("VP-",'${i(t.accountarr[0].receiveddate,"Asia/Kolkata","YY")}', "/", '${i(t.accountarr[0].receiveddate,"Asia/Kolkata","MM")}', "/", lpad(vendor_pymt_seq, 5, "0")) as pymtNo from financialyear \n\t\t\t\twhere \n\t\t\t\tcenter_id = '${t.centerid}' and  \n\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a[0].pymtNo)}))}))},updateVendorPymtSequenceGenerator:t=>{let e="";return e=`\n\t\tupdate financialyear set vendor_pymt_seq = vendor_pymt_seq + 1 where \n\t\tcenter_id = '${t}' and  \n\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},addVendorPaymentLedgerRecord:(t,e,n,r,i)=>{let d=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),o=`\n\tINSERT INTO purchase_ledger ( center_id, vendor_id, purchase_ref_id, payment_ref_id, ledger_detail, debit_amt, balance_amt, ledger_date)\n\tVALUES\n\t\t( ? , ?, '${r}', ?, 'Payment', ?, IFNULL((select balance_amt from (select (balance_amt) as balance_amt\n\t\t\tFROM purchase_ledger\n\t\t\twhere center_id = '${t.vendor.center_id}'  and vendor_id = '${t.vendor.id}'\n\t\t\tORDER BY  id DESC\n\t\t\tLIMIT 1) a), 0) - '${n}', '${d}'\n\t\t) `,u=[t.vendor.center_id,t.vendor.id,e,n];a.query(o,u,(async function(e,n){return e?i(e):(await c(t.vendor.id),i(null,n))}))},addVendorPaymentMaster:(t,e,n,i)=>{let c=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");0!==t.bank_id&&""!==t.bank_id||(t.bank_id=null),0!==t.bank_name&&""!==t.bank_name||(t.bank_name=null);let l=[t.centerid,t.vendor.id,e,n.receivedamount,t.vendor.credit_amt,r(n.receiveddate,"Asia/Kolkata"),n.pymtmode,n.bankref,n.pymtref,t.bank_id,t.bank_name,t.createdby],_=`\n\t\tINSERT INTO vendor_payment ( center_id, vendor_id, vendor_payment_no, payment_now_amt, advance_amt_used, pymt_date, pymt_mode_ref_id, bank_ref, pymt_ref, last_updated, bank_id, bank_name, createdby)\n\t\tVALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, '${c}', ?, ?, ? ) `;return new Promise((function(e,r){a.query(_,l,(async function(a,r){return a?d(new o("500",`Error addVendorPaymentMaster of purchaseaccounts.js ${_} and values are ${l}`,a),i):(await u(t.vendor.id,n.receiveddate),e(r.insertId))}))}))},updateVendorCredit:(t,e,n)=>{let r="";return r=`\n\t\tupdate vendor set credit_amt = credit_amt + ${t=1+~t} where \n\t\tcenter_id = '${e}' and  \n\t\tid = '${n}'\n\t\t `,new Promise((function(t,e){a.query(r,(function(n,a){n&&e(n),t(a)}))}))},updateVendorCreditMinus:(t,e,n)=>{let r="";return r=`\n\t\tupdate vendor set credit_amt = credit_amt - ${t} where \n\t\tcenter_id = '${e}' and  \n\t\tid = '${n}'\n\t\t `,new Promise((function(t,e){a.query(r,(function(n,a){n&&e(n),t(a)}))}))},updateVendorBalanceAmount:c,updateVendorLastPaidDate:u,getVendorPaymentsByCenter:(t,e,n,r,s,i,d)=>{let o=`\n\tselect \n\tc.name as vendor_name,\n\tc.id as vendor_id,\n\tpymt_mode_name as pymt_mode_name,\n\tp.bank_ref as bank_ref,\n\tp.pymt_ref as pymt_ref,\n\tp.vendor_payment_no as payment_no,\n DATE_FORMAT(STR_TO_DATE(p.pymt_date,'%d-%m-%Y'), '%d-%b-%Y') as pymt_date,\n\tp.advance_amt_used as advance_amt_used,\n\tpymt_mode_ref_id as pymt_mode_ref_id,\n\tpymt_ref as pymt_ref,\n\tlast_updated as last_updated,\n\ts.invoice_no as invoice_no, \n\tDATE_FORMAT(STR_TO_DATE(s.invoice_date,'%d-%m-%Y'), '%d-%b-%Y') as invoice_date,\n\tpd.applied_amount as applied_amount\n\tfrom \n\t\t\t\t vendor_payment p,\n\t\t\t\t vendor_payment_detail pd,\n\t\t\t\t purchase s,\n\t\t\t\t vendor c,\n\t\t\t\t payment_mode pm\n\t\t\t\t where \n\t\t\t\t pm.id = p.pymt_mode_ref_id and\n\t\t\t\t c.id = p.vendor_id and\n\t\t\t\t p.id = pd.vend_pymt_ref_id and\n\t\t\t\t pd.purchase_ref_id = s.id and\n\t\t\t\t p.center_id = '${t}' `;void 0!==r&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${e}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${n}', '%d-%m-%YYYY')`),void 0!==r&&"all"!==r&&"all"===s&&(o+=` and\tp.vendor_id = '${r}' `),"invonly"===s&&(o+=` and s.invoice_no like '%${i}%' `),o+=" order by pymt_date desc  ",a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getPurchaseInvoiceByVendors:(t,e,n,r,s,i,d)=>{let o=`\tselect s.id as purchase_id, s.center_id as center_id, s.vendor_id as vendor_id, s.invoice_no as invoice_no, \n\ts.invoice_date as invoice_date, \n\tabs(datediff(STR_TO_DATE(s.invoice_date,'%d-%m-%Y'), CURDATE())) as aging_days,\n\ts.net_total as invoice_amt, \n\ts.purchase_type as purchase_type, \n\tc.name as vendor_name, c.address1 as vendor_address1,\n\tc.address2 as vendor_address2,\n\t(select\n\t(\n\t\t\t CASE\n\t\t\t\t\tWHEN  sum(pd.applied_amount) = s.net_total THEN 'PAID'\n\t\t\t\t\tWHEN  (sum(pd.applied_amount) <= s.net_total &&  sum(pd.applied_amount) > 0 )THEN 'PARTIALLY PAID'\n\t\n\t\t\t\t\tELSE 'NOT PAID'\n\t\t\tEND)  as payment_status\n\t\n\tfrom vendor_payment_detail pd, vendor_payment p2\n\twhere pd.purchase_ref_id = s.id and pd.vend_pymt_ref_id = p2.id and p2.is_cancelled = 'NO') as payment_status,\n\tIFNULL((select sum(pd.applied_amount) from vendor_payment_detail pd, vendor_payment p2\n\twhere pd.purchase_ref_id = s.id and pd.vend_pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0) as paid_amount,\n\t(s.net_total - IFNULL((select sum(pd.applied_amount) from vendor_payment_detail pd, vendor_payment p2\n\twhere pd.purchase_ref_id = s.id and pd.vend_pymt_ref_id = p2.id and p2.is_cancelled = 'NO'), 0)) as \n\tbal_amount\n\tfrom purchase s, vendor c\n\twhere\n\tc.id = '${e}' and\n\ts.center_id = '${t}' and\n\ts.vendor_id = c.id \n\n\t`;void 0!==e&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\tstr_to_date('${n}', '%d-%m-%YYYY') and\n\t\tstr_to_date('${r}', '%d-%m-%YYYY')`),void 0!==e&&"all"!==e&&"all"===s&&(o+=` and\ts.vendor_id = '${e}' `),"invonly"===s&&(o+=` and s.invoice_no = '${i}' `),a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getPaymentsByVendors:(t,e,n,r,s,i,d)=>{let o=` select p.*, pd.applied_amount as applied_amount, s.invoice_no as invoice_no, \n\ts.invoice_date as invoice_date, s.net_total as invoice_amount,  pm.pymt_mode_name as pymt_mode from \n        vendor_payment p,\n        vendor_payment_detail pd,\n\t\t\t\tpurchase s,\n\t\t\t\tpayment_mode pm\n\t\t\t\twhere \n\t\t\t\tpm.id = p.pymt_mode_ref_id and\n        p.id = pd.vend_pymt_ref_id and\n        pd.purchase_ref_id = s.id and\n        p.center_id =   '${t}' `;void 0!==e&&"all"===s&&(o+=` and STR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\n\t\t\t\t\tstr_to_date('${n}', '%d-%m-%YYYY') and\n\t\t\t\t\tstr_to_date('${r}', '%d-%m-%YYYY')`),void 0!==e&&"all"!==e&&"all"===s&&(o+=` and\tp.vendor_id = '${e}' `),"invonly"===s&&(o+=` and s.invoice_no = '${i}' `),o+=" order by id desc  ",a.query(o,(function(t,e){return t?d(t):d(null,e)}))},getLedgerByVendors:(t,e,n)=>{let r=` select l.center_id, l.vendor_id, l.ledger_detail, l.credit_amt, l.debit_amt, l.balance_amt, l.ledger_date,\n\t(select s.invoice_no from purchase s where s.id = l.purchase_ref_id) as purchase_ref_id,\n\t(select p.vendor_payment_no from vendor_payment p where p.id = l.payment_ref_id) as payment_ref_id\n\t from purchase_ledger l\n\t where \n\t l.center_id =  '${t}' and l.vendor_id = '${e}' order by l.id desc  `;a.query(r,(function(t,e){return t?n(t):n(null,e)}))}}},8673:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{toTimeZone:r,currentTimeInTimeZone:s}=n(8372),{encryptPassword:i}=n(8372);n(6552),t.exports={insertUser:async t=>{let e=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),n=await i(t.password),r=`  insert into users (centerid, username, userpass, firstname, mobilenumber, createddatetime, status ) VALUES (?, ?, ?, ?, ?, '${e}', 'A')`,d=[t.center_id,t.username,n,t.firstname,t.username];return new Promise((function(t,e){a.query(r,d,(function(n,a){n&&e(n),t(a.insertId)}))}))},updateUserStatus:t=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let e=[t.status,t.id];return new Promise((function(t,n){a.query("  update users set status = ? where id = ? ",e,(function(e,a){e&&n(e),t(a)}))}))},insertUserRole:t=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let e=[t.role_id,t.user_id];return new Promise((function(t,n){a.query("  insert into user_role (role_id, user_id ) VALUES (?, ?)",e,(function(e,a){e&&n(e),t(a)}))}))},getUsers:(t,e)=>{let n=`\n  select u.*, r.id as role_id, r.name as role, r.description as description from \nusers u,\nrole r,\nuser_role ur\nwhere\nu.id = ur.user_id and\nur.role_id = r.id and\nu.centerid = '${t}' and status = '${e}'\n  `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},getOutstandingBalance:(t,e)=>{let n=` \n\tselect c.*,\n\tcount(s.id) as inv_count\n\t from \n\tcustomer as c,\n\tsale as s\n\twhere \n\tc.id = s.customer_id and\n\tc.center_id = '${t}'\n\t\tand c.balance_amt != 0 \n\t\tgroup by c.id\n\t\torder by c.balance_amt desc \t `;return 0!==e&&(n+=` limit ${e}`),new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},isUserExist:async t=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),await i(t.password);let e=` select * from users where \n\t  username = ${t.username} `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),a.length>0?t("DUP_USERNAME"):t("")}))}))},updateLogo:(t,e,n,r)=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let i="";return"main"===r?i=` update center set logo_name = '${e}', logo_url = '${n}' \n\t\twhere id = ${t} `:"side"===r&&(i=` update center set side_logo_name = '${e}', side_logo_url = '${n}' \n\t\twhere id = ${t} `),new Promise((function(t,e){a.query(i,(function(n,a){n&&e(n),t("success")}))}))},insertBank:async t=>{let e=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),n=`  INSERT INTO center_banks(center_id, bankname, accountname, accountno, ifsccode, branch,\n\t\tisdefault,\n\t\tcreateddate, createdby)\nVALUES\n\t( '${t.center_id}', '${t.bankname}', '${t.accountname}', \n\t\t'${t.accountno}', '${t.ifsccode}', '${t.branchdetails}', \n\t\t'${!0===t.isdefault?"Y":"N"}',\n\t\t'${e}', '${t.createdby}') `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t("success")}))}))},updateCenterBankInfo:t=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let e=[`${t.bankname}, IFSC: ${t.ifsccode}`,t.accountname,t.accountno,t.ifsc,t.branchdetails,t.center_id];return new Promise((function(t,n){a.query("  update center set  bankname = ?,\n\taccountname = ?, accountno = ?, ifsccode = ?, branch = ?\n\twhere\n\tid = ? ",e,(function(e,a){e&&n(e),t("success")}))}))},updateBank:async t=>{let e=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),n=`  update center_banks set\n\tbankname = '${t.bankname}',\n\taccountname = '${t.accountname}',\n\taccountno = '${t.accountno}',\n\tifsccode = '${t.ifsccode}',\n\tbranch = '${t.branchdetails}',\n\tisdefault = '${!0===t.isdefault?"Y":"N"}',\n\tupdateddate = '${e}',\n\tupdatedby = '${t.updatedby}' \n\twhere id = '${t.id}'\n\t`;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t("success")}))}))},updateBankDefaults:async t=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let e=`  update center_banks set\n\tisdefault = 'N'\n\twhere center_id = '${t}'\n\t`;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t("success")}))}))}}},4698:(t,e,n)=>{var a=n(3076);n(4026),t.exports={getPermissions:(t,e)=>{let n=` select p.* from permissions p\n\twhere\n\tp.center_id = '${t}' and\n\tp.role_id = '${e}' `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},checkUsernameExists:t=>{let e=`\n  select u.id as userid, u.username, u.userpass as userpass, u.firstname, r.name as role, r.id as role_id, c.id as center_id, c.name as center_name, cm.id as company_id,\n\tcm.name as company_name, s.code, p.name as plan_name\n\tfrom\n\tusers u,\n\tuser_role ur,\n\trole r,\n\tcenter c,\n\tstate s,\n\tcompany cm,\n\tplans p,\n\tsubscriptions subs\n\twhere\n\tsubs.plan_id = p.id and\n\tsubs.center_id = u.centerid and\n\tsubs.is_active = 'Y' and\n\n\ts.id = c.state_id and\n\tu.id = ur.user_id and\n\tur.role_id = r.id and\n\tu.centerid = c.id and\n\tcm.id = c.company_id and\n\tusername='${t}'\n\t `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},updateCenterForSuperAdmin:t=>{let e=`  update users set centerid = ${t} where username = 9999999990 `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t("success")}))}))}}},3269:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{toTimeZone:r,currentTimeInTimeZone:s}=n(8372);t.exports={insertBrand:(t,e)=>{let n=`  INSERT INTO brand (center_id, name, createdon, isactive ) VALUES (?, ?, '${s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss")}', 'A')`,r=[t.center_id,t.name];a.query(n,r,(function(t,n){return t?e(t):e(null,n)}))},updateBrand:(t,e,n)=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let r=` \tupdate brand set center_id = '${t.center_id}',\n\tname = '${t.name}' where \n\tid = '${e}'\n\t`;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},getAllBrands:(t,e,n)=>{let r=`select * from brand b\n\t          where \n\t          b.center_id = '${t}' and isactive = '${e}' order by b.name`;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},getSearchBrands:(t,e)=>{let n=`\n\tselect b.*\n\tfrom\n\tbrand b\n\twhere \n\tb.center_id = '${t}' and \n\t( LOWER(b.name) like LOWER('%${e}%')) \n\tlimit 50  `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},getBrandsMissingDiscountsByCustomer:(t,e,n,r)=>{let s=`select b.id, b.name from brand b where b.center_id = '${t}' and b.id not in \n\t\t\t\t\t\t(select distinct d.brand_id \n\t\t\t\t\t\tfrom \n\t\t\t\t\t\tdiscount d\n\t\t\t\t\t\twhere \n\t\t\t\t\t\tb.center_id = '${t}' and isactive = '${e}' and\n\t\t\t\t\t\td.customer_id = '${n}'\n\t\t\t\t\t\t) order by b.name`;a.query(s,(function(t,e){return t?r(t):r(null,e)}))}}},9057:(t,e,n)=>{var a=n(3076);n(4026),t.exports={getCenterDetails:t=>{let e=`select c.*, s.description \n  from \n  center c,\n  state s \n  where \n  c.state_id = s.id and\n  c.id = '${t}'  `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))}}},8361:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{toTimeZone:r,currentTimeInTimeZone:s}=n(8372),i=(t,e)=>{let n=[t.center_id,t.customer_id,t.type,t.value,t.gst_slab,t.startdate,t.enddate,t.brand_id];a.query(" INSERT INTO discount (center_id, customer_id, type, value, gst_slab, startdate, enddate, brand_id)\n  VALUES ( ?, ?, ?, ?, ?, ?, ?, ?) ",n,(function(t,n){return t?e(t):e(null,n)}))},d=(t,e,n)=>{let r=[t.customer_id,t.address1,t.address2,t.district,t.district,t.state_id,t.pin,e];return new Promise((function(t,e){a.query("\n\tINSERT INTO customer_shipping_address (customer_id, address1, address2, address3, district, state_id, pin, def_address, is_active)\n\tVALUES (?, ?, ?, ?, ?, ?, ?, ?, 'A' ) ",r,(function(e,a){return e?handleError(new ErrorHandler("500","Error addCustomerShippingAddress in Customerjs",e),n):t(a.insertId)}))}))};t.exports={getCustomerDiscount:(t,e,n)=>{let r=[t,e];a.query(" select d.id as id, d.customer_id as customer_id, d.center_id as center_id, d.type, d.value, d.gst_slab, d.startdate, d.enddate,\n\tc.name as customer_name\n\t from \n\tdiscount d,\n\tcustomer c\n\twhere \n\tc.id = d.customer_id and\n\td.center_id = ? and d.customer_id =  ? ",r,(function(t,e){return t?n(t):n(null,e)}))},insertCustomerDiscount:i,updateCustomerDiscount:(t,e)=>(t.forEach((t=>{let n=toTimeZoneFrmt(t.startdate,"Asia/Kolkata","DD-MM-YYYY"),r=` update discount set type = '${t.type}', value = '${t.value}', \n                  gst_slab = '${t.gst_slab}', startdate = '${n}', enddate = '${t.enddate}' \n                  where id = '${t.id}' `;a.query(r,(function(t,n){if(t)return e(t)}))})),e(null,1)),insertCustomer:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=[{gstslab:0,gstvalue:t.gstzero},{gstslab:5,gstvalue:t.gstfive},{gstslab:12,gstvalue:t.gsttwelve},{gstslab:18,gstvalue:t.gsteighteen},{gstslab:28,gstvalue:t.gsttwentyeight}],d=`\n\t\tINSERT INTO customer (center_id, name, address1, address2, address3, district, state_id, pin, \n\t\tgst, phone, mobile, mobile2, whatsapp, email, createdon, isactive)\n\t\tVALUES\n\t\t\t(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '${n}', 'A' ) `,o=[t.center_id,t.name,t.address1,t.address2,t.district,t.district,t.state_id,t.pin,t.gst,t.phone,t.mobile,t.mobile2,t.whatsapp,t.email];a.query(d,o,(function(n,d){if(n)return e(n);{r.forEach((e=>{let n={center_id:t.center_id,customer_id:d.insertId,type:t.disctype,value:e.gstvalue,gst_slab:e.gstslab,startdate:s("Asia/Kolkata","DD-MM-YYYY"),enddate:"01-04-9999",brand_id:0};i(n,((t,e)=>{if(t)return handleError(new ErrorHandler("500","Error insertCustomerDiscount",t),res)}))}));let n="\n\tINSERT INTO customer_shipping_address (customer_id, address1, address2, address3, district, state_id, pin, def_address, is_active)\n\tVALUES (?, ?, ?, ?, ?, ?, ?, 'Y', 'A' ) ",o=[d.insertId,t.address1,t.address2,t.district,t.district,t.state_id,t.pin];return a.query(n,o,(function(t,n){if(t)return e(t)})),e(null,{id:d.insertId})}}))},updateCustomer:(t,e,n)=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let r=`\n\tupdate customer set center_id = '${t.center_id}',\n\tname = '${t.name}', address1 = '${t.address1}',address2 = '${t.address2}', address3 = '${t.address3}',\n\tdistrict = '${t.district}', state_id = '${t.state_id}', pin = '${t.pin}',gst = '${t.gst}',\n\tphone = '${t.phone}', mobile = '${t.mobile}',mobile2 = '${t.mobile2}', whatsapp = '${t.whatsapp}',\n\temail = '${t.email}'\n\twhere\n\tid = '${e}'\n\t`;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},getSearchCustomers:(t,e,n)=>{let r=`\n\tselect c.id, c.center_id, c.name, c.address1, c.address2, c.address3, c.district, s.code, s.description,\n\tc.pin, c.gst, c.phone, c.mobile, c.mobile2, c.whatsapp,  c.email, c.isactive,\n\t\tcsa.state_id as csa_state,\ncsa.address1 as csa_address1,\ncsa.address2 as csa_address2, \ncsa.address3 as csa_address3,\ncsa.district as csa_district,\ncsa.pin as csa_pin,\ncsa.def_address as def_address,\ns1.code as csa_code\n\tfrom \n\tcustomer c,\n\tstate s,\n\tstate s1,\n\tcustomer_shipping_address csa  \n\twhere \n\ts1.id = csa.state_id and\n\tcsa.customer_id = c.id and\n\tcsa.def_address = 'Y' and\n\tc.state_id = s.id and isactive = 'A' and center_id = '${t}'  and\n\t( LOWER(c.name) like LOWER('%${e}%')) \n\tlimit 50 `,s=[t,e];a.query(r,s,(function(t,e){return t?n(t):n(null,e)}))},getCustomerDetails:(t,e)=>{let n=`select c.*, s.code,  s.description,\n\tcsa.state_id as csa_state,\n\tcsa.address1 as csa_address1,\n\tcsa.address2 as csa_address2, \n\tcsa.address3 as csa_address3,\n\tcsa.district as csa_district,\n\tcsa.pin as csa_pin,\n\tcsa.def_address as def_address,\n\ts1.code as csa_code,\n\ts1.description as csa_description,\n\tc.credit_amt\n\tfrom \n\tcustomer c,\n\tstate s,\n\tstate s1,\n\tcustomer_shipping_address csa  \n\twhere \n\ts1.id = csa.state_id and\n\ts.id = c.state_id and\n\tcsa.customer_id = c.id and\n\tcsa.def_address= 'Y' and\n\t\n\tc.id = '${e}' and\n\tc.center_id = '${t}' `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},getAllCustomerDefaultDiscounts:(t,e,n)=>{let r=" \n\tSELECT \n\tc.name, 'default' as 'brand_name',   d.type, d.brand_id as brand_id, \n     sum(if( d.gst_slab = 0, d.value, 0 ) ) AS gstzero,  \n     sum(if( d.gst_slab = 5, d.value, 0 ) ) AS gstfive, \n     sum(if( d.gst_slab = 12, d.value, 0 ) ) AS gsttwelve, \n     sum(if( d.gst_slab = 18, d.value, 0 ) ) AS gsteighteen, \n\t\t sum(if( d.gst_slab = 28, d.value, 0 ) ) AS gsttwentyeight,\n\t\t c.id as id, d.startdate  \nFROM \n\tcustomer c,\n    discount d\n    where \n    d.brand_id = 0 and\n\t\td.center_id = ? and\n    c.id = d.customer_id ";""!==e&&(r+=` and c.id = ${e} `),r+=" \n    group by \n    c.name, d.type, d.brand_id, c.id, d.startdate   \n    order by\n    c.name\n\t";let s=[t];a.query(r,s,(function(t,e){return t?n(t):n(null,e)}))},getDiscountsByCustomer:(t,e,n)=>{let r=[t,e,e,e];a.query(" \n\tSELECT \n\tc.name,  '' as 'brand_name',  d.type, d.brand_id as brand_id, \n     sum(if( d.gst_slab = 0, d.value, 0 ) ) AS gstzero,  \n     sum(if( d.gst_slab = 5, d.value, 0 ) ) AS gstfive, \n     sum(if( d.gst_slab = 12, d.value, 0 ) ) AS gsttwelve, \n     sum(if( d.gst_slab = 18, d.value, 0 ) ) AS gsteighteen, \n\t\t sum(if( d.gst_slab = 28, d.value, 0 ) ) AS gsttwentyeight,\n\t\t c.id as id, d.startdate  \nFROM \n\tcustomer c,\n    discount d\n    where \n    d.brand_id = 0 and\n\t\td.center_id = ? and\n\t\tc.id = ? and\n\t\td.customer_id = ?\n    group by \n    c.name, d.type, d.brand_id,c.id, d.startdate      \n    order by\n    c.name\n\t",r,(function(t,e){return t?n(t):n(null,e)}))},getDiscountsByCustomerByBrand:(t,e,n)=>{let r=[t,e];a.query(" \n\tSELECT \n\tc.name,  b.name as 'brand_name',  d.type, d.brand_id as brand_id, \n     sum(if( d.gst_slab = 0, d.value, 0 ) ) AS gstzero,  \n     sum(if( d.gst_slab = 5, d.value, 0 ) ) AS gstfive, \n     sum(if( d.gst_slab = 12, d.value, 0 ) ) AS gsttwelve, \n     sum(if( d.gst_slab = 18, d.value, 0 ) ) AS gsteighteen, \n\t\t sum(if( d.gst_slab = 28, d.value, 0 ) ) AS gsttwentyeight,\n\t\t c.id as id, d.startdate  \nFROM \n\tcustomer c,\n    discount d,\n    brand b\n\t\twhere \n\t\tc.id = d.customer_id and\n    d.brand_id <> 0 and\n\t\td.brand_id = b.id and\n\t\td.center_id = ? and\n\t\tb.center_id = d.center_id and\n\t\td.customer_id = ?\n    group by \n    c.name, d.type, d.brand_id, b.name, c.id, d.startdate      \n    order by\n    c.name, b.name\n\n\t",r,(function(t,e){return t?n(t):n(null,e)}))},getDiscountsByAllCustomerByBrand:(t,e)=>{let n=[t];a.query(" \n\tSELECT \n\tc.name,  b.name as 'brand_name',  d.type, d.brand_id as brand_id, \n     sum(if( d.gst_slab = 0, d.value, 0 ) ) AS gstzero,  \n     sum(if( d.gst_slab = 5, d.value, 0 ) ) AS gstfive, \n     sum(if( d.gst_slab = 12, d.value, 0 ) ) AS gsttwelve, \n     sum(if( d.gst_slab = 18, d.value, 0 ) ) AS gsteighteen, \n\t\t sum(if( d.gst_slab = 28, d.value, 0 ) ) AS gsttwentyeight,\n\t\t c.id as id, d.startdate  \nFROM \n\tcustomer c,\n    discount d,\n    brand b\n    where \n    d.brand_id != 0 and\n\t\td.brand_id = b.id and\n\t\td.center_id = ? \n    \n    group by \n    c.name, d.type, d.brand_id, b.name, c.id, d.startdate      \n    order by\n    c.name, b.name\n\n\t",n,(function(t,n){return t?e(t):e(null,n)}))},updateDefaultCustomerDiscount:(t,e)=>{let n=` \n\tUPDATE discount\n\tSET value = (case when gst_slab = 0 then '${t.gstzero}'\n\twhen gst_slab = 5 then '${t.gstfive}'\n\twhen gst_slab = 12 then '${t.gsttwelve}'\n\twhen gst_slab = 18 then '${t.gsteighteen}'\n\twhen gst_slab = 28 then '${t.gsttwentyeight}'\n\n\t\t\t\t\t\t\t\t\tend),\n\t\t\t\t\t\t\t\t\tstartdate = '${r(t.effDiscStDate,"Asia/Kolkata")}',\n\t\t\ttype= '${t.disctype}'\n\tWHERE \n\tbrand_id = '${t.brand_id}' and\n\tcenter_id = '${t.center_id}' and\n\tcustomer_id = '${t.customer_id}'\n\t`;return a.query(n,(function(t,n){if(t)return e(t)})),e(null,1)},insertDiscountsByBrands:(t,e)=>(s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),[{gstslab:0,gstvalue:t.gstzero},{gstslab:5,gstvalue:t.gstfive},{gstslab:12,gstvalue:t.gsttwelve},{gstslab:18,gstvalue:t.gsteighteen},{gstslab:28,gstvalue:t.gsttwentyeight}].forEach((e=>{let n={center_id:t.center_id,customer_id:t.customer_id,brand_id:t.brand_id,type:t.disctype,value:e.gstvalue,gst_slab:e.gstslab,startdate:r(t.effDiscStDate,"Asia/Kolkata"),enddate:"01-04-9999"};i(n,((t,e)=>{if(t)return handleError(new ErrorHandler("500","Error insertDiscountsByBrands ",t),res)}))})),e(null,"1")),updateCustomerShippingAddress:(t,e,n)=>{if(s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),t.def_address){let r=`update customer_shipping_address set def_address = 'N' where customer_id = '${t.customer_id}' `;a.query(r,(function(r,s){if(r)return n(r);let i=`\n\t\t\tupdate customer_shipping_address set\n\t\t\taddress1 = '${t.address1}',address2 = '${t.address2}',\n\t\t\tdistrict = '${t.district}', state_id = '${t.state_id}', pin = '${t.pin}', def_address = '${!0===t.def_address?"Y":"N"}'\n\t\t\twhere\n\t\t\tid = '${e}'\n\t\t\t`;a.query(i,(function(t,e){return t?n(t):n(null,e)}))}))}else{let r=`\n\t\tupdate customer_shipping_address set\n\t\taddress1 = '${t.address1}',address2 = '${t.address2}',\n\t\tdistrict = '${t.district}', state_id = '${t.state_id}', pin = '${t.pin}', def_address = '${!0===t.def_address?"Y":"N"}'\n\t\twhere\n\t\tid = '${e}'\n\t\t`;a.query(r,(function(t,e){return t?n(t):n(null,e)}))}},insertCustomerShippingAddress:async(t,e,n)=>{let r=!0===t.def_address?"Y":"N",s="";return"Y"===r?(await((t,e)=>{let n=`update customer_shipping_address set def_address = 'N' where customer_id = '${t.customer_id}' `;return new Promise((function(t,r){a.query(n,(function(n,a){if(n)return handleError(new ErrorHandler("500","Error updateAllAddress in Customerjs",n),e);t("updated")}))}))})(t,e),s=await d(t,r,e),n(null,{id:s})):(s=await d(t,r,e),n(null,{id:s}))},getCustomerShippingAddress:(t,e)=>{let n=[t];a.query(" select csa.*, s.description as state_name\nfrom \ncustomer_shipping_address csa,\nstate s \nwhere \ncsa.state_id = s.id and csa.is_active = 'A' and \ncustomer_id = ? order by id desc ",n,(function(t,n){return t?e(t):e(null,n)}))},inactivateCSA:t=>{let e=`\n  update customer_shipping_address\nset is_active = 'I' where\nid = ${t}\n  `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t("UPDATED")}))}))}}},4808:(t,e,n)=>{var a=n(3076);n(2470);const{logger:r}=n(4026);t.exports={getInquirySummary:(t,e,n,r)=>{let s=` select \n  IFNULL(SUM(CASE WHEN e.estatus = 'O' THEN 1 ELSE 0 END), 0) AS 'new',\n  IFNULL(SUM(CASE WHEN e.estatus = 'D' THEN 1 ELSE 0 END), 0) AS 'draft',\n  IFNULL(SUM(CASE WHEN e.estatus = 'E' THEN 1 ELSE 0 END), 0) AS 'executed',\n  IFNULL(SUM(CASE WHEN e.estatus = 'P' THEN 1 ELSE 0 END), 0) AS 'invoiceready',\n  IFNULL(SUM(CASE WHEN e.estatus = 'C' THEN 1 ELSE 0 END), 0) AS 'completed',\n  IFNULL(SUM(CASE WHEN e.estatus = 'X' THEN 1 ELSE 0 END), 0) AS 'cancelled'                   \nfrom\nenquiry e\nwhere\ne.center_id =  '${t}' and\nstr_to_date(DATE_FORMAT(enquiry_date,'%d-%m-%YYYY') , '%d-%m-%YYYY') between\nstr_to_date('${e}', '%d-%m-%YYYY') and\nstr_to_date('${n}', '%d-%m-%YYYY')  `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getSalesSummary:(t,e,n,r)=>{let s=` select \n  IFNULL(SUM(CASE WHEN s.status = 'C' THEN 1 ELSE 0 END), 0) AS 'completed',\n  IFNULL(SUM(CASE WHEN s.status = 'D' THEN 1 ELSE 0 END), 0) AS 'draft'\nfrom\nsale s\nwhere\ns.center_id =  '${t}' and\nSTR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\nstr_to_date('${e}', '%d-%m-%YYYY') and\nstr_to_date('${n}', '%d-%m-%YYYY')      \n `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getPurchaseSummary:(t,e,n,r)=>{let s=` select \n  IFNULL(SUM(CASE WHEN p.status = 'C' THEN 1 ELSE 0 END), 0) AS 'completed',\n  IFNULL(SUM(CASE WHEN p.status = 'D' THEN 1 ELSE 0 END), 0) AS 'draft'\nfrom\npurchase p\nwhere\np.center_id =  '${t}' and\nSTR_TO_DATE(p.invoice_date,'%d-%m-%Y') between\nstr_to_date('${e}', '%d-%m-%YYYY') and\nstr_to_date('${n}', '%d-%m-%YYYY')          \n `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getSaleTotal:(t,e,n,r)=>{let s=` \n\n  select \n    IFNULL(SUM(s.net_total), 0) AS 'sales_total'\n  from\n  sale s\n  where\n  s.center_id =  '${t}' and\nSTR_TO_DATE(s.invoice_date,'%d-%m-%Y') between\nstr_to_date('${e}', '%d-%m-%YYYY') and\nstr_to_date('${n}', '%d-%m-%YYYY')      \n          \n `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getCenterSummary:(t,e,n,r)=>{let s=` select tbl1.active_customers, tbl2.active_vendors from (\n    select count(*) as 'active_customers' from customer where isactive = 'A' and center_id = '${t}' ) as tbl1,\n    (\n    select count(*) as 'active_vendors' from vendor where isactive = 'A' and center_id = '${t}'\n    ) as tbl2 `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getReceivablesOutstanding:(t,e,n,r)=>{let s=` select customer_id, (sum(credit_amt) - sum(debit_amt)) as balance from \n  ledger l\n  where\n  l.center_id = '${t}' \n  group by\n  customer_id\n   `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},getPaymentsByCustomers:(t,e,n,r)=>{let s=` select c.name as customer_name, p.payment_now_amt\n  from \n  payment p,\n  customer c\n  where\n  c.id = p.customer_id and\n  p.center_id =  '${t}' and\n  STR_TO_DATE(p.pymt_date,'%d-%m-%Y') between\n  str_to_date('${e}', '%d-%m-%YYYY') and\n  str_to_date('${n}', '%d-%m-%YYYY')    \n   `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},topClients:(t,e)=>{let n=`\n\t\tselect c.name as customer_name, s.customer_id as id, sum(net_total) as sum_total,\n\t\tcount(s.id) as inv_count\n\t\tfrom \n\t\t\tsale s,\n\t\t\tcustomer c\n\t\twhere\n\t\t\tc.id = s.customer_id and\n\t\t\ts.center_id = '${t}'\n\t\t\tgroup by customer_id \n\t\torder by\n\t\t\tsum_total desc\n\t\t\tlimit ${e} `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))}}},7558:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{handleError:r,ErrorHandler:s}=n(8005),{toTimeZone:i,currentTimeInTimeZone:d}=n(8372);t.exports={insertEnquiryDetail:(t,e,n,r)=>{d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let s=`INSERT INTO enquiry_detail ( enquiry_id, product_id, askqty, product_code, notes, status)\n        values ( '${n}', (select id from product where product_code='${t.product_code}' and center_id = '${e.center_id}'), '${t.quantity}', '${t.product_code}', '${t.notes}', 'O')`;return new Promise((function(t,e){a.query(s,(function(n,a){return n?e(r(n)):t(r(null,a))}))}))},fetchCustomerDetailsByEnqId:(t,e)=>{d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let n=`\n\tselect c.*, e.* from \nenquiry e,\ncustomer c\nwhere\nc.id = e.customer_id and\ne.id = ${t}\n\t`;return new Promise((function(t,r){a.query(n,(function(n,a){return n?r(e(n)):t(e(null,a))}))}))},fetchEnquiryDetailByEnqId:(t,e)=>{d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let n=`\n\tselect orig.*, s.available_stock, s.id as stock_pk\nfrom\n(select ed.*, c.id as customer_id, c.name, c.address1, c.address2, c.district, c.pin, c.gst, c.mobile2, e.remarks, e.estatus,\n\tp.id as pid, p.center_id, p.brand_id, p.product_code as pcode, p.description as pdesc, p.unit, p.packetsize, p.hsncode,\n\tp.currentstock, p.unit_price, p.mrp, p.purchase_price,\n\tp.salesprice, p.rackno, p.location, p.maxdiscount, p.taxrate, \n\tp.minqty, p.itemdiscount, p.reorderqty, p.avgpurprice,\n\tp.avgsaleprice, p.margin\n\tfrom \n\tenquiry e,\n\tcustomer c,\n\tenquiry_detail ed\n\tLEFT outer JOIN product p\n\tON p.id = ed.product_id where\n\te.id = ed.enquiry_id and\n\te.customer_id = c.id and e.id =  ${t}) as orig\n\tLEFT outer JOIN stock s\n\tON orig.product_id = s.product_id and\n\ts.mrp = orig.mrp\n\t`;return new Promise((function(t,r){a.query(n,(function(n,a){return n?r(e(n)):t(e(null,a))}))}))},updateEnquiryDetail:(t,e,n,i,o,c,u,l)=>{let _=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),m="update enquiry_detail ";return m+=""!==t?`\n\t\tset\n\t\t\tproduct_id = '${t}',\n\t\t\tstock_id = '${e}',\n\t\t\tgiveqty = '${n}',\n\t\t\tprocessed = '${i}',\n\t\t\tstatus = '${o}', \n\t\t\tupdatedby = '${u}',\n\t\t\tupdateddate = '${_}'\n\t\t\t`:`\n\t\tset\n\t\t\tgiveqty = '${n}',\n\t\t\tstatus = '${o}',\n\t\t\tupdatedby = '${u}',\n\t\t\tupdateddate = '${_}'\n\t\t\t`,m+=`\n\t\twhere\n\t\tid = '${c}' `,new Promise((function(t,e){a.query(m,(function(e,n){return e?r(new s("500",`Error updateEnquiryDetail QUERY: ${m}`,e),l):t("success")}))}))},insertBackOrder:(t,e,n,i,o,c,u,l)=>{let _=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),m=`\n\t\tinsert into\n\t\t\tbackorder (center_id, customer_id, enquiry_detail_id, qty, reason, status, order_date, createdby, createddate)\n\t\tVALUES ('${t}', '${e}', '${n}', '${i}', '${o}', '${c}', '${d("Asia/Kolkata","DD-MM-YYYY")}', '${u}', '${_}') \n\t`;return new Promise((function(t,e){a.query(m,(function(e,n){return e?r(new s("500",`Error insertBackOrder ${m} `,e),l):t("success")}))}))},updateEnquiry:(t,e,n,i)=>{let o=d("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),c=`update enquiry \n\t\t\tset\n\t\t\t\testatus = '${t}',\n\t\t\t\tprocessed_date = '${o}',\n\t\t\t\tupdatedby = '${n}',\n\t\t\t\tupdateddate = '${o}'\n\n\t\t\twhere\n\t\t\t\tid = '${e}' `;return new Promise((function(t,e){a.query(c,(function(e,n){return e?r(new s("500",`Error updateEnquiry QUERY: ${c}`,e),i):t("success")}))}))},getSuccessfullyProcessedItems:(t,e)=>{let n=`\n\tselect\n\t\tcount(*) as count\n\tfrom \n\t\tenquiry_detail e\n\twhere\n\t\tenquiry_id = '${t}' and\n\t\te.status in ('P', 'F')`;return new Promise((function(t,i){a.query(n,(function(a,i){if(a)return r(new s("500",`Error getSuccessfullyProcessedItems ${n} `,a),e);t(i[0].count)}))}))}}},8461:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{handleError:r,ErrorHandler:s}=n(8005),{toTimeZone:i,toTimeZoneFrmt:d,currentTimeInTimeZone:o,escapeText:c}=n(8372),{insertItemHistoryTable:u,insertToStock:l}=n(3127);t.exports={insertProduct:async(t,e)=>{let n=await function(t,e){let n=o("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),i=c(t.description),d=`insert into \n\t\tproduct \n\t\t\t(center_id, brand_id, product_code, description, unit, packetsize, hsncode, currentstock, unit_price, mrp, \n\t\t\t\tpurchase_price, salesprice, rackno, location, maxdiscount, alternatecode, taxrate, \n\t\t\t\tminqty, itemdiscount, reorderqty, avgpurprice, avgsaleprice, margin, createdon)\n\t\tVALUES\n\t\t\t( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '${n}' ) `,u=[t.center_id,t.brand_id,t.product_code,i,t.unit,t.packetsize,t.hsncode,t.currentstock,t.unit_price,t.mrp,t.purchase_price,t.salesprice,t.rackno,t.location,t.maxdiscount,t.alternatecode,t.taxrate,t.minqty,t.itemdiscount,t.reorderqty,t.avgpurprice,t.avgsaleprice,t.margin];return new Promise((function(t,n){a.query(d,u,(function(n,a){if(n)return r(new s("500","Error insertToProduct in Productjs",n),e);t(a.insertId)}))}))}(t,e);return await l(n,t.mrp,t.currentstock,t.currentstock,e),await u(t.center_id,"Purchase",n,"0","0","0","0","PUR",`New Product - ${t.mrp}`,t.currentstock,"0","0","0","0",e)},updateProduct:(t,e)=>{let n=o("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),i=c(t.description),d=`\n\t\t\tupdate product set center_id = '${t.center_id}', brand_id = '${t.brand_id}',\n\t\t\tproduct_code = '${t.product_code}', description = '${i}',unit = '${t.unit}',\n\t\t\tpacketsize = '${t.packetsize}', hsncode = '${t.hsncode}',currentstock = '${t.currentstock}',\n\t\t\tunit_price = '${t.unit_price}', mrp = '${t.mrp}',purchase_price = '${t.purchase_price}',\n\t\t\tsalesprice = '${t.salesprice}', rackno = '${t.rackno}',location = '${t.location}',\n\t\t\tmaxdiscount = '${t.maxdiscount}', alternatecode = '${t.alternatecode}',taxrate = '${t.taxrate}',\n\t\t\tminqty = '${t.minqty}', itemdiscount = '${t.itemdiscount}',reorderqty = '${t.reorderqty}',\n\t\t\tavgpurprice = '${t.avgpurprice}', avgsaleprice = '${t.avgsaleprice}',margin = '${t.margin}',\n\t\t\trackno = '${t.rackno}', updatedon = '${n}'\n\t\t\twhere\n\t\t\tid = '${t.product_id}'\n\t`;return new Promise((function(t,n){a.query(d,(function(n,a){if(n)return r(new s("500",`QUERY: ${d} Error updateProduct in Productjs`,n),e);t("success")}))}))}}},7393:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{handleError:r,ErrorHandler:s}=n(8005);t.exports={getProductInventoryReport:(t,e,n,r)=>{let s=` select ih.id, module, p.id as product_id, p.product_code as product_code, p.description as product_description,\n  p.mrp as mrp,\n  b.name as brand_name,  ih.module,\n\n  (select invoice_no from purchase where id = ih.purchase_id) as pur_inv_no,\n  (select invoice_no from sale where id = ih.sale_id) as invoice_no,\n  (select cn.credit_note_no \n  from \n  sale_return sr1,\n  credit_note cn\n  where \n  sr1.cr_note_id = cn.id and\n  sr1.id = ih.sale_return_id) as credit_note_no,\n\n  (select invoice_date from purchase where id = ih.purchase_id) as pur_invoice_date,\n(select invoice_date from sale where id = ih.sale_id) as sale_invoice_date,\n(select return_date from sale_return where id = ih.sale_return_id) as sale_return_date,\n\n  ih.actn as actn, ih.actn_type as action_type, abs(ih.txn_qty) as txn_qty, ih.stock_level as stock_level,\n  txn_date as txn_date,\n  ih.sale_id as sale_id,  \n  s.customer_id as customer_id,\n  sr.customer_id as sale_return_customer_id,\n  (select c1.name as customer_name from customer c1 where c1.id =   s.customer_id ) as customer_name,\n  ih.purchase_id as purchase_id, pr.vendor_id,\n  (select v1.name as vendor_name from vendor v1 where v1.id =   pr.vendor_id ) as vendor_name,\n  (select c1.name as customer_name from customer c1 where c1.id =   sr.customer_id ) as sale_return_customer_name\n  from \n  item_history ih\n  LEFT outer JOIN purchase pr \n  ON pr.id  = ih.purchase_id\n  LEFT outer JOIN sale s \n  ON s.id  = ih.sale_id\n  LEFT outer JOIN sale_return sr \n  ON sr.id  = ih.sale_return_id,\n  product p,\n  brand b\n  where \n  b.id = p.brand_id and\n  p.id = ih.product_ref_id and\n  p.id = '${n}' and\n  ih.center_id = '${t}'\n  order by ih.id desc\n  \n  \n  `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))},fullStockReport:(t,e,n)=>{let i="";return i=!0===e?`\n      select b2.name,  \n      product_code, \n      description, \n      mrp, \n      (select sum(s2.available_stock) from stock s2 where s2.product_id = p.id ) available_stock, \n      unit,\n      packetsize, \n      purchase_price , \n      hsncode, \n      taxrate,  \n      rackno \n      from product p , brand b2 \n      where p.center_id = '${t}'\n      and p.brand_id = b2.id \n      and p.center_id = b2.center_id\n      `:`\n      select b.name, p.product_code, p.description,\n      s.product_id, s.mrp, s.available_stock,\n      p.unit, p.packetsize, p.hsncode, \n      p.mrp, p.purchase_price,\n      p.rackno, p.taxrate\n      from \n      product p,\n      brand b,\n      stock s\n      where \n      s.product_id = p.id and\n      p.brand_id = b.id and\n      p.center_id = '${t}'\n      group by\n      s.product_id, s.mrp, s.available_stock `,new Promise((function(t,e){a.query(i,(function(e,a){if(e)return r(new s("500",`fullStockReport ${i} `,e),n);t(a)}))}))}}},8913:(t,e,n)=>{var a=n(3076);n(2470),n(4026),t.exports={getProductSummaryReport:(t,e,n,r)=>{let s=`\n  select p.id as id, c.name as center_name, b.name as brandname, p.product_code as code, p.description as description, p.hsncode as hsncode, p.unit as unit, p.packetsize as packetsize, p.unit_price as unit_price, \ns.available_stock as available_stock, s.mrp as mrp, p.taxrate as tax_rate, \ns.open_stock as open_stock, p.rackno as rakno,\ns.updateddate as last_updated\nfrom \nproduct p,\nbrand b,\nstock s,\ncenter c\nwhere\nc.id = p.center_id and\np.brand_id = b.id and\np.id = s.product_id and\np.center_id = '${t}' \norder by p.id\nlimit ${e}, ${n}\n  `;a.query(s,(function(t,e){return t?r(t):r(null,e)}))}}},428:(t,e,n)=>{var a=n(3076);n(2470),n(4026),t.exports={getStatement:(t,e,n,r,s)=>{let i=`\n\t\tselect STR_TO_DATE(a.ref_date , '%d-%m-%Y') ref_date_f, a.name,a.place ,a.type, a.refn , a.\t\t\t\t\t\t\t\t\tinvoice_amount , a.Received_Amount, a.id as id\n\t\tFrom (\n\t\t\tselect s.invoice_no refn ,s.invoice_date ref_date, "Invoice" type,\n\t\t\t(select c.name from customer c where c.id = s.customer_id) name ,\n\t\t\t(select c.district from customer c where c.id = s.customer_id) place \n\t\t\t, s.net_total invoice_amount , "" Received_Amount, s.customer_id as id \n\t\t\tFrom  sale s \n\t\twhere s.center_id = '${t}'\n\t\tand s.sale_type = '${s}'\n\t\tand s.status = 'C'\n\t\t `;return i+=`\n\tand str_to_date(s.invoice_date,  '%d-%m-%Y %T') between\n\tstr_to_date('${n}',  '%d-%m-%Y %T') and\n\tstr_to_date('${r}',  '%d-%m-%Y %T') \t\n\t`,"all"!==e&&(i+=` and s.customer_id = '${e}' `),i+=` union\n\t\t\tselect \n\t\t\t\tp.bank_ref refn, p.pymt_date ref_date, "Payment" type,\n\t\t\t\t(select c.name from customer c where c.id = p.customer_id) name \t,\n\t\t\t\t(select c.district from customer c where c.id = p.customer_id) place, \n\t\t\t\t"" invoice_amount , p.payment_now_amt Received_Amount, p.customer_id as id \n\t\t\tFrom\n\t\t\t\tpayment p\n\t\t\twhere\n\t\t\t\tp.center_id = '${t}'\n\t\t\t\tand p.is_cancelled = 'NO'\n\t\t\t\t `,i+=`\n\t\t\t\tand str_to_date(p.pymt_date,  '%d-%m-%Y %T') between\n\t\t\t\tstr_to_date('${n}',  '%d-%m-%Y %T') and\n\t\t\t\tstr_to_date('${r}',  '%d-%m-%Y %T') \t\n\t\t\t\t`,"all"!==e&&(i+=` and p.customer_id = '${e}' `),i+=" )a order by a.name , ref_date_f ",new Promise((function(t,e){a.query(i,(function(n,a){n&&e(n),t(a)}))}))},getVendorStatement:(t,e,n,r)=>{let s=` \n  select \nany_value(l.center_id) as center_id, \nany_value(l.vendor_id) as vendor_id, \nany_value(l.ledger_detail) as txn_type, \nany_value(l.credit_amt) as credit_amt, \nany_value(l.debit_amt) as debit_amt, \nany_value(l.balance_amt) as balance_amt, \nany_value(l.ledger_date) as ledger_date,\n\t(select s.invoice_no from purchase s where s.id = l.purchase_ref_id) as purchase_ref_id,\nany_value((select p.vendor_payment_no from vendor_payment p where p.id = l.payment_ref_id)) as payment_ref_id\n\t from purchase_ledger l\n\t where \n\t l.center_id =  '${t}' and l.vendor_id = '${e}' and\n\t ledger_date between '${n}' and '${r}'\n\t group by purchase_ref_id, payment_ref_id\n\t order by ledger_date\n  \n  `;return new Promise((function(t,e){a.query(s,(function(n,a){n&&e(n),t(a)}))}))},getItemWiseSale:(t,e,n,r,s,i,d)=>{let o=` \n\t\tselect \n\t\t\tp2.product_code , \n\t\t\tp2.description , \n\t\t\tp2.brand_id , \n\t\t\tb.name as brand_name,\n\t\t\tsum(sd.qty) qty, \n\t\t\tsum(sd.taxable_value)/sum(sd.qty) avg_SP \n\t\tfrom \n\t\t\tsale s2 , \n\t\t\tsale_detail sd , \n\t\t\tproduct p2,\n\t\t\tbrand b \n\t\twhere \n\t\t\tb.id = p2.brand_id and\n\t\t\ts2.id = sd.sale_id and  \n\t\t\ts2.center_id = '${t}' and \n\t\t\tsd.product_id = p2.id `;return"all"!==e&&(o+=` and p2.brand_id = '${e}' `),"all"!==s&&(o+=` and s2.sale_type  = '${s}' `),o+=` \n\tand str_to_date(sale_datetime,  '%d-%m-%Y %T') between\n\tstr_to_date('${n}',  '%d-%m-%Y %T') and\n\tstr_to_date('${r}',  '%d-%m-%Y %T') \t\n\t\n\tgroup by \n\t\tp2.product_code , \n\t\tp2.description , \n\t\tp2.brand_id\n\torder by \n\t\tqty desc\n\t\n\t`,new Promise((function(t,e){a.query(o,(function(n,a){n&&e(n),t(a)}))}))},getReceivablesClosingBalance:(t,e,n,r,s)=>{let i=`\n\t\t\t\t\t\tselect id, name , district, sum(invcd +  pymnt_rcvd*-1) as balance\n\t\t\t\t\t\tFrom \n\t\t\t\t\t\t(\n\t\t\t\t\t\tselect c2.id, c2.name , c2.district , IFNULL( sum(s.net_total),0) invcd, '0' pymnt_rcvd\n\t\t\t\t\t\tfrom sale s , customer c2 \n\t\t\t\t\t\twhere s.center_id = '${t}'\n\t\t\t\t\t\tand s.status = 'C'\n\t\t\t\t\t\tand s.sale_type = '${s}' `;return"all"!==e&&(i+=` and s.customer_id = '${e}' `),i+=" and c2.center_id = s.center_id \n\t\t\t\t\t\tand c2.id = s.customer_id ",i+=`\tand STR_TO_DATE(s.invoice_date,'%d-%m-%y') <= STR_TO_DATE('${r}','%d-%m-%y')\n\t\t\t\t\t\tgroup by c2.id,c2.name , c2.district \n\t\t\t\t\t\tUNION \n\t\t\t\t\t\tselect c2.id,c2.name , c2.district,'0' invcd, IFNULL(sum(p2.payment_now_amt ),0) pymnt_rcvd\n\t\t\t\t\t\tfrom payment p2 , customer c2 \n\t\t\t\t\t\twhere p2.center_id = '${t}' `,"all"!==e&&(i+=` and p2.customer_id = '${e}' `),i+="\n\t\t\t\t\tand c2.center_id = p2.center_id \n\t\t\t\t\tand c2.id = p2.customer_id ",i+=` and  STR_TO_DATE(p2.pymt_date,'%d-%m-%y') <= STR_TO_DATE('${r}','%d-%m-%y') \t`,i+=" GROUP by c2.id,c2.name , c2.district\n\t\t\t\t\t) a \n\t\t\t\t\tgroup by id, name , district\n\t\t\t\t\torder by a.name\n\n\t\t ",new Promise((function(t,e){a.query(i,(function(n,a){n&&e(n),t(a)}))}))},getReceivablesOpeningBalance:(t,e,n,r,s)=>{let i=`\n\t\t\t\t\t\tselect id, name , district, sum(invcd +  pymnt_rcvd*-1) as balance\n\t\t\t\t\t\tFrom \n\t\t\t\t\t\t(\n\t\t\t\t\t\tselect c2.id, c2.name , c2.district , IFNULL( sum(s.net_total),0) invcd, '0' pymnt_rcvd\n\t\t\t\t\t\tfrom sale s , customer c2 \n\t\t\t\t\t\twhere s.center_id = '${t}'\n\t\t\t\t\t\tand s.status = 'C'\n\t\t\t\t\t\tand s.sale_type = '${s}' `;return"all"!==e&&(i+=` and s.customer_id = '${e}' `),i+=" and c2.center_id = s.center_id \n\t\t\t\t\t\tand c2.id = s.customer_id ",i+=`\tand STR_TO_DATE(s.invoice_date,'%d-%m-%y') < STR_TO_DATE('${n}','%d-%m-%y')\n\t\t\t\t\t\tgroup by c2.id,c2.name , c2.district \n\t\t\t\t\t\tUNION \n\t\t\t\t\t\tselect c2.id,c2.name , c2.district,'0' invcd, IFNULL(sum(p2.payment_now_amt ),0) pymnt_rcvd\n\t\t\t\t\t\tfrom payment p2 , customer c2 \n\t\t\t\t\t\twhere p2.center_id = '${t}' `,"all"!==e&&(i+=` and p2.customer_id = '${e}' `),i+="\n\t\t\t\t\tand c2.center_id = p2.center_id \n\t\t\t\t\tand c2.id = p2.customer_id ",i+=` and  STR_TO_DATE(p2.pymt_date,'%d-%m-%y') < STR_TO_DATE('${n}','%d-%m-%y') \t`,i+=" GROUP by c2.id,c2.name , c2.district\n\t\t\t\t\t) a \n\t\t\t\t\tgroup by id, name , district\n\t\t\t\t\torder by a.name\n\n\t\t ",new Promise((function(t,e){a.query(i,(function(n,a){n&&e(n),t(a)}))}))}}},5705:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{toTimeZone:r,currentTimeInTimeZone:s,toTimeZoneFrmt:i}=n(8372),{updateStock:d}=n(3127),{insertItemHistoryTable:o}=n(3127),{handleError:c,ErrorHandler:u}=n(8005),l=(t,e,n)=>{let r=` INSERT INTO sale_return_detail(sale_return_id, sale_id, sale_detail_id, return_qty, \n              reason, disc_percent, tax, mrp,\n              igst, cgst, sgst, orig_sold_qty, taxable_value, total_value, hsncode, unit)\n              VALUES\n              ( '${e}', '${n.sale_id}', '${t.id}', '${t.received_now}', \n              '${t.reason}', '${t.disc_percent}', '${t.tax}', \n              '${t.mrp}', '${t.igst}', '${t.cgst}', '${t.sgst}', \n              '${t.qty}', '${t.taxable_value}', '${t.total_value}', '${t.hsncode}', '${t.unit}' ) `;return new Promise(((t,e)=>{a.query(r,(function(n,a){n?e("Error while inserting sale details return table"):t(a.insertId)}))}))},_=t=>{let e=` update sale_detail set returned = returned + '${t.received_now}' where id = '${t.id}' `;return new Promise(((t,n)=>{a.query(e,(function(e,a){e?n("Error while updating sale details with returns"+JSON.stringify(e)):t("success")}))}))};t.exports={insertSaleReturns:t=>{let e=s("Asia/Kolkata","DD-MM-YYYY");return new Promise(((n,r)=>{let s=` insert into sale_return (sale_id, customer_id, return_date, center_id, to_return_amount,\n                  to_receive_items, receive_status, refund_status, return_status )\n                  VALUES ('${t.sale_id}', '${t.customer_id}', '${e}', '${t.center_id}' , '${t.to_return_amount}', \n                  '${t.to_receive_items}', 'NR', 'R', 'A')  `;a.query(s,(function(t,e){t?r("Error inserting sale returns"+JSON.stringify(t)):n(e.insertId)}))}))},insertSaleReturnDetail:async(t,e,n,a)=>new Promise((async(r,s)=>{for(const r of t){let t=await l(r,e,n);await _(r),await d(r.received_now,r.product_id,r.mrp,"add",a),await o(n.center_id,"SaleReturn",r.product_id,"0","0","0","0","SRTN","Sale/Return",r.received_now,e,t,"0","0",a)}r("done")})),insertSaleDetailReturn:l,updateSaleDetail:_,createCreditNote:(t,e,n)=>{let r=` INSERT INTO credit_note(credit_note_no, credit_note_total_amount, refund_status)\n              VALUES\n\t\t\t\t\t\t\t( '${t}', '${e}', '${n}' ) `;return new Promise(((t,e)=>{a.query(r,(function(n,a){n?e("Error while inserting createCreditNote "):t(a.insertId)}))}))},updateCRAmntToCustomer:function(t,e){let n=`\n\t\tupdate customer c, sale s\n\t\tset \n\t\tc.credit_amt = c.credit_amt + ${e}\n\t\twhere\n\t\ts.customer_id = c.id and\n\t\ts.id = '${t}' `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},updateCRSequenceGenerator:function(t){let e="";return e=`\n\t\tupdate financialyear set cr_note_seq = cr_note_seq + 1 where \n\t\tcenter_id = '${t}' and  \n\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},getSequenceCrNote:function(t){let e="";return e=` select concat("CN-",'${s("Asia/Kolkata","YY")}', "/", '${s("Asia/Kolkata","MM")}', "/", lpad(cr_note_seq, 5, "0")) as crNoteNo from financialyear \n\t\t\t\twhere \n\t\t\t\tcenter_id = '${t}' and  \n\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `,new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a[0].crNoteNo)}))}))},updateCrNoteIdInSaleReturnTable:function(t,e){let n=`\n\tupdate sale_return set cr_note_id = ${t}\n\twhere id = \t${e}\t `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},getSaleReturnDetails:(t,e,n)=>{let r=` select p.id, p.product_code, p.description, srd.* from \n\tsale_return_detail srd,\n\tproduct p,\n\tsale_detail sd\n\twhere \n\tp.id = sd.product_id and\n\tsd.id = srd.sale_detail_id and\n\tsrd.sale_return_id = '${e}'\n\t\t`;return new Promise((function(s,i){a.query(r,(function(a,i){if(a)return c(new u("500",`/get-sale-return-details/:center_id/:salre_return_id QUERY: ${r} params ${t} ${e}`,a),n);s(i)}))}))}}},7590:(t,e,n)=>{"use strict";const a=n(5747),r=n(6779),s=(n(4026),n(3599));t.exports={printSaleInvoice:function(t,e){let n=new s({size:"A4",margin:50});n.table({headers:["Word","Comment","Summary"],rows:[["Apple","Not this one","Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla viverra at ligula gravida ultrices. Fusce vitae pulvinar magna."],["Tire","Smells like funny","Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla viverra at ligula gravida ultrices. Fusce vitae pulvinar magna."]]},{prepareHeader:()=>n.font("Helvetica-Bold"),prepareRow:(t,e)=>n.font("Helvetica").fontSize(12)}),n.moveDown().table({headers:["Country","Conversion rate","Trend"],rows:[["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"],["Switzerland","12%","+1.12%"],["France","67%","-0.98%"],["England","33%","+4.44%"]]},100,350,{width:300}),n.end(),n.pipe(a.createWriteStream(t)),n.pipe(r()),e.contentType("application/pdf"),n.pipe(e)}}},7071:(t,e,n)=>{var a=n(3076);n(4026),t.exports={getReturns:(t,e)=>{let n=` select c.name as customer_name, s.invoice_no as invoice_no,\n  sum(sd.returned) as returned, sr.return_date as returned_date\n  from \n  customer c,\n  sale s,\n  sale_return sr,\n  sale_detail sd\n  where\n  sr.sale_id = s.id and\n  c.id = s.customer_id and\n  sd.sale_id = s.id and\n  sr.center_id = ${t}\n  group by \n  customer_name,\n  invoice_no, returned_date `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},saleReturnPaymentMaster:(t,e,n,r,s,i)=>{let d=`\n\t\tinsert into payment ( center_id, customer_id, payment_no, payment_now_amt, advance_amt_used, pymt_date, pymt_mode_ref_id, pymt_ref)\n\t\tVALUES ( '${t}', '${e}', '${n}', '${r}',\n     '${s}', '${i}', (select id from payment_mode where center_id = '${t}' and pymt_mode_name = 'Credit Note'), 'Credit Note' ) `;return new Promise((function(t,e){a.query(d,(function(n,a){n&&e(n),t(a)}))}))}}},5241:(t,e,n)=>{var a=n(3076);n(4026);const{toTimeZone:r,currentTimeInTimeZone:s,toTimeZoneFrmt:i}=n(8372),{insertItemHistoryTable:d}=n(3127);t.exports={getSalesMaster:(t,e)=>{let n=`select s.*, c.name, c.address1, c.address2, c.district \n\tfrom sale s,\n\tcustomer c where s.customer_id = c.id and s.id = '${t}' `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},getSalesDetails:function(t){let e=` select sd.*, sd.id as id, sd.sale_id as sale_id,\n\t\t\t\t\t\t\tsd.product_id as product_id, sd.qty as qty,sd.unit_price as unit_price,\n\t\t\t\t\t\t\tsd.mrp as mrp, sd.batchdate as batchdate, sd.tax as tax, sd.igst as igst,\n\t\t\t\t\t\t\tsd.cgst as cgst, sd.sgst as sgst, sd.taxable_value as tax_value,\n\t\t\t\t\t\t\tsd.total_value as total_value, p.product_code, p.description, p.packetsize, p.taxrate,\n\t\t\t\t\t\t\tp.hsncode, p.unit,\n\t\t\t\t\t\t\ts.id as stock_pk, s.mrp as stock_mrp, s.available_stock as stock_available_stock\n\t\t\t\t\t\t\tfrom \n\t\t\t\t\t\t\tsale_detail sd, product p, stock s\n\t\t\t\t\t\t\twhere\n\t\t\t\t\t\t\tp.id = sd.product_id and s.product_id = p.id and\n\t\t\t\t\t\t\ts.id = sd.stock_id and sd.sale_id = '${t}' `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},insertSaleDetails:(t,e)=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let n=`INSERT INTO enquiry_detail ( enquiry_id, product_id, askqty, product_code, notes, status)\n        values ( '${tmpid}', (select id from product where product_code='${t.product_code}' and center_id = '${jsonObj.center_id}'), '${t.quantity}', '${t.product_code}', '${t.notes}', 'O')`;return new Promise((function(t,r){a.query(n,(function(n,a){return n?r(e(n)):t(e(null,a))}))}))},IUSaleDetailsAsync:t=>{let e=`INSERT INTO sale_detail(sale_id, product_id, qty, disc_percent, disc_value, disc_type, unit_price, mrp, batchdate, tax,\n\t\tigst, cgst, sgst, taxable_value, total_value, stock_id) VALUES\n\t\t( '${newPK}', '${t.product_id}', '${t.qty}', '${t.disc_percent}', '${t.disc_value}', '${t.disc_type}', '${(t.total_value-t.disc_value)/t.qty}', '${t.mrp}', \n\t\n\t\t'${s("Asia/Kolkata","DD-MM-YYYY")}',\n\t\t'${t.taxrate}', '${t.igst}', \n\t\t'${t.cgst}', '${t.sgst}', '${t.taxable_value}', '${t.total_value}', '${t.stock_pk}')`,n=`update sale_detail set product_id = '${t.product_id}', qty = '${t.qty}', disc_percent = '${t.disc_percent}', \ndisc_value = '${t.disc_value}',\tdisc_type= '${t.disc_type}', unit_price = '${(t.total_value-t.disc_value)/t.qty}', mrp = '${t.mrp}', \n\t\tbatchdate = '${s("Asia/Kolkata","DD-MM-YYYY")}', tax = '${t.taxrate}',\n\t\tigst = '${t.igst}', cgst = '${t.cgst}', sgst = '${t.sgst}', \n\t\ttaxable_value = '${t.taxable_value}', total_value = '${t.total_value}', stock_id = '${t.stock_pk}'\n\t\twhere\n\t\tid = '${t.sale_det_id}' `;return new Promise((function(r,s){a.query(""===t.sale_det_id?e:n,(function(t,e){t&&s(t),r(e)}))}))},updateProductAsync:t=>{let e=` update product set currentstock = (select sum(available_stock) \n\t\t\t\t\t\t\t\tfrom stock where product_id = '${t.product_id}' ) where id = '${t.product_id}' `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},insertItemHistoryAsync:async(t,e,n,a,r)=>{let i=!1;new Date,s("Asia/Kolkata","DD-MM-YYYY HH:mm:ss");let o=""===t.sale_det_id?n:t.sale_det_id,c=""===t.sale_det_id?t.qty:t.qty-t.old_val,u="Sold",l=""===e?t.sale_id:e;0===a.revision&&0===c&&"stockissue"!==a.invoicetype&&(c=t.qty),c<0?(u=`Edited: ${t.old_val} To: ${t.qty}`,c=t.old_val-t.qty):c>0&&a.revision>0&&(u=`Edited: ${t.old_val} To: ${t.qty}`,c=t.qty-t.old_val),a.revision>0&&0===c&&"stockissue"!==a.invoicetype&&(i=!0),0===a.revision&&0===c&&"stockissue"===a.invoicetype&&(i=!0),c=1+~c,0===c||i||await d(a.center_id,"Sale",t.product_id,"0","0",l,o,"SAL",u,c,"0","0","0","0",r)},getNextSaleInvoiceNoAsync:(t,e)=>{let n="",r=s("Asia/Kolkata","YY"),i=s("Asia/Kolkata","MM");return"stockissue"===e?n=`select concat('SI',"-",'${r}', "/", '${i}', "/", lpad(stock_issue_seq + 1, 5, "0")) as NxtInvNo from financialyear  where \n\t\t\t\t\tcenter_id = '${t}' and  \n\t\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `:"gstinvoice"===e&&(n=`select concat('${r}', "/", '${i}', "/", lpad(invseq + 1, 5, "0")) as NxtInvNo from financialyear  where \n\t\t\t\t\tcenter_id = '${t}' and  \n\t\t\t\t\tCURDATE() between str_to_date(startdate, '%d-%m-%Y') and str_to_date(enddate, '%d-%m-%Y') `),new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))},insertAuditTblforDeleteSaleDetailsRecAsync:(t,e)=>{let n=s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss"),r=`\n\tINSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn, old_value, new_value, audit_date, center_id)\n\tVALUES\n\t\t('Sales', '${e}', '${t.id}', 'delete', \n\t\t(SELECT CONCAT('[{', result, '}]') as final\n\t\tFROM (\n\t\t\tSELECT GROUP_CONCAT(CONCAT_WS(',', CONCAT('"saleId": ', sale_id), CONCAT('"productId": "', product_id, '"'), CONCAT('"qty": "', qty, '"')) SEPARATOR '},{') as result\n\t\t\tFROM (\n\t\t\t\tSELECT sale_id, product_id, qty\n\t\t\t\tFROM sale_detail where id = '${t.id}'\n\t\t\t) t1\n\t\t) t2)\n\t\t, '', '${n}', (select center_id from sale where id = '${e}')\n\t\t) `;return new Promise((function(t,e){a.query(r,(function(n,a){n&&e(n),t(a)}))}))},deleteSaleDetailsRecAsync:t=>{let e=`\n\tdelete from sale_detail where id = '${t.id}' `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},updateLegerCustomerChange:(t,e,n,r)=>{let i=s("Asia/Kolkata","DD-MM-YYYY HH:mm:ss"),d=`delete from ledger where customer_id =  '${r}'\n\tand invoice_ref_id = '${e}'  and center_id = '${t}' `;return new Promise((function(s,o){a.query(d,(function(s,d){s&&o(s);let c=` INSERT INTO audit_tbl (module, module_ref_id, module_ref_det_id, actn,\n\t\t\t\t\t\t\t\t\t\t\told_value, new_value, audit_date, center_id)\n\t\t\t\t\t\t\t\t\t\t\tVALUES\n\t\t\t\t\t\t\t\t\t\t\t('Leger', '${e}', '${e}', 'Customer Updated',  '${r}',\n\t\t\t\t\t\t\t\t\t\t\t'${n}', '${i}', '${t}' ) `;return new Promise((function(t,e){a.query(c,(function(n,a){n&&e(n),t(a)}))}))}))}))},deleteSaleDetail:async(t,e)=>{let n=`\n\t\t\t\tdelete from sale_detail where id = '${t}' `;await new Promise((function(t,r){a.query(n,(function(n,a){if(n)return r(handleError(new ErrorHandler("500","Error deleting sale details",n),e));t(a)}))}))},updatePrintCounter:t=>{s("Asia/Kolkata","DD-MM-YYYY HH:mm:ss");let e=` update sale\n\tset print_count = CASE\n\t\t WHEN print_count= -1 then print_count + 2\n\t\t ELSE print_count + 1\n\t\tEND\n\t\twhere id = '${t}' `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t("updated")}))}))},getPrintCounter:t=>{s("Asia/Kolkata","DD-MM-YYYY HH:mm:ss");let e=` select print_count from sale where id = '${t}'  `;return new Promise((function(t,n){a.query(e,(function(e,a){e&&n(e),t(a)}))}))},duplicateInvoiceNoCheck:(t,e)=>{s("Asia/Kolkata","DD-MM-YYYY HH:mm:ss");let n=` select count(*) as count from sale where invoice_no = '${t}' and center_id = '${e}' `;return new Promise((function(t,e){a.query(n,(function(n,a){n&&e(n),t(a)}))}))}}},3127:(t,e,n)=>{var a=n(3076);n(4026);const{toTimeZone:r,toTimeZoneFrmt:s,currentTimeInTimeZone:i}=n(8372),{handleError:d,ErrorHandler:o}=n(8005);t.exports={insertItemHistoryTable:(t,e,n,r,s,c,u,l,_,m,p,y,f,g,v)=>{let h=i("Asia/Kolkata","DD-MM-YYYY HH:mm:ss"),w=`\ninsert into item_history (center_id, module, product_ref_id, purchase_id, purchase_det_id, sale_id, sale_det_id, actn, actn_type, txn_qty, stock_level, txn_date, sale_return_id, sale_return_det_id, purchase_return_id, purchase_return_det_id)\nvalues ('${t}', '${e}', '${n}', '${r}', '${s}',\n'${c}', '${u}',\n'${l}', '${_}', '${m}', `;return w+=`\t(select IFNULL(sum(available_stock), 0) as available_stock  from stock where product_id = '${n}'  ), `,w+=`\t\n\t\t\t '${h}', '${p}', '${y}', '${f}', '${g}' ) `,new Promise((function(t,e){a.query(w,(function(e,n){if(e)return console.log("dinesh "+JSON.stringify(e)),console.log("dinesh "+w),d(new o("500","Error insertItemHistoryTable in Stockjs",e),v);t(n)}))}))},updateStock:(t,e,n,r,s)=>{let i="add"===r?`update stock set available_stock =  available_stock + '${t}' where product_id = '${e}' and mrp = '${n}' `:`update stock set available_stock =  available_stock - '${t}' where product_id = '${e}' and mrp = '${n}' `;return new Promise((function(t,e){a.query(i,(function(n,a){return n?e(new o("500",`Error updateStock in Stockjs. QUERY: ${i}`,n),s):t(a)}))}))},updateStockViaId:(t,e,n,r,s)=>{let i="add"===r?`update stock set available_stock =  available_stock + '${t}' where product_id = '${e}' and id = '${n}' `:`update stock set available_stock =  available_stock - '${t}' where product_id = '${e}' and id = '${n}' `;return new Promise((function(t,e){a.query(i,(function(n,a){return n?e(new o("500",`Error updateStockViaId in Stockjs. QUERY: ${i}`,n),s):t(a)}))}))},isStockIdExist:(t,e)=>{todayYYMMDD=i("Asia/Kolkata","YYYY-MM-DD");let n=`\n\tselect count(*) as count from stock where product_id = '${t.product_id}' and mrp  = '${t.mrp}' `;return new Promise((function(t,r){a.query(n,(function(a,s){if(a)return r(new o("500",`Error checkStockIdPresent in Purchasejs. ${n}`,a),e);t(s[0].count)}))}))},insertToStock:(t,e,n,r,i)=>{let c=new Date;todayYYMMDD=s(c,"Asia/Kolkata","YYYY-MM-DD");let u=`\n\tinsert into stock (product_id, mrp, available_stock, open_stock, updateddate)\n\tvalues ('${t}', '${e}', '${n}', '${r}' , '${todayYYMMDD}')`;return new Promise((function(t,e){a.query(u,(function(e,n){if(e)return d(new o("500","Error insertToStock in stockjs",e),i);t(n)}))}))},correctStock:(t,e,n,r)=>{let s=`update stock set available_stock =  '${n}' where product_id = '${t}' and mrp = '${e}' `;return new Promise((function(t,e){a.query(s,(function(n,a){if(n)return e(new o("500",`Error correctStock in Stockjs. QUERY: ${s}`,n),r);t("updated")}))}))},getProductWithAllMRP:(t,e)=>{todayYYMMDD=i("Asia/Kolkata","YYYY-MM-DD");let n=` select \n\ts.id as stock_id, \n\ts.product_id as product_id,\n\tp.description as product_description,\n\ts.mrp, \n\ts.available_stock, \n\ts.open_stock \n\tfrom \n\tstock s,\n\tproduct p\n\twhere\n\tp.id = s.product_id and\n\ts.product_id = '${t}'\n\t `;return new Promise((function(t,r){a.query(n,(function(a,s){if(a)return r(new o("500",`Error getProductWithAllMRP in stock.js. ${n}`,a),e);t(s)}))}))},deleteProductFromStock:async(t,e,n)=>{todayYYMMDD=i("Asia/Kolkata","YYYY-MM-DD");let r=`delete from stock where product_id = ${t} and mrp = ${e}`;return new Promise((function(t,e){a.query(r,(async function(a,s){if(a)return e(new o("500",`Error getProductWithAllMRP in stock.js. ${r}`,a),n);t("deleted")}))}))},updateLatestProductMRP:(t,e,n)=>{let r=`\n\tupdate product set \nmrp = (select max(mrp) from stock where\nproduct_id = '${t}')\nwhere \nid = '${t}' and\ncenter_id = '${e}'\n`;return new Promise((function(t,e){a.query(r,(function(a,s){return a?e(new o("500",`Error updateLatestProductMRP in Stockjs. QUERY: ${r}`,a),n):t(s)}))}))}}},8647:(t,e,n)=>{var a=n(3076);n(2470),n(4026);const{toTimeZone:r,currentTimeInTimeZone:s}=n(8372);t.exports={insertVendor:(t,e)=>{let n=`\n\t\tINSERT INTO vendor (center_id, name, address1, address2, address3, district, state_id, pin, \n\t\tgst, phone, mobile, mobile2, whatsapp, email, createdon, isactive)\n\t\tVALUES\n\t\t\t(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, '${s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss")}', 'A'\n\t\t\t) `,r=[t.center_id,t.name,t.address1,t.address2,t.address3,t.district,t.state_id,t.pin,t.gst,t.phone,t.mobile,t.mobile2,t.whatsapp,t.email];a.query(n,r,(function(t,n){return t?e(t):e(null,n)}))},updateVendor:(t,e,n)=>{s("Asia/Kolkata","YYYY-MM-DD HH:mm:ss");let r=`\n\tupdate vendor set center_id = '${t.center_id}',\n\tname = '${t.name}', address1 = '${t.address1}',address2 = '${t.address2}', address3 = '${t.address3}',\n\tdistrict = '${t.district}', state_id = '${t.state_id}', pin = '${t.pin}',gst = '${t.gst}',\n\tphone = '${t.phone}', mobile = '${t.mobile}', mobile2 = '${t.mobile2}', whatsapp = '${t.whatsapp}',\n\temail = '${t.email}'\n\twhere\n\tid = '${e}'\n\t`;a.query(r,(function(t,e){return t?n(t):n(null,e)}))},getSearchVendors:(t,e,n)=>{let r=`\n\tselect v.id, v.center_id, v.name, v.address1, v.address2, v.district, \n\tv.pin, v.gst, v.phone, v.mobile, v.mobile2, v.whatsapp,  v.email, v.isactive, s.code as code\n\tfrom\n\tvendor v,\n\tstate s\n\twhere \n\tv.state_id = s.id and isactive = 'A' and center_id = '${t}' and \n\t( LOWER(v.name) like LOWER('%${e}%')) \n\tlimit 50  `,s=[t,e];a.query(r,s,(function(t,e){return t?n(t):n(null,e)}))}}},2376:t=>{"use strict";t.exports=require("axios")},6552:t=>{"use strict";t.exports=require("bcrypt")},6779:t=>{"use strict";t.exports=require("blob-stream")},479:t=>{"use strict";t.exports=require("cors")},334:t=>{"use strict";t.exports=require("dotenv")},1201:t=>{"use strict";t.exports=require("dotenv/config")},2127:t=>{"use strict";t.exports=require("express")},8928:t=>{"use strict";t.exports=require("formidable")},5747:t=>{"use strict";t.exports=require("fs")},8605:t=>{"use strict";t.exports=require("http")},7211:t=>{"use strict";t.exports=require("https")},6455:t=>{"use strict";t.exports=require("log4js")},2470:t=>{"use strict";t.exports=require("moment")},1289:t=>{"use strict";t.exports=require("moment-timezone")},366:t=>{"use strict";t.exports=require("mysql")},3863:t=>{"use strict";t.exports=require("pdfkit")},6356:t=>{"use strict";t.exports=require("xlsx")}},e={};function n(a){var r=e[a];if(void 0!==r)return r.exports;var s=e[a]={exports:{}};return t[a](s,s.exports,n),s.exports}(()=>{const t=n(2127);n(334).config({path:"./.env.production"}),n(366),n(2470);const{handleError:e,ErrorHandler:a}=n(8005),r=n(4026),s=n(7211),i=(n(8605),n(479)),d=n(5747);console.log("./.env.production");const o=t();o.use(t.static("public")),o.use(t.static("upload")),seqnce=0,o.use(r.express),o.use((function(t,e,n){e.header("Access-Control-Allow-Origin","*"),e.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()})),o.use(i({origin:"*",optionsSuccessStatus:200})),o.use(t.json({limit:"50mb"})),o.use(t.urlencoded({extended:!1})),o.use("/api",n(2154)),o.use("/api/enquiry",n(8944)),o.use("/api/sale",n(4190)),o.use("/api/purchase",n(5568)),o.use("/api/auth",n(3220)),o.use("/api/admin",n(579)),o.use("/api/stock",n(9792)),o.use("/api/print",n(9303)),o.use("/api/accounts",n(7644)),o.use("/api/purchaseaccounts",n(4074)),o.use("/api/reports",n(7808)),o.use("/api/dashboard",n(9322)),o.use("/api/returns",n(2882)),o.use("/api/upload",n(1324)),o.use("/api/excel",n(578)),o.get("/openCV/:id/:filename",(function(t,e){var n=process.env.UPLOAD_PATH;e.sendFile(n+"/"+t.params.id+"/"+t.params.filename,{headers:{"Content-Type":"application/x-pdf"}})})),o.get("/error",((t,e)=>{throw new a(500,"Internal server error")})),o.use(((t,n,a)=>{e(t,a)}));var c={key:d.readFileSync(process.env.SSL_KEY),cert:d.readFileSync(process.env.SSL_CERT),ca:d.readFileSync(process.env.SSL_CHAIN)};s.createServer(c,o).listen(process.env.PORT)})()})();